<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment - QReserve Resort</title>
    <link rel="stylesheet" href="style.css"> 
</head>
<body>

    <header>
        <nav>
            <a href="index.html" class="nav-logo" aria-label="Tito Renz Resort">
                <img src="images/logo.png" alt="Tito Renz Resort Logo">
            </a>
            <ul></ul>
        </nav>
    </header>

    <main class="container has-fixed-header-offset">
        <!-- Page Hero Section -->
        <section class="page-hero-section" style="margin-bottom: 3rem;">
            <div class="hero-content">
                <h1>ðŸ’° Payment</h1>
                <p>Complete your reservation payment</p>
            </div>
        </section>

        <h2 style="text-align: center; max-width: 800px; margin: 0 auto 2rem;">Finalize Your Reservation Payment</h2>
        <p>Your booking details have been saved. Please complete the payment via <strong>GCash</strong> and provide your reference number and receipt for admin verification and approval.</p>
        
        <!-- Cart Items Display (for multi-item checkout) -->
        <div id="cart-items-section" style="margin-bottom: 2rem; display: none;">
            <h3>Items in Your Cart</h3>
            <div id="cart-items-for-payment" style="display: flex; flex-direction: column; gap: 0.75rem;"></div>
        </div>
        
        <form id="gcashPaymentForm">
            <!-- Reservation Summary Section -->
            <div class="payment-summary-section">
                <h3>Reservation Summary</h3>
                <div class="summary-row">
                    <span class="summary-label">Service:</span>
                    <span class="summary-value" id="serviceNameDisplay"></span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Customer Name:</span>
                    <span class="summary-value" id="summaryCustomerName"></span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Total Reservation Cost:</span>
                    <span class="summary-value">â‚±<span id="totalReservationCost">0.00</span></span>
                </div>
                <div class="summary-row total-row">
                    <span class="summary-label">Downpayment Required (50%):</span>
                    <span class="summary-value total-amount">â‚±<span id="paymentAmount">0.00</span></span>
                </div>
                <div class="summary-row" style="color: #6c757d; font-size: 0.9rem;">
                    <span class="summary-label">Remaining Balance:</span>
                    <span class="summary-value">â‚±<span id="remainingBalance">0.00</span></span>
                </div>
                <small style="display: block; margin-top: 0.5rem; color: #6c757d;">
                    <i>Note: You only need to pay 50% now. The remaining balance will be paid upon check-in.</i>
                </small>
            </div>
            
            <hr style="margin: 1.5rem 0; border: none; border-top: 2px solid #e9ecef;">
            
            <!-- QR Code Section -->
            <div class="qr-section">
                <h3>Scan to Pay with GCash</h3>
                <div class="qr-container">
                    <img src="images/QR.png" alt="GCash QR Code" class="qr-code" id="gcashQRCode">
                </div>
                <p class="qr-instruction">Use your GCash app to scan this QR code and send the payment.</p>
            </div>
            
            <hr style="margin: 1.5rem 0; border: none; border-top: 2px solid #e9ecef;">
            
            <!-- Reference Number Form Group -->
            <div class="form-group">
                <label for="gcashReferenceNumber">GCash Reference Number:</label>
                <input type="text" id="gcashReferenceNumber" placeholder="Enter 10-13 digit reference number" required>
                <small>Please pay the amount (â‚±<span id="paymentAmountSmall">0.00</span>) to our official GCash number before proceeding.</small>
            </div>

            <!-- Payment Receipt Image Upload -->
            <div class="form-group">
                <label for="gcashReceiptImage">Payment Receipt (Required):</label>
                <div class="receipt-upload-container" style="border: 2px dashed #ccc; border-radius: 8px; padding: 1.5rem; text-align: center; background: #f8f9fa;">
                    <input type="file" id="gcashReceiptImage" accept="image/*" style="display: none;">
                    <div id="receipt-upload-area" style="cursor: pointer; padding: 1rem;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">ðŸ“¸</div>
                        <p style="margin: 0 0 0.5rem 0; font-weight: 600;">Click to upload or drag and drop</p>
                        <p style="margin: 0; color: #999; font-size: 0.9rem;">PNG, JPG or GIF (max. 5MB)</p>
                    </div>
                    <div id="receipt-preview" style="margin-top: 1rem; display: none;">
                        <img id="receipt-preview-img" src="" alt="Receipt Preview" style="max-width: 100%; max-height: 300px; border-radius: 8px;">
                        <button type="button" id="remove-receipt-btn" style="margin-top: 0.5rem; padding: 0.5rem 1rem; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">Remove Image</button>
                    </div>
                </div>
                <small style="color: #999; display: block; margin-top: 0.5rem;">Upload a clear photo of your GCash payment receipt showing the reference number</small>
            </div>

            <!-- Payment Proof Validation Status -->
            <div id="payment-validation-status" style="display: none; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; font-weight: 600;">
                <span id="validation-message"></span>
            </div>

            <!-- Action Buttons -->
            <div class="button-group">
                <button type="submit" class="btn btn-primary" id="submit-payment-btn">Submit Payment & Confirm Booking</button>
                <a href="reserve.html" class="btn btn-secondary">Go Back to Reservation Details</a>
            </div>
        </form>
    </main>

    <script src="notifications.js"></script>
    <script src="script.js"></script>
    <script src="incomplete-reservation-tracker.js"></script>
    
    <script>
    // Merge all DOMContentLoaded logic into a single handler to fix syntax error
    document.addEventListener('DOMContentLoaded', function() {
        // Check if this is a cart checkout
        const checkoutCart = sessionStorage.getItem('checkoutCart');
        if (checkoutCart) {
            // Handle cart checkout
            const cartItemsSection = document.getElementById('cart-items-section');
            if (cartItemsSection) {
                cartItemsSection.style.display = 'block';
            }
            handleCartCheckout();
        } else {
            // Original single-item checkout flow
            // CRITICAL FIX: Recover from localStorage if sessionStorage is empty
            if (typeof recoverServiceDataFromStorage === 'function') {
                recoverServiceDataFromStorage();
            }
            // Get reservation data from sessionStorage (now recovered if needed)
            const serviceName = sessionStorage.getItem('selectedServiceName') || 
                               localStorage.getItem('selectedServiceName') || 'Service';
            const customerName = sessionStorage.getItem('customerName') || 
                                localStorage.getItem('customerName') || 'Guest';
            const finalTotal = sessionStorage.getItem('finalTotal') || 
                              localStorage.getItem('finalTotal') || '0.00';
            console.log('ðŸ’° Payment page data loaded:', { serviceName, customerName, finalTotal });
            // CRITICAL: Store reservation ID and hash in hidden data attributes or sessionStorage for form submission
            const urlParams = new URLSearchParams(window.location.search);
            const reservationIdFromUrl = urlParams.get('reservationId');
            const reservationHashFromUrl = urlParams.get('hash');
            // Use URL params if available, fallback to sessionStorage
            const finalReservationId = reservationIdFromUrl || sessionStorage.getItem('current_reservation_id');
            const finalReservationHash = reservationHashFromUrl || sessionStorage.getItem('current_reservation_hash');
            // Store in sessionStorage for access during form submission
            if (finalReservationId) {
                sessionStorage.setItem('payment_reservation_id', finalReservationId);
            }
            if (finalReservationHash) {
                sessionStorage.setItem('payment_reservation_hash', finalReservationHash);
            }
            console.log('Payment page loaded with reservation:', {
                reservationId: finalReservationId,
                reservationHash: finalReservationHash,
                serviceName,
                customerName,
                finalTotal
            });
            // Display service name
            const serviceDisplay = document.getElementById('serviceNameDisplay');
            if (serviceDisplay) {
                serviceDisplay.textContent = serviceName;
            }
            // Display customer name
            const customerDisplay = document.getElementById('summaryCustomerName');
            if (customerDisplay) {
                customerDisplay.textContent = customerName;
            }
            // Calculate downpayment amounts
            const totalAmount = parseFloat(finalTotal);
            const downpaymentAmount = typeof calculateDownpayment === 'function' 
                ? calculateDownpayment(totalAmount) 
                : totalAmount * 0.5; // 50% downpayment
            const remainingBalance = totalAmount - downpaymentAmount;
            // Display total reservation cost
            const totalCostEl = document.getElementById('totalReservationCost');
            if (totalCostEl) {
                totalCostEl.textContent = totalAmount.toFixed(2);
            }
            // Display downpayment amounts
            const paymentAmountElements = document.querySelectorAll('#paymentAmount, #paymentAmountSmall');
            paymentAmountElements.forEach(el => {
                el.textContent = downpaymentAmount.toFixed(2);
            });
            // Display remaining balance
            const remainingBalanceEl = document.getElementById('remainingBalance');
            if (remainingBalanceEl) {
                remainingBalanceEl.textContent = remainingBalance.toFixed(2);
            }
            console.log('Payment page loaded with data:', { 
                serviceName, 
                customerName, 
                totalAmount: totalAmount.toFixed(2),
                downpayment: downpaymentAmount.toFixed(2),
                remainingBalance: remainingBalance.toFixed(2)
            });
        }
        // PHASE 5: Auto-save payment page on load to capture that user reached payment page
        const pageLoadData = {
            selectedServiceId: sessionStorage.getItem('selectedServiceId') || '',
            selectedServiceName: sessionStorage.getItem('selectedServiceName') || document.getElementById('serviceNameDisplay')?.textContent || '',
            selectedServicePrice: sessionStorage.getItem('selectedServicePrice') || '',
            customerName: document.getElementById('summaryCustomerName')?.textContent || '',
            finalTotal: document.getElementById('paymentAmount')?.textContent || '',
            paymentPage: true,
            pageLoadAuto: true
        };
        if (typeof saveReservationProgress === 'function') {
            saveReservationProgress('payment', pageLoadData);
            console.log('Payment page auto-saved on load:', pageLoadData);
        }
        // Auto-save payment page data when reference number is entered
        const refInput = document.getElementById('gcashReferenceNumber');
        if (refInput) {
            let saveTimeout;
            refInput.addEventListener('input', function() {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(function() {
                    const data = {
                        selectedServiceId: sessionStorage.getItem('selectedServiceId') || '',
                        selectedServiceName: sessionStorage.getItem('selectedServiceName') || (document.getElementById('serviceNameDisplay') ? document.getElementById('serviceNameDisplay').textContent : ''),
                        selectedServicePrice: sessionStorage.getItem('selectedServicePrice') || '',
                        customerName: (document.getElementById('summaryCustomerName') ? document.getElementById('summaryCustomerName').textContent : ''),
                        finalTotal: (document.getElementById('paymentAmount') ? document.getElementById('paymentAmount').textContent : ''),
                        gcashReference: refInput.value || '',
                        paymentPage: true
                    };
                    saveReservationProgress('payment', data);
                    console.log('Payment page data auto-saved:', data);
                }, 1000);
            });
        }
        // GCash Receipt Image Upload Handler
        const receiptFileInput = document.getElementById('gcashReceiptImage');
        const receiptUploadArea = document.getElementById('receipt-upload-area');
        const receiptPreview = document.getElementById('receipt-preview');
        const receiptPreviewImg = document.getElementById('receipt-preview-img');
        const removeReceiptBtn = document.getElementById('remove-receipt-btn');
        const validationStatus = document.getElementById('payment-validation-status');
        const validationMessage = document.getElementById('validation-message');
        // Click to upload
        if (receiptUploadArea) {
            receiptUploadArea.addEventListener('click', function() {
                receiptFileInput.click();
            });
        }
        // Drag and drop
        if (receiptUploadArea) {
            receiptUploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                receiptUploadArea.style.backgroundColor = '#e9ecef';
            });
            receiptUploadArea.addEventListener('dragleave', function() {
                receiptUploadArea.style.backgroundColor = '#f8f9fa';
            });
            receiptUploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                receiptUploadArea.style.backgroundColor = '#f8f9fa';
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleReceiptFile(files[0]);
                }
            });
        }
        // File input change
        if (receiptFileInput) {
            receiptFileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleReceiptFile(e.target.files[0]);
                }
            });
        }
        // Handle receipt file selection
        function handleReceiptFile(file) {
            // Validate file type
            if (!file.type.startsWith('image/')) {
                showToast('Please upload an image file (PNG, JPG, GIF)', 'warning');
                return;
            }
            // Validate file size (5MB max)
            const maxSize = 5 * 1024 * 1024; // 5MB
            if (file.size > maxSize) {
                showToast('Image size must be less than 5MB', 'warning');
                return;
            }
            // Read file and display preview
            const reader = new FileReader();
            reader.onload = function(e) {
                receiptPreviewImg.src = e.target.result;
                receiptPreview.style.display = 'block';
                receiptUploadArea.style.display = 'none';
                // Store file in window for form submission
                window.gcashReceiptFile = file;
                window.gcashReceiptBase64 = e.target.result;
                console.log('Receipt image uploaded:', file.name);
            };
            reader.readAsDataURL(file);
        }
        // Remove receipt button
        if (removeReceiptBtn) {
            removeReceiptBtn.addEventListener('click', function() {
                receiptFileInput.value = '';
                receiptPreview.style.display = 'none';
                receiptUploadArea.style.display = 'block';
                window.gcashReceiptFile = null;
                window.gcashReceiptBase64 = null;
                validationStatus.style.display = 'none';
            });
        }
        // Validate GCash reference number format
        if (refInput) {
            refInput.addEventListener('change', function() {
                const refNumber = this.value.trim();
                // GCash references are typically 10-13 digits
                if (refNumber && !/^\d{10,13}$/.test(refNumber)) {
                    validationMessage.textContent = 'âš ï¸ Reference number should be 10-13 digits';
                    validationStatus.style.display = 'block';
                    validationStatus.style.backgroundColor = '#fff3cd';
                    validationStatus.style.color = '#856404';
                } else if (refNumber) {
                    validationMessage.textContent = 'âœ“ Reference number looks valid';
                    validationStatus.style.display = 'block';
                    validationStatus.style.backgroundColor = '#d4edda';
                    validationStatus.style.color = '#155724';
                } else {
                    validationStatus.style.display = 'none';
                }
            });
        }
        // Form submit handler: validate receipt image and send as FormData
        const paymentForm = document.getElementById('gcashPaymentForm');
        const submitBtn = document.getElementById('submit-payment-btn');
        if (paymentForm) {
            paymentForm.addEventListener('submit', function(e) {
                e.preventDefault();
                // Check if receipt image is uploaded
                if (!window.gcashReceiptFile) {
                    showToast('Please upload your GCash payment receipt before submitting.', 'warning');
                    if (receiptUploadArea) {
                        receiptUploadArea.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                    return false;
                }
                // Disable button and show loading
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Submitting...';
                }
                // Gather payment data
                const downpaymentAmount = document.getElementById('paymentAmount')?.textContent || '';
                const remainingBalance = document.getElementById('remainingBalance')?.textContent || '';
                const totalAmount = document.getElementById('totalReservationCost')?.textContent || '';
                const gcashReferenceNumber = document.getElementById('gcashReferenceNumber')?.value || '';
                const reservationHash = sessionStorage.getItem('payment_reservation_hash') || '';
                // Build FormData
                const formData = new FormData();
                formData.append('downpaymentAmount', downpaymentAmount);
                formData.append('remainingBalance', remainingBalance);
                formData.append('totalAmount', totalAmount);
                formData.append('gcashReferenceNumber', gcashReferenceNumber);
                formData.append('paymentType', 'downpayment');
                formData.append('reservationHash', reservationHash);
                formData.append('receiptImage', window.gcashReceiptFile);
                // Send to backend
                fetch('http://localhost:3000/api/payment/upload', {
                    method: 'POST',
                    body: formData
                })
                .then(async response => {
                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.error || 'Network error');
                    }
                    return response.json();
                })
                .then(data => {
                    showToast('âœ… Payment submitted successfully!', 'success');
                    // Optionally redirect or show confirmation
                    setTimeout(() => {
                        window.location.href = 'confirmation.html?hash=' + reservationHash;
                    }, 1500);
                })
                .catch(err => {
                    showToast('âŒ ' + err.message, 'error');
                })
                .finally(() => {
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Submit Payment & Confirm Booking';
                    }
                });
            });
        }
    });
    </script>
</body>
</html>
