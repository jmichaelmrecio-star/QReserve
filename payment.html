<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment - QReserve Resort</title>
    <link rel="stylesheet" href="style.css"> 
    <script src="unsaved-changes-modal.js"></script>
</head>
<body>

    <header>
        <nav>
            <a href="index.html" class="nav-logo" aria-label="Tito Renz Resort">
                <img src="images/logo.png" alt="Tito Renz Resort Logo">
            </a>
            <ul></ul>
            <div class="nav-right" id="navRight"></div>
        </nav>
    </header>

    <main class="container has-fixed-header-offset">
        <!-- Page Hero Section -->
        <section class="page-hero-section" style="margin-bottom: 3rem;">
            <div class="hero-content">
                <br><br>
                <h1>üí∞ Payment</h1>
                <p>Complete your reservation payment</p>
            </div>
        </section>

        <h2 style="text-align: center; max-width: 800px; margin: 0 auto 2rem;">Finalize Your Reservation Payment</h2>
        <p>Your booking details have been saved. Please complete the payment via <strong>GCash</strong> and provide your reference number and receipt for admin verification and approval.</p>
        
        <!-- Cart Items Display (for multi-item checkout) -->
        <div id="cart-items-section" style="margin-bottom: 2rem; display: none;">
            <h3>Items in Your Cart</h3>
            <div id="cart-items-for-payment" style="display: flex; flex-direction: column; gap: 0.75rem;"></div>
        </div>
        
        <form id="gcashPaymentForm">
            <!-- Reservation Summary Section -->
            <div class="payment-summary-section">
                <h3>Reservation Summary</h3>
                <div class="summary-row">
                    <span class="summary-label">Service:</span>
                    <span class="summary-value" id="serviceNameDisplay"></span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Customer Name:</span>
                    <span class="summary-value" id="summaryCustomerName"></span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Total Reservation Cost:</span>
                    <span class="summary-value">‚Ç±<span id="totalReservationCost">0.00</span></span>
                </div>
                <div class="summary-row total-row">
                    <span class="summary-label">Downpayment Required (50%):</span>
                    <span class="summary-value total-amount">‚Ç±<span id="paymentAmount">0.00</span></span>
                </div>
                <div class="summary-row" style="color: #6c757d; font-size: 0.9rem;">
                    <span class="summary-label">Remaining 50%:</span>
                    <span class="summary-value">‚Ç±<span id="remainingBalance">0.00</span></span>
                </div>
                <small style="display: block; margin-top: 0.5rem; color: #6c757d;">
                    <i>Note: You only need to pay 50% now. The remaining 50% will be paid upon check-in.</i>
                </small>
            </div>
            
            <hr style="margin: 1.5rem 0; border: none; border-top: 2px solid #e9ecef;">
            
            <!-- QR Code Section -->
            <div class="qr-section">
                <h3>Scan to Pay with GCash</h3>
                <div class="qr-container">
                    <img src="images/QR.png" alt="GCash QR Code" class="qr-code" id="gcashQRCode">
                </div>
                <p class="qr-instruction">Use your GCash app to scan this QR code and send the payment.</p>
            </div>
            
            <hr style="margin: 1.5rem 0; border: none; border-top: 2px solid #e9ecef;">
            
            <!-- Reference Number Form Group -->
            <div class="form-group">
                <label for="gcashReferenceNumber">GCash Reference Number:</label>
                <input type="text" id="gcashReferenceNumber" placeholder="Enter 13 digit reference number" minlength ="13" maxlength="13" required>
                <small>Please pay the amount (‚Ç±<span id="paymentAmountSmall">0.00</span>) to our official GCash number before proceeding.</small>
            </div>

            <!-- Payment Receipt Image Upload -->
            <div class="form-group">
                <label for="gcashReceiptImage">Payment Receipt (Required):</label>
                <div class="receipt-upload-container" style="border: 2px dashed #ccc; border-radius: 8px; padding: 1.5rem; text-align: center; background: #f8f9fa;">
                    <input type="file" id="gcashReceiptImage" accept="image/*" style="display: none;">
                    <div id="receipt-upload-area" style="cursor: pointer; padding: 1rem;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üì∏</div>
                        <p style="margin: 0 0 0.5rem 0; font-weight: 600;">Click to upload or drag and drop</p>
                        <p style="margin: 0; color: #999; font-size: 0.9rem;">PNG, JPG or GIF (max. 5MB)</p>
                    </div>
                    <div id="receipt-preview" style="margin-top: 1rem; display: none;">
                        <img id="receipt-preview-img" src="" alt="Receipt Preview" style="max-width: 100%; max-height: 300px; border-radius: 8px;">
                        <button type="button" id="remove-receipt-btn" style="margin-top: 0.5rem; padding: 0.5rem 1rem; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">Remove Image</button>
                    </div>
                </div>
                <small style="color: #999; display: block; margin-top: 0.5rem;">Upload a clear photo of your GCash payment receipt showing the reference number</small>
            </div>

            <!-- Payment Proof Validation Status -->
            <div id="payment-validation-status" style="display: none; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; font-weight: 600;">
                <span id="validation-message"></span>
            </div>

            <!-- Action Buttons -->
            <div class="button-group">
                <button type="submit" class="btn btn-primary" id="submit-payment-btn">Submit Payment for Verification</button>
                <!-- <a href="reserve.html" class="btn btn-secondary">Go Back to Reservation Details</a> -->
            </div>
        </form>
    </main>

    <script src="notifications.js"></script>
    <script src="ui-core.js"></script>
    <script src="auth-profile.js"></script>
    <script src="payment-system.js"></script>
    
    <script>
    // Payment form handler
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize unsaved changes tracking for payment page
        initializeUnsavedChangesTracking('gcashPaymentForm');
        attachNavigationListeners();
        
        const refInput = document.getElementById('gcashReferenceNumber');
        if (refInput) {
            let saveTimeout;
            refInput.addEventListener('input', function() {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(function() {
                    const data = {
                        selectedServiceId: sessionStorage.getItem('selectedServiceId') || '',
                        selectedServiceName: sessionStorage.getItem('selectedServiceName') || (document.getElementById('serviceNameDisplay') ? document.getElementById('serviceNameDisplay').textContent : ''),
                        selectedServicePrice: sessionStorage.getItem('selectedServicePrice') || '',
                        customerName: (document.getElementById('summaryCustomerName') ? document.getElementById('summaryCustomerName').textContent : ''),
                        finalTotal: (document.getElementById('paymentAmount') ? document.getElementById('paymentAmount').textContent : ''),
                        gcashReference: refInput.value || '',
                        paymentPage: true
                    };
                    // Data is now tracked by unsaved-changes-modal.js
                    markFormAsModified();
                }, 1000);
            });
        }
        // GCash Receipt Image Upload Handler
        const receiptFileInput = document.getElementById('gcashReceiptImage');
        const receiptUploadArea = document.getElementById('receipt-upload-area');
        const receiptPreview = document.getElementById('receipt-preview');
        const receiptPreviewImg = document.getElementById('receipt-preview-img');
        const removeReceiptBtn = document.getElementById('remove-receipt-btn');
        const validationStatus = document.getElementById('payment-validation-status');
        const validationMessage = document.getElementById('validation-message');
        // Click to upload
        if (receiptUploadArea) {
            receiptUploadArea.addEventListener('click', function() {
                receiptFileInput.click();
            });
        }
        // Drag and drop
        if (receiptUploadArea) {
            receiptUploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                receiptUploadArea.style.backgroundColor = '#e9ecef';
            });
            receiptUploadArea.addEventListener('dragleave', function() {
                receiptUploadArea.style.backgroundColor = '#f8f9fa';
            });
            receiptUploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                receiptUploadArea.style.backgroundColor = '#f8f9fa';
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleReceiptFile(files[0]);
                }
            });
        }
        // File input change
        if (receiptFileInput) {
            receiptFileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleReceiptFile(e.target.files[0]);
                }
            });
        }
        // Handle receipt file selection
        function handleReceiptFile(file) {
            // Validate file type
            if (!file.type.startsWith('image/')) {
                showToast('Please upload an image file (PNG, JPG, GIF)', 'warning');
                return;
            }
            // Validate file size (5MB max)
            const maxSize = 5 * 1024 * 1024; // 5MB
            if (file.size > maxSize) {
                showToast('Image size must be less than 5MB', 'warning');
                return;
            }
            // Read file and display preview
            const reader = new FileReader();
            reader.onload = function(e) {
                receiptPreviewImg.src = e.target.result;
                receiptPreview.style.display = 'block';
                receiptUploadArea.style.display = 'none';
                // Store file in window for form submission
                window.gcashReceiptFile = file;
                window.gcashReceiptBase64 = e.target.result;
                console.log('Receipt image uploaded:', file.name);
            };
            reader.readAsDataURL(file);
        }
        // Remove receipt button
        if (removeReceiptBtn) {
            removeReceiptBtn.addEventListener('click', function() {
                receiptFileInput.value = '';
                receiptPreview.style.display = 'none';
                receiptUploadArea.style.display = 'block';
                window.gcashReceiptFile = null;
                window.gcashReceiptBase64 = null;
                validationStatus.style.display = 'none';
            });
        }
        // Validate GCash reference number format
        if (refInput) {
            refInput.addEventListener('change', function() {
                const refNumber = this.value.trim();
                // GCash references are typically 10-13 digits
                if (refNumber && !/^\d{10,13}$/.test(refNumber)) {
                    validationMessage.textContent = '‚ö†Ô∏è Reference number should be 10-13 digits';
                    validationStatus.style.display = 'block';
                    validationStatus.style.backgroundColor = '#fff3cd';
                    validationStatus.style.color = '#856404';
                } else if (refNumber) {
                    validationMessage.textContent = '‚úì Reference number looks valid';
                    validationStatus.style.display = 'block';
                    validationStatus.style.backgroundColor = '#d4edda';
                    validationStatus.style.color = '#155724';
                } else {
                    validationStatus.style.display = 'none';
                }
            });
        }
        // Submission is handled by payment-system.js
    });
    </script>
</body>
</html>
