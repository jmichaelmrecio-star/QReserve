<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Payment - QReserve Resort</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <header>
      <nav>
        <a href="index.html" class="nav-logo" aria-label="Tito Renz Resort">
          <img src="images/logo.png" alt="Tito Renz Resort Logo" />
        </a>
        <ul></ul>
        <div class="nav-right" id="navRight"></div>
      </nav>
    </header>

    <main class="container has-fixed-header-offset">
      <!-- Page Hero Section -->
      <section class="page-hero-section" style="margin-bottom: 3rem">
        <div class="hero-content">
          <br /><br />
          <h1>üí∞ Payment</h1>
          <p>Complete your reservation payment</p>
        </div>
      </section>

      <h2 style="text-align: center; max-width: 800px; margin: 0 auto 2rem">
        Finalize Your Reservation Payment
      </h2>
      <p>
        Your booking details have been saved. Please complete the payment via
        <strong>GCash</strong> and provide your reference number and receipt for
        admin verification and approval.
      </p>

      <form id="gcashPaymentForm">
        <!-- Reservation Items Display -->
        <div
          id="reservation-items-section"
          class="payment-summary-section"
          style="display: none"
        >
          <h3>Items in this reservation</h3>
          <div
            id="reservation-items-for-payment"
            style="display: flex; flex-direction: column; gap: 0.75rem"
          ></div>
        </div>

        <!-- Reservation Summary Section -->
        <div class="payment-summary-section">
          <h3>Reservation Summary</h3>
          <div class="summary-row">
            <span class="summary-label">Reservation type:</span>
            <span class="summary-value" id="reservationTypeDisplay"></span>
          </div>
          <div class="summary-row" id="singleAmenityRow" style="display: none">
            <span class="summary-label">Amenity:</span>
            <span class="summary-value" id="singleAmenityDisplay"></span>
          </div>
          <div class="summary-row" id="amenitiesListRow" style="display: none">
            <span class="summary-label">Amenities:</span>
            <span class="summary-value" id="amenitiesListDisplay"></span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Customer Name:</span>
            <span class="summary-value" id="summaryCustomerName"></span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Total Reservation Cost:</span>
            <span class="summary-value"
              >‚Ç±<span id="totalReservationCost">0.00</span></span
            >
          </div>
          <div class="summary-row total-row">
            <span class="summary-label">Downpayment Required (50%):</span>
            <span class="summary-value total-amount"
              >‚Ç±<span id="paymentAmount">0.00</span></span
            >
          </div>
          <div class="summary-row" style="color: #6c757d; font-size: 0.9rem">
            <span class="summary-label">Remaining 50%:</span>
            <span class="summary-value"
              >‚Ç±<span id="remainingBalance">0.00</span></span
            >
          </div>
          <small style="display: block; margin-top: 0.5rem; color: #6c757d">
            <i
              >Note: You only need to pay 50% now. The remaining 50% will be
              paid upon check-in.</i
            >
          </small>
        </div>

        <hr
          style="margin: 1.5rem 0; border: none; border-top: 2px solid #e9ecef"
        />

        <!-- Payment Type Selection -->
        <div class="payment-summary-section">
          <h3>Choose Your Payment Option</h3>
          <div
            style="
              display: flex;
              flex-direction: column;
              gap: 1rem;
              margin-bottom: 1.5rem;
            "
          >
            <label
              style="
                display: flex;
                align-items: center;
                gap: 1rem;
                padding: 1rem;
                border: 2px solid #e9ecef;
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.3s ease;
              "
            >
              <input
                type="radio"
                name="paymentType"
                value="downpayment"
                checked
                style="width: 18px; height: 18px; cursor: pointer"
              />
              <div>
                <div style="font-weight: 600; font-size: 1rem">
                  Down Payment (50%)
                </div>
                <div style="color: #666; font-size: 0.9rem">
                  Pay ‚Ç±<span id="downpaymentAmount">0.00</span> now and the
                  remaining 50% upon check-in
                </div>
              </div>
            </label>
            <label
              style="
                display: flex;
                align-items: center;
                gap: 1rem;
                padding: 1rem;
                border: 2px solid #e9ecef;
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.3s ease;
              "
            >
              <input
                type="radio"
                name="paymentType"
                value="full"
                style="width: 18px; height: 18px; cursor: pointer"
              />
              <div>
                <div style="font-weight: 600; font-size: 1rem">
                  Full Payment (100%)
                </div>
                <div style="color: #666; font-size: 0.9rem">
                  Pay ‚Ç±<span id="fullpaymentAmount">0.00</span> now and be fully
                  done with payment
                </div>
              </div>
            </label>
          </div>
        </div>

        <hr
          style="margin: 1.5rem 0; border: none; border-top: 2px solid #e9ecef"
        />

        <!-- Amount to Pay Based on Selection -->
        <div class="payment-summary-section">
          <h3 style="margin-top: 0">Amount to Pay</h3>
          <div class="summary-row total-row" style="font-size: 1.3rem">
            <span class="summary-label">Total Due Now:</span>
            <span class="summary-value total-amount" style="font-size: 1.3rem"
              >‚Ç±<span id="amountToPay">0.00</span></span
            >
          </div>
        </div>

        <hr
          style="margin: 1.5rem 0; border: none; border-top: 2px solid #e9ecef"
        />

        <!-- QR Code Section -->
        <div class="qr-section">
          <h3>Scan to Pay with GCash</h3>
          <div class="qr-container">
            <img
              src="images/QR.png"
              alt="GCash QR Code"
              class="qr-code"
              id="gcashQRCode"
            />
          </div>
          <p class="qr-instruction">
            Use your GCash app to scan this QR code and send the payment.
          </p>
        </div>

        <hr
          style="margin: 1.5rem 0; border: none; border-top: 2px solid #e9ecef"
        />

        <!-- Reference Number Form Group -->
        <div class="form-group">
          <label for="gcashReferenceNumber">GCash Reference Number:</label>
          <input
            type="text"
            id="gcashReferenceNumber"
            placeholder="Enter 13 digit reference number"
            minlength="13"
            maxlength="13"
            pattern="\d{13}"
            inputmode="numeric"
            required
          />
          <small
            >Please pay the amount (‚Ç±<span id="paymentAmountSmall">0.00</span>)
            to our official GCash number before proceeding.</small
          >
        </div>

        <!-- Payment Receipt Image Upload -->
        <div class="form-group">
          <label for="gcashReceiptImage">Payment Receipt (Required):</label>
          <div
            class="receipt-upload-container"
            style="
              border: 2px dashed #ccc;
              border-radius: 8px;
              padding: 1.5rem;
              text-align: center;
              background: #f8f9fa;
            "
          >
            <input
              type="file"
              id="gcashReceiptImage"
              accept="image/*"
              style="display: none"
            />
            <div
              id="receipt-upload-area"
              style="cursor: pointer; padding: 1rem"
            >
              <div style="font-size: 2rem; margin-bottom: 0.5rem">üì∏</div>
              <p style="margin: 0 0 0.5rem 0; font-weight: 600">
                Click to upload or drag and drop
              </p>
              <p style="margin: 0; color: #999; font-size: 0.9rem">
                PNG, JPG or GIF (max. 5MB)
              </p>
            </div>
            <div
              id="receipt-preview"
              style="
                margin-top: 1rem;
                display: none;
                flex-direction: column;
                align-items: center;
                gap: 0.5rem;
              "
            >
              <img
                id="receipt-preview-img"
                src=""
                alt="Receipt Preview"
                style="max-width: 100%; max-height: 300px; border-radius: 8px"
              />
              <button
                type="button"
                id="remove-receipt-btn"
                style="
                  padding: 0.5rem 1rem;
                  background: #dc3545;
                  color: white;
                  border: none;
                  border-radius: 4px;
                  cursor: pointer;
                "
              >
                Remove Image
              </button>
            </div>
          </div>
          <small style="color: #999; display: block; margin-top: 0.5rem"
            >Upload a clear photo of your GCash payment receipt showing the
            reference number</small
          >
        </div>

        <!-- Action Buttons -->
        <div class="button-group">
          <button type="submit" class="btn btn-primary" id="submit-payment-btn">
            Submit Payment for Verification
          </button>
          <a
            href="my-reservations.html"
            class="btn btn-secondary"
            id="continuePaymentLaterBtn"
            >Continue Later</a
          >
        </div>
      </form>

      <!-- Payment Reminder Modal -->
      <div
        id="paymentReminderModal"
        style="
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.6);
          z-index: 9999;
          align-items: center;
          justify-content: center;
        "
      >
        <div
          style="
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
          "
        >
          <h2
            style="
              margin-top: 0;
              color: #2d8f5c;
              font-size: 1.4rem;
              margin-bottom: 1rem;
            "
          >
            ‚è∞ Pending Payment Reminder
          </h2>
          <p style="color: #4a5568; margin-bottom: 1.5rem; line-height: 1.6">
            You have a pending payment for your reservation. Your payment is
            still incomplete and awaiting submission.
          </p>
          <p style="color: #666; font-size: 0.95rem; margin-bottom: 2rem">
            Would you like to continue with the payment or leave this page for
            now?
          </p>
          <div style="display: flex; gap: 1rem; flex-wrap: wrap">
            <button
              id="cancelPaymentLeave"
              class="btn btn-primary"
              style="flex: 1; min-width: 150px"
            >
              Stay and Continue
            </button>
            <button
              id="confirmContinueLater"
              class="btn btn-secondary"
              style="flex: 1; min-width: 150px"
            >
              Continue Later
            </button>
          </div>
        </div>
      </div>
    </main>

    <script src="notifications.js"></script>
    <script src="ui-core.js"></script>
    <script src="auth-profile.js"></script>
    <script src="payment-system.js"></script>
    <script src="payment-reminder-modal.js"></script>

    <script>
      // Payment form handler
      document.addEventListener("DOMContentLoaded", function () {
        // Note: Payment page uses payment-reminder-modal.js instead of unsaved-changes-modal.js
        // No need to initialize unsaved changes tracking here

        // Payment Type Selection Handler
        function updatePaymentAmounts() {
          const totalCost = parseFloat(
            document
              .getElementById("totalReservationCost")
              ?.textContent?.replace(/,/g, "") || 0,
          );
          const downPaymentAmount = totalCost * 0.5;
          const fullPaymentAmount = totalCost;

          // Update the amount spans in the radio buttons
          const downpaymentAmountEl =
            document.getElementById("downpaymentAmount");
          const fullpaymentAmountEl =
            document.getElementById("fullpaymentAmount");
          const amountToPayEl = document.getElementById("amountToPay");
          const gcashReferenceSmallEl =
            document.getElementById("paymentAmountSmall");

          if (downpaymentAmountEl) {
            downpaymentAmountEl.textContent = downPaymentAmount.toLocaleString(
              undefined,
              { minimumFractionDigits: 2 },
            );
          }
          if (fullpaymentAmountEl) {
            fullpaymentAmountEl.textContent = fullPaymentAmount.toLocaleString(
              undefined,
              { minimumFractionDigits: 2 },
            );
          }

          // Get selected payment type
          const selectedPaymentType =
            document.querySelector('input[name="paymentType"]:checked')
              ?.value || "downpayment";
          const amountToPay =
            selectedPaymentType === "full"
              ? fullPaymentAmount
              : downPaymentAmount;

          if (amountToPayEl) {
            amountToPayEl.textContent = amountToPay.toLocaleString(undefined, {
              minimumFractionDigits: 2,
            });
          }
          if (gcashReferenceSmallEl) {
            gcashReferenceSmallEl.textContent = amountToPay.toLocaleString(
              undefined,
              { minimumFractionDigits: 2 },
            );
          }
        }

        // Add event listeners to payment type radio buttons
        const paymentTypeRadios = document.querySelectorAll(
          'input[name="paymentType"]',
        );
        paymentTypeRadios.forEach((radio) => {
          radio.addEventListener("change", function () {
            updatePaymentAmounts();
            console.log("Payment type selected:", this.value);
          });

          // Add visual feedback for selected option
          const label = radio.closest("label");
          if (label) {
            radio.addEventListener("change", function () {
              document
                .querySelectorAll('input[name="paymentType"]')
                .forEach((r) => {
                  const l = r.closest("label");
                  if (l) {
                    l.style.borderColor = r.checked ? "#28a745" : "#e9ecef";
                    l.style.backgroundColor = r.checked
                      ? "#f0f8f5"
                      : "transparent";
                  }
                });
            });
          }
        });

        // Set initial styling for default selected option
        document
          .querySelectorAll('input[name="paymentType"]')
          .forEach((radio) => {
            const label = radio.closest("label");
            if (label && radio.checked) {
              label.style.borderColor = "#28a745";
              label.style.backgroundColor = "#f0f8f5";
            }
          });

        // Initialize payment amounts after page loads (wait for payment-system.js to populate totals)
        setTimeout(() => {
          updatePaymentAmounts();
        }, 100);

        const refInput = document.getElementById("gcashReferenceNumber");
        if (refInput) {
          let saveTimeout;
          refInput.addEventListener("input", function () {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(function () {
              const data = {
                selectedServiceId:
                  sessionStorage.getItem("selectedServiceId") || "",
                selectedServiceName:
                  sessionStorage.getItem("selectedServiceName") ||
                  (document.getElementById("serviceNameDisplay")
                    ? document.getElementById("serviceNameDisplay").textContent
                    : ""),
                selectedServicePrice:
                  sessionStorage.getItem("selectedServicePrice") || "",
                customerName: document.getElementById("summaryCustomerName")
                  ? document.getElementById("summaryCustomerName").textContent
                  : "",
                finalTotal: document.getElementById("paymentAmount")
                  ? document.getElementById("paymentAmount").textContent
                  : "",
                gcashReference: refInput.value || "",
                paymentPage: true,
              };
              // Data is now tracked by payment-reminder-modal.js
            }, 1000);
          });
        }
        // GCash Receipt Image Upload Handler
        const receiptFileInput = document.getElementById("gcashReceiptImage");
        const receiptUploadArea = document.getElementById(
          "receipt-upload-area",
        );
        const receiptPreview = document.getElementById("receipt-preview");
        const receiptPreviewImg = document.getElementById(
          "receipt-preview-img",
        );
        const removeReceiptBtn = document.getElementById("remove-receipt-btn");
        // Click to upload
        if (receiptUploadArea) {
          receiptUploadArea.addEventListener("click", function () {
            receiptFileInput.click();
          });
        }
        // Drag and drop
        if (receiptUploadArea) {
          receiptUploadArea.addEventListener("dragover", function (e) {
            e.preventDefault();
            receiptUploadArea.style.backgroundColor = "#e9ecef";
          });
          receiptUploadArea.addEventListener("dragleave", function () {
            receiptUploadArea.style.backgroundColor = "#f8f9fa";
          });
          receiptUploadArea.addEventListener("drop", function (e) {
            e.preventDefault();
            receiptUploadArea.style.backgroundColor = "#f8f9fa";
            const files = e.dataTransfer.files;
            if (files.length > 0) {
              handleReceiptFile(files[0]);
            }
          });
        }
        // File input change
        if (receiptFileInput) {
          receiptFileInput.addEventListener("change", function (e) {
            if (e.target.files.length > 0) {
              handleReceiptFile(e.target.files[0]);
            }
          });
        }
        // Handle receipt file selection
        function handleReceiptFile(file) {
          // Validate file type
          if (!file.type.startsWith("image/")) {
            showToast("Please upload an image file (PNG, JPG, GIF)", "warning");
            return;
          }
          // Validate file size (5MB max)
          const maxSize = 5 * 1024 * 1024; // 5MB
          if (file.size > maxSize) {
            showToast("Image size must be less than 5MB", "warning");
            return;
          }
          // Read file and display preview
          const reader = new FileReader();
          reader.onload = function (e) {
            receiptPreviewImg.src = e.target.result;
            receiptPreview.style.display = "flex";
            receiptUploadArea.style.display = "none";
            // Store file in window for form submission
            window.gcashReceiptFile = file;
            window.gcashReceiptBase64 = e.target.result;
            console.log("Receipt image uploaded:", file.name);
          };
          reader.readAsDataURL(file);
        }
        // Remove receipt button
        if (removeReceiptBtn) {
          removeReceiptBtn.addEventListener("click", function () {
            receiptFileInput.value = "";
            receiptPreview.style.display = "none";
            receiptUploadArea.style.display = "block";
            window.gcashReceiptFile = null;
            window.gcashReceiptBase64 = null;
          });
        }
        // Validate GCash reference number format
        if (refInput) {
          // Real-time validation: strip non-numeric characters as user types
          refInput.addEventListener("input", function () {
            // Remove any non-digit characters
            this.value = this.value.replace(/\D/g, "");
          });
        }
        // Submission is handled by payment-system.js
      });
    </script>
  </body>
</html>
