<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>Tito Renz Norzagaray Resort</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <header>
      <nav>
        <a href="index.html" class="nav-logo" aria-label="Tito Renz Resort">
          <img src="images/logo.png" alt="Tito Renz Resort Logo" />
        </a>
        <ul>
          <li><a href="index.html" class="active">Home</a></li>
          <li><a href="help.html">Help</a></li>
        </ul>
        <div class="nav-right" id="navRight"></div>
      </nav>
    </header>

    <main>
      <section id="hero-new">
        <div class="hero-content-wrapper">
          <h1>Tito Renz Norzagaray Resort</h1>
          <p class="tagline">Norzagaray's Best All In 1 Place</p>
          <a href="services-list.html" class="button-secondary" onclick="window.location.href='services-list.html'; return false;">Book Now</a>
        </div>
      </section>

      <section id="featured-amenities" class="hero-parallax">
        <div class="hero-content-wrapper">
          <h2>What We Offer at Tito Renz Resort</h2>

          <!-- Main Section Navigation -->
          <div class="amenities-section-nav">
            <button class="amenities-section-btn active" data-section="rooms">
              Rooms
            </button>
            <button class="amenities-section-btn" data-section="events">
              Events Place
            </button>
            <button class="amenities-section-btn" data-section="pool">
              Pool Area
            </button>
          </div>

          <!-- Carousel Container -->
          <div class="amenities-carousel-wrapper">
            <!-- Rooms Section Carousel -->
            <div class="amenities-carousel active" data-section="rooms">
              <button class="carousel-nav-btn prev">‚Äπ</button>
              <div class="carousel-slides">
                <div class="carousel-slide active">
                  <div
                    class="slide-image"
                    style="
                      background: url('images/Villa_room.jpg') center/cover
                        no-repeat;
                    "
                  ></div>
                  <h4 class="carousel-service-link" data-service-type="villa">Villa</h4>
                  <p class="carousel-pax-info">Good for 6-8 pax</p>
                  <p>
                    Spacious villa accommodations with premium amenities and
                    privacy.
                  </p>
                </div>
                <div class="carousel-slide">
                  <div
                    class="slide-image"
                    style="
                      background: url('images/Charm_room_1.jpg') center/cover
                        no-repeat;
                    "
                  ></div>
                  <h4 class="carousel-service-link" data-service-type="charm">Charm</h4>
                  <p class="carousel-pax-info">Good for 4-8 pax</p>
                  <p>
                    Cozy and intimate rooms with all the comfort and character
                    you need.
                  </p>
                </div>
                <div class="carousel-slide">
                  <div
                    class="slide-image"
                    style="
                      background: url('images/home-room.jpg') center/cover
                        no-repeat;
                    "
                  ></div>
                  <h4 class="carousel-service-link" data-service-type="home">Home</h4>
                  <p class="carousel-pax-info">Good for 2 pax</p>
                  <p>
                    Full home experience with kitchen facilities and spacious
                    living areas.
                  </p>
                </div>
              </div>
              <button class="carousel-nav-btn next">‚Ä∫</button>
            </div>

            <!-- Events Place Section Carousel -->
            <div class="amenities-carousel" data-section="events">
              <button class="carousel-nav-btn prev">‚Äπ</button>
              <div class="carousel-slides">
                <div class="carousel-slide active">
                  <div
                    class="slide-image"
                    style="
                      background: url('images/Cloverleaf_Hall.jpg') center/cover
                        no-repeat;
                    "
                  ></div>
                  <h4 class="carousel-service-link" data-service-type="hall">Clover Leaf Hall</h4>
                  <p class="carousel-pax-info">Good for 100+ pax</p>
                  <p>
                    Large multi-purpose venue perfect for conferences, weddings,
                    and grand celebrations.
                  </p>
                </div>
                <div class="carousel-slide">
                  <div
                    class="slide-image"
                    style="
                      background: url('images/2nd_Floor_Resto_Hall.jpg')
                        center/cover no-repeat;
                    "
                  ></div>
                  <h4 class="carousel-service-link" data-service-type="hall">Resto Hall</h4>
                  <p class="carousel-pax-info">Good for 50-80 pax</p>
                  <p>
                    Intimate dining space ideal for family gatherings, corporate
                    lunches, and small events.
                  </p>
                </div>
              </div>
              <button class="carousel-nav-btn next">‚Ä∫</button>
            </div>

            <!-- Pool Area Section Carousel -->
            <div class="amenities-carousel" data-section="pool">
              <button class="carousel-nav-btn prev">‚Äπ</button>
              <div class="carousel-slides">
                <div class="carousel-slide active">
                  <div
                    class="slide-image"
                    style="
                      background: url('images/Pool_Area.jpg') center/cover
                        no-repeat;
                    "
                  ></div>
                  <h4 class="carousel-service-link" data-service-type="pool">Private Pool</h4>
                  <p class="carousel-pax-info">Good for 70 pax</p>
                  <p>
                    Olympic-sized main pool with diving areas and relaxing
                    shallow zones.
                  </p>
                </div>
                <div class="carousel-slide">
                  <div
                    class="slide-image"
                    style="
                      background: url('images/Pool_Area_other_View_2.jpg')
                        center/cover no-repeat;
                    "
                  ></div>
                  <h4 class="carousel-service-link" data-service-type="pool">Pool Pavilions</h4>
                  <p class="carousel-pax-info">Good for 70 pax</p>
                  <p>
                    Exclusive cottages poolside with direct pool access and
                    private lounging areas.
                  </p>
                </div>
              </div>
              <button class="carousel-nav-btn next">‚Ä∫</button>
            </div>
          </div>

          <a href="services-list.html" class="button-secondary browse-amenities-btn" onclick="window.location.href='services-list.html'; return false;">
            Browse Amenities
          </a>

        </div>
      </section>

      <section
        id="promotions-blocks"
        class="container"
        style="
          display: none;
          margin-top: 2rem;
          background-color: #f5f4f1;
          padding: 20px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
        "
      >
        <h2>Active Promotions</h2>
        <div id="active-promotions-list">
          <p>Loading promotions...</p>
        </div>

        <hr style="margin: 1.5rem 0" />

        <h2>Currently Blocked Dates</h2>
        <div id="public-blocked-dates">
          <p>Loading blocked dates...</p>
        </div>

      </section>

      <!-- What Our Customers Say Carousel -->
      <section id="availability-calendar-section" style="background: #f8f9fa; padding: 2.5rem 0 0 0; margin-top: 0;">
        <div class="container" style="max-width: 1100px; margin: 0 auto;">
          <h2 style="margin-bottom: 1rem; color: var(--primary-color, #28a745); font-size: 2.5rem; text-align: center;">Availability Calendar</h2>
          <p style="text-align: center; color: #666; margin-bottom: 2rem;">Check available dates for your stay</p>
          
          <div style="display: flex; justify-content: center; gap: 2rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <div style="width: 20px; height: 20px; background: #e8f5e9; border: 1px solid #2d8f5c; border-radius: 4px;"></div>
              <span style="color: #4a5568;">Available</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <div style="width: 20px; height: 20px; background: #ffebee; border: 1px solid #d97757; border-radius: 4px;"></div>
              <span style="color: #4a5568;">Fully Booked</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <div style="width: 20px; height: 20px; background: #fff3e0; border: 1px solid #f59e0b; border-radius: 4px;"></div>
              <span style="color: #4a5568;">Partially Booked</span>
            </div>
          </div>

          <div id="calendar-container" style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.08);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
              <button id="prev-month" style="padding: 0.5rem 1rem; background: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem;">‚Üê Previous</button>
              <h3 id="calendar-month-year" style="color: var(--text-color); font-size: 1.5rem; margin: 0;"></h3>
              <button id="next-month" style="padding: 0.5rem 1rem; background: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem;">Next ‚Üí</button>
            </div>
            <div id="calendar-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem;">
              <!-- Calendar will be populated by JavaScript -->
            </div>
            <div
              id="calendar-details"
              style="
                display: none;
                margin-top: 1.5rem;
                padding: 1rem;
                border: 1px solid #e2e8f0;
                border-radius: 10px;
                background: #f8fafc;
              "
            >
              <div
                id="calendar-details-title"
                style="font-weight: 700; color: #2d3748; margin-bottom: 0.75rem;"
              ></div>
              <div id="calendar-details-body"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- <section id="services">
        <h2>What We Offer at Tito Renz Resort</h2>
        <div class="service-cards">
          <div class="card">
            <h3>Standard Rooms</h3>
            <p>
              Comfortable and modern air-conditioned rooms perfect for
              individuals or couples. Enjoy a restful stay with all essential
              amenities.
            </p>
            <p class="price">Starts at P2,500</p>
          </div>
          <div class="card">
            <h3>Family Cottages</h3>
            <p>
              Spacious, private cottages ideal for family gatherings or larger
              groups. Includes a dedicated dining area and dedicated grill area.
            </p>
            <p class="price">Starts at P4,000</p>
          </div>
          <div class="card">
            <h3>Pool Area Rental</h3>
            <p>
            Browse Amenities >
              building, or other special events. Perfect for large groups.
            </p>
            <p class="price">Starts at P8,000</p>
          </div>
        </div>
      </section> -->
    </main>

    <footer></footer>

    <script src="notifications.js"></script>
    <script src="ui-core.js"></script>
    <script src="auth-profile.js"></script>
    <script src="mobile-responsive.js"></script>

    <script>
    // Redirect admin/manager users to their dashboard
    (function redirectAdminUsers() {
        const userRole = sessionStorage.getItem('qreserve_user_role');
        if (userRole === 'admin' || userRole === 'manager') {
            const dashboardPage = userRole === 'admin' ? '/admin/admin-dashboard.html' : '/manager/manager-dashboard.html';
            window.location.href = dashboardPage;
        }
    })();

    // Cached map of service IDs to names for blocked-date display
    let serviceNameMap = null;
    async function getServiceNameMap() {
      if (serviceNameMap) return serviceNameMap;
      try {
        const res = await fetch('http://localhost:3000/api/services');
        const data = await res.json();
        const services = Array.isArray(data)
          ? data
          : (data.success && Array.isArray(data.services))
            ? data.services
            : [];
        const map = {};
        services.forEach(svc => {
          const id = svc._id || svc.id;
          const name = svc.name || svc.serviceName || svc.title || svc.serviceType || 'Service';
          if (id) map[id] = name;
        });
        serviceNameMap = map;
      } catch (_e) {
        serviceNameMap = {};
      }
      return serviceNameMap;
    }

    // --- Fetch and Render Promotions & Blocked Dates ---
    async function fetchAndRenderPromotions() {
      const container = document.getElementById('active-promotions-list');
      if (!container) return;
      try {
        // Use the public active promo list (non-expired, under usage limit)
        const res = await fetch('http://localhost:3000/api/promocodes/active/list');
        const data = await res.json();
        const promos = Array.isArray(data)
          ? data
          : (data.success && Array.isArray(data.promos))
            ? data.promos
            : [];

        if (!promos.length) {
          container.innerHTML = '<p>No active promotions at this time.</p>';
          return;
        }

        container.innerHTML = promos.map(promo => {
          const discountPct = promo.discountPercentage ? Math.round(promo.discountPercentage * 100) : 0;
          const expiresRaw = promo.expirationDate || promo.expiryDate;
          const expires = window.formatDate ? window.formatDate(expiresRaw) : expiresRaw;
          const usageLeft = (typeof promo.usageLimit === 'number' && typeof promo.timesUsed === 'number')
            ? Math.max(promo.usageLimit - promo.timesUsed, 0)
            : null;
          const usageLine = promo.usageLimit
            ? `${usageLeft !== null ? usageLeft : promo.usageLimit} use(s) left of ${promo.usageLimit}`
            : '';
          const minPurchaseLine = promo.minPurchaseAmount
            ? `Min purchase: ‚Ç±${parseFloat(promo.minPurchaseAmount).toLocaleString()}`
            : '';
          return `
            <div class="promo-block" style="margin-bottom: 1rem; padding: 10px; border-radius: 6px; background: #f7f7f7; box-shadow: 0 2px 8px #0001;">
              <div><strong style="color: var(--primary-color, #1f7ed0);">${promo.code}</strong> ‚Äî ${discountPct}% off</div>
              <div style="color: #555; font-size: 0.95em;">Valid until: ${expires || 'N/A'}</div>
              ${usageLine ? `<div style="color:#666; font-size: 0.9em;">${usageLine}</div>` : ''}
              ${minPurchaseLine ? `<div style="color:#666; font-size: 0.9em;">${minPurchaseLine}</div>` : ''}
              ${promo.description ? `<div style="margin-top:4px; color:#555; font-size:0.95em;">${promo.description}</div>` : ''}
            </div>
          `;
        }).join('');
      } catch (e) {
        container.innerHTML = '<p style="color: #c00;">Failed to load promotions.</p>';
      }
    }

    async function fetchAndRenderBlockedDates() {
      const container = document.getElementById('public-blocked-dates');
      if (!container) return;
      try {
        const serviceMap = await getServiceNameMap();
        const res = await fetch('http://localhost:3000/api/blocked-dates/active/list');
        const data = await res.json();
        const blocks = Array.isArray(data)
          ? data
          : (data.success && Array.isArray(data.blockedDates))
            ? data.blockedDates
            : (data.success && Array.isArray(data.blocks))
              ? data.blocks
              : [];

        if (!blocks.length) {
          container.innerHTML = '<p>No blocked dates at this time.</p>';
          return;
        }

        container.innerHTML = '<ul style="padding-left: 1.2em;">' + blocks.map(block => {
          const start = window.formatDate ? window.formatDate(block.startDate) : block.startDate;
          const end = window.formatDate ? window.formatDate(block.endDate) : block.endDate;
          const servicesText = (block.appliesToAllServices !== false && (!block.serviceIds || block.serviceIds.length === 0))
            ? 'All services'
            : (Array.isArray(block.serviceIds) && block.serviceIds.length > 0)
              ? block.serviceIds.map(id => serviceMap[id] || id).join(', ')
              : 'All services';
          const reasonText = block.reason ? ` ‚Äî ${block.reason}` : '';
          return `<li><strong>${start}</strong> to <strong>${end}</strong>${reasonText}<div style="color:#555; font-size:0.9em;">Services: ${servicesText}</div></li>`;
        }).join('') + '</ul>';
      } catch (e) {
        container.innerHTML = '<p style="color: #c00;">Failed to load blocked dates.</p>';
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      fetchAndRenderPromotions();
      fetchAndRenderBlockedDates();

      // Make carousel titles clickable to jump to filtered services
      document.querySelectorAll('.carousel-service-link[data-service-type]').forEach((el) => {
        const serviceType = el.getAttribute('data-service-type');
        el.style.cursor = 'pointer';
        el.setAttribute('role', 'link');
        el.setAttribute('tabindex', '0');
        el.addEventListener('click', () => {
          window.location.href = `services-list.html?type=${encodeURIComponent(serviceType)}`;
        });
        el.addEventListener('keydown', (event) => {
          if (event.key === 'Enter' || event.key === ' ') {
            event.preventDefault();
            window.location.href = `services-list.html?type=${encodeURIComponent(serviceType)}`;
          }
        });
      });

      // Availability Calendar Logic
      const calendarToday = new Date();
      let viewMonthIndex = calendarToday.getMonth();
      let viewYear = calendarToday.getFullYear();
      let currentMonth = viewMonthIndex;
      let currentYear = viewYear;
      let lastNavAt = 0;
      let blockedDatesData = [];
      let blockedDatesByDate = {}; // Store full blocked date details
      let reservationDatesData = [];
      let reservationsByDate = {}; // Store full reservation details by date
      let selectedCalendarCell = null;

      async function fetchBlockedDatesForCalendar() {
        try {
          // Fetch blocked dates
          const blockedResponse = await fetch('http://localhost:3000/api/blocked-dates');
          const blockedData = await blockedResponse.json();
          
          // Store blocked dates and their details
          blockedDatesData = [];
          blockedDatesByDate = {};
          
          (blockedData.blockedDates || []).forEach(blockedDate => {
            const startDate = new Date(blockedDate.startDate);
            const endDate = new Date(blockedDate.endDate);
            
            // Add all dates in the blocked range
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
              const dateStr = new Date(d).toDateString();
              if (!blockedDatesData.includes(dateStr)) {
                blockedDatesData.push(dateStr);
              }
              
              // Store blocked date details
              if (!blockedDatesByDate[dateStr]) {
                blockedDatesByDate[dateStr] = [];
              }
              
              blockedDatesByDate[dateStr].push({
                reason: blockedDate.reason || 'Fully Booked',
                startDate: startDate,
                endDate: endDate,
                appliesToAllServices: blockedDate.appliesToAllServices
              });
            }
          });
          
          // Fetch all reservations to check which dates have bookings
          const reservationsResponse = await fetch('http://localhost:3000/api/reservations/allreservation');
          const reservationsData = await reservationsResponse.json();
          
          // Extract all dates that have reservations and store details
          reservationDatesData = [];
          reservationsByDate = {};
          
          if (reservationsData.success && reservationsData.reservations) {
            reservationsData.reservations.forEach(reservation => {
              // Only include confirmed and pending reservations, not cancelled
              if (reservation.status !== 'cancelled' && reservation.status !== 'rejected') {
                const checkInRaw = reservation.check_in || reservation.check_in_date;
                const checkOutRaw = reservation.check_out || reservation.check_out_date;
                if (!checkInRaw || !checkOutRaw) {
                  return;
                }

                const checkIn = new Date(checkInRaw);
                const checkOut = new Date(checkOutRaw);
                if (Number.isNaN(checkIn.getTime()) || Number.isNaN(checkOut.getTime())) {
                  return;
                }
                
                // Calculate duration
                const durationMs = checkOut - checkIn;
                const durationDays = Math.ceil(durationMs / (1000 * 60 * 60 * 24));
                const durationHours = Math.ceil(durationMs / (1000 * 60 * 60));
                
                // Add all dates in the range with full details
                for (let d = new Date(checkIn); d <= checkOut; d.setDate(d.getDate() + 1)) {
                  const dateStr = new Date(d).toDateString();
                  if (!reservationDatesData.includes(dateStr)) {
                    reservationDatesData.push(dateStr);
                  }
                  
                  // Store reservation details
                  if (!reservationsByDate[dateStr]) {
                    reservationsByDate[dateStr] = [];
                  }
                  
                  reservationsByDate[dateStr].push({
                    amenity: reservation.serviceName || 'Service',
                    checkIn: checkIn,
                    checkOut: checkOut,
                    duration: durationDays >= 1 ? `${durationDays} day(s)` : `${durationHours} hour(s)`,
                    status: reservation.status,
                    reservationId: reservation.reservationId
                  });
                }
              }
            });
          }
          
          renderCalendar();
        } catch (error) {
          console.error('Error fetching calendar data:', error);
          renderCalendar();
        }
      }

      function formatDateTime(date) {
        const options = { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' };
        return date.toLocaleString('en-US', options);
      }

      function formatShortDateTime(date) {
        const options = { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
        return date.toLocaleString('en-US', options);
      }

      function safeFormatShortDateTime(value) {
        const date = value instanceof Date ? value : new Date(value);
        if (Number.isNaN(date.getTime())) return 'n/a';
        return formatShortDateTime(date);
      }

      function escapeHtml(value) {
        return String(value)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      function buildCellDetails(reservations, blockedDates) {
        let html = '';
        const maxItems = 2;

        if (blockedDates && blockedDates.length > 0) {
          const block = blockedDates[0];
          html += `
            <div style="margin-top: 0.35rem; font-size: 0.7rem; line-height: 1.2; text-align: left;">
              <div style="font-weight: 700; color: #c62828;">Blocked</div>
              <div>${escapeHtml(block.reason || 'Fully Booked')}</div>
            </div>
          `;
        }

        if (reservations && reservations.length > 0) {
          const uniqueReservations = [];
          const seenIds = new Set();
          reservations.forEach(res => {
            if (!seenIds.has(res.reservationId)) {
              seenIds.add(res.reservationId);
              uniqueReservations.push(res);
            }
          });

          uniqueReservations.slice(0, maxItems).forEach(res => {
            html += `
              <div style="margin-top: 0.35rem; font-size: 0.7rem; line-height: 1.2; text-align: left;">
                <div style="font-weight: 700; color: #333;">${escapeHtml(res.amenity)}</div>
                <div>Check-in: ${escapeHtml(safeFormatShortDateTime(res.checkIn))}</div>
                <div>Check-out: ${escapeHtml(safeFormatShortDateTime(res.checkOut))}</div>
                <div>Stay: ${escapeHtml(res.duration)}</div>
              </div>
            `;
          });

          if (uniqueReservations.length > maxItems) {
            const remaining = uniqueReservations.length - maxItems;
            html += `<div style="margin-top: 0.25rem; font-size: 0.7rem; color: #555;">+${remaining} more</div>`;
          }
        }

        return html;
      }

      function buildDetailsPanelHtml(reservations, blockedDates) {
        let html = '';

        if (blockedDates && blockedDates.length > 0) {
          html += '<div style="font-weight: 700; margin-bottom: 0.5rem; color: #c62828;">Blocked Dates</div>';

          const uniqueBlocks = [];
          const seenReasons = new Set();
          blockedDates.forEach(block => {
            const reason = block.reason || 'Fully Booked';
            if (!seenReasons.has(reason)) {
              seenReasons.add(reason);
              uniqueBlocks.push(block);
            }
          });

          uniqueBlocks.forEach((block, idx) => {
            if (idx > 0) html += '<div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #e2e8f0;"></div>';
            html += `
              <div>
                <div style="font-weight: 600; color: #c62828;">${escapeHtml(block.reason || 'Fully Booked')}</div>
                <div style="color: #555; font-size: 0.85rem; margin-top: 0.25rem;">
                  <div>From: ${escapeHtml(formatDateTime(block.startDate))}</div>
                  <div>Until: ${escapeHtml(formatDateTime(block.endDate))}</div>
                  ${block.appliesToAllServices ? '<div style="color: #c62828; font-weight: 600;">Entire resort blocked</div>' : ''}
                </div>
              </div>
            `;
          });
        }

        if (reservations && reservations.length > 0) {
          if (html) html += '<div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 2px solid #e2e8f0;"></div>';
          html += '<div style="font-weight: 700; margin-bottom: 0.5rem; color: var(--primary-color);">Bookings</div>';

          const uniqueReservations = [];
          const seenIds = new Set();
          reservations.forEach(res => {
            if (!seenIds.has(res.reservationId)) {
              seenIds.add(res.reservationId);
              uniqueReservations.push(res);
            }
          });

          uniqueReservations.forEach((res, idx) => {
            if (idx > 0) html += '<div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #e2e8f0;"></div>';
            html += `
              <div>
                <div style="font-weight: 600; color: #333;">${escapeHtml(res.amenity)}</div>
                <div style="color: #555; font-size: 0.85rem; margin-top: 0.25rem;">
                  <div>Check-in: ${escapeHtml(formatDateTime(res.checkIn))}</div>
                  <div>Check-out: ${escapeHtml(formatDateTime(res.checkOut))}</div>
                  <div>Duration: ${escapeHtml(res.duration)}</div>
                  <div>ID: ${escapeHtml(res.reservationId)}</div>
                </div>
              </div>
            `;
          });
        }

        if (!html) {
          html = '<div style="color: #666;">No bookings or blocks for this date.</div>';
        }

        return html;
      }

      function showCalendarDetails(date, reservations, blockedDates) {
        const detailsEl = document.getElementById('calendar-details');
        const titleEl = document.getElementById('calendar-details-title');
        const bodyEl = document.getElementById('calendar-details-body');

        if (!detailsEl || !titleEl || !bodyEl) return;

        titleEl.textContent = `Details for ${date.toDateString()}`;
        bodyEl.innerHTML = buildDetailsPanelHtml(reservations, blockedDates);
        detailsEl.style.display = 'block';
      }

      function createTooltip(reservations, blockedDates) {
        const tooltip = document.createElement('div');
        tooltip.style.cssText = `
          position: absolute;
          background: white;
          border: 2px solid var(--primary-color);
          border-radius: 8px;
          padding: 0.75rem;
          box-shadow: 0 4px 12px rgba(0,0,0,0.2);
          z-index: 1000;
          min-width: 250px;
          max-width: 350px;
          pointer-events: none;
          font-size: 0.85rem;
          line-height: 1.4;
        `;
        
        let html = '';
        
        // Show blocked date information if present
        if (blockedDates && blockedDates.length > 0) {
          html += '<div style="font-weight: bold; margin-bottom: 0.5rem; color: #c62828; border-bottom: 1px solid #ddd; padding-bottom: 0.25rem;">üîí Fully Booked</div>';
          
          const uniqueBlocks = [];
          const seenReasons = new Set();
          blockedDates.forEach(block => {
            if (!seenReasons.has(block.reason)) {
              seenReasons.add(block.reason);
              uniqueBlocks.push(block);
            }
          });
          
          uniqueBlocks.forEach((block, idx) => {
            if (idx > 0) html += '<div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #eee;"></div>';
            html += `
              <div>
                <div style="font-weight: 600; color: #c62828;">${block.reason}</div>
                <div style="color: #666; font-size: 0.8rem; margin-top: 0.2rem;">
                  <div>üìÖ From: ${formatDateTime(block.startDate)}</div>
                  <div>üìÖ Until: ${formatDateTime(block.endDate)}</div>
                  ${block.appliesToAllServices ? '<div style="color: #c62828; font-weight: 600;">‚ö†Ô∏è Entire Resort Blocked</div>' : ''}
                </div>
              </div>
            `;
          });
        }
        
        // Show reservation information if present
        if (reservations && reservations.length > 0) {
          if (html) html += '<div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 2px solid #ddd;"></div>';
          html += '<div style="font-weight: bold; margin-bottom: 0.5rem; color: var(--primary-color); border-bottom: 1px solid #ddd; padding-bottom: 0.25rem;">Bookings:</div>';
          
          // Remove duplicates by reservationId
          const uniqueReservations = [];
          const seenIds = new Set();
          reservations.forEach(res => {
            if (!seenIds.has(res.reservationId)) {
              seenIds.add(res.reservationId);
              uniqueReservations.push(res);
            }
          });
          
          uniqueReservations.forEach((res, idx) => {
            if (idx > 0) html += '<div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #eee;"></div>';
            html += `
              <div>
                <div style="font-weight: 600; color: #333;">${res.amenity}</div>
                <div style="color: #666; font-size: 0.8rem; margin-top: 0.2rem;">
                  <div>üìÖ Check-in: ${formatDateTime(res.checkIn)}</div>
                  <div>üìÖ Check-out: ${formatDateTime(res.checkOut)}</div>
                  <div>‚è±Ô∏è Duration: ${res.duration}</div>
                  <div>üé´ ID: ${res.reservationId}</div>
                </div>
              </div>
            `;
          });
        }
        
        tooltip.innerHTML = html;
        return tooltip;
      }

      function renderCalendar() {
        const monthYearEl = document.getElementById('calendar-month-year');
        const calendarGrid = document.getElementById('calendar-grid');

        currentMonth = viewMonthIndex;
        currentYear = viewYear;
        
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        monthYearEl.textContent = `${monthNames[currentMonth]} ${currentYear}`;
        
        calendarGrid.innerHTML = '';
        
        // Day headers
        const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        dayNames.forEach(day => {
          const dayHeader = document.createElement('div');
          dayHeader.textContent = day;
          dayHeader.style.cssText = 'font-weight: bold; text-align: center; padding: 0.5rem; color: var(--primary-color); font-size: 0.9rem;';
          calendarGrid.appendChild(dayHeader);
        });
        
        // Get first day of month and number of days
        const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        
        // Empty cells before first day
        for (let i = 0; i < firstDay; i++) {
          const emptyCell = document.createElement('div');
          emptyCell.style.cssText = 'padding: 0.75rem; text-align: center;';
          calendarGrid.appendChild(emptyCell);
        }
        
        // Day cells
        const today = new Date();
        
        for (let day = 1; day <= daysInMonth; day++) {
          const date = new Date(currentYear, currentMonth, day);
          const dateString = date.toDateString();
          const isBlocked = blockedDatesData.includes(dateString);
          const hasReservation = reservationDatesData.includes(dateString);
          const isToday = date.toDateString() === today.toDateString();
          const isPast = date < today && !isToday;
          
          const dayCell = document.createElement('div');
          dayCell.textContent = day;
          dayCell.style.position = 'relative';
          
          let bgColor = '#e8f5e9'; // Available (green)
          let borderColor = '#2d8f5c';
          let textColor = '#1b5e20';
          
          if (isPast) {
            bgColor = '#f5f5f5';
            borderColor = '#ddd';
            textColor = '#999';
          } else if (isBlocked) {
            bgColor = '#ffebee'; // Fully booked/blocked (red)
            borderColor = '#d97757';
            textColor = '#c62828';
          } else if (hasReservation) {
            bgColor = '#fff3e0'; // Partially booked (yellow/orange)
            borderColor = '#f59e0b';
            textColor = '#e65100';
          }
          
          if (isToday) {
            borderColor = 'var(--primary-color)';
            dayCell.style.fontWeight = 'bold';
          }
          
          dayCell.style.cssText = `
            padding: 0.75rem;
            text-align: center;
            background: ${bgColor};
            border: 2px solid ${borderColor};
            border-radius: 6px;
            color: ${textColor};
            cursor: pointer;
            transition: none;
            font-size: 0.95rem;
            position: relative;
            ${isToday ? 'font-weight: bold;' : ''}
          `;

          dayCell.addEventListener('click', () => {
            const blockedInfo = blockedDatesByDate[dateString] || [];
            const reservationInfo = reservationsByDate[dateString] || [];

            if (selectedCalendarCell) {
              selectedCalendarCell.style.boxShadow = 'none';
            }

            selectedCalendarCell = dayCell;
            dayCell.style.boxShadow = '0 0 0 3px rgba(45, 143, 92, 0.25)';

            showCalendarDetails(date, reservationInfo, blockedInfo);
          });
          
          calendarGrid.appendChild(dayCell);
        }
      }

      function changeMonth(delta) {
        const now = Date.now();
        if (now - lastNavAt < 150) {
          return;
        }
        lastNavAt = now;

        viewMonthIndex += delta;
        if (viewMonthIndex < 0) {
          viewMonthIndex = 11;
          viewYear -= 1;
        } else if (viewMonthIndex > 11) {
          viewMonthIndex = 0;
          viewYear += 1;
        }
        renderCalendar();
      }

      const prevMonthBtn = document.getElementById('prev-month');
      const nextMonthBtn = document.getElementById('next-month');

      if (prevMonthBtn) {
        prevMonthBtn.onclick = () => {
          changeMonth(-1);
        };
      }

      if (nextMonthBtn) {
        nextMonthBtn.onclick = () => {
          changeMonth(1);
        };
      }

      fetchBlockedDatesForCalendar();
    });
    </script>
  </body>
</html>
