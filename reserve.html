<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title></title>
	<link rel="stylesheet" href="style.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
	<script src="unsaved-changes-modal.js"></script>
	<style>
		/* Compact form styling for reserve.html */
		#reservationForm fieldset {
			padding: 1.2rem;
			margin-bottom: 1rem;
		}
		
		#reservationForm legend {
			font-size: 1rem;
			padding: 0 0.5rem;
		}
		
		#reservationForm label {
			margin-bottom: 0.3rem;
			font-size: 0.95rem;
		}
		
		#reservationForm input,
		#reservationForm select,
		#reservationForm textarea {
			margin-bottom: 0.7rem;
			padding: 0.6rem;
		}
		
		#reservationForm textarea {
			rows: 2;
		}
		
		/* 2-column layout for compact inputs */
		.form-row {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 1rem;
			margin-bottom: 0.7rem;
		}
		
		.form-row label {
			display: block;
		}
		
		.form-row input,
		.form-row select {
			width: 100%;
		}
		
		/* Compact price summary */
		#price-summary {
			padding: 1rem;
			margin-bottom: 1rem;
		}
		
		#price-summary hr {
			margin: 0.8rem 0;
		}
		
		#price-summary .summary-total,
		#price-summary #discountRow,
		#price-summary #finalTotalRow {
			padding: 0.8rem;
			margin-bottom: 0.8rem;
		}
		
		#price-summary .summary-total p,
		#price-summary #discountRow p,
		#price-summary #finalTotalRow p {
			margin: 0.3rem 0;
		}
		
		#price-summary .summary-total p:first-child,
		#price-summary #discountRow p:first-child {
			font-size: 0.95rem;
		}
		
		#price-summary .summary-total p:last-child,
		#price-summary #discountRow p:last-child {
			font-size: 1.3rem;
		}
		
		#price-summary #finalTotalRow p:first-child {
			font-size: 1rem;
		}
		
		#price-summary #finalTotalRow p:last-child {
			font-size: 1.5rem;
		}
		
		/* Compact promo code section */
		.promo-input-group {
			margin-bottom: 0.5rem;
		}
		
		#promoCodeMessage {
			margin-top: 0.3rem !important;
			font-size: 0.85rem !important;
		}
		
		/* Compact info paragraphs */
		#maxGuestsInfo,
		#duration-display {
			margin-bottom: 0.5rem !important;
			margin-top: 0.2rem !important;
		}
		
		/* Compact page hero */
		.page-hero-section {
			margin-bottom: 1.5rem !important;
			padding: 2rem 0 !important;
		}
		
		.page-hero-section h1 {
			font-size: 2rem;
			margin-bottom: 0.5rem;
		}
		
		.page-hero-section p {
			font-size: 1rem;
		}
		
		/* Compact availability section */
		#availabilityCalendarSection #availabilityInfo {
			padding: 1rem;
		}
		
		#availabilityCalendarSection p {
			margin-bottom: 0.8rem;
		}
		
		/* Compact terms section */
		#reservationForm fieldset:last-of-type {
			padding: 1rem;
			margin-bottom: 1rem;
		}
		
		/* Compact multi-amenity table */
		#multiAmenitySection table th,
		#multiAmenitySection table td {
			padding: 0.6rem;
		}
		
		/* Mobile responsiveness */
		@media (max-width: 768px) {
			.form-row {
				grid-template-columns: 1fr;
				gap: 0;
			}
			
			#reservationForm fieldset {
				padding: 1rem;
			}
		}
	</style>
	<!-- Flatpickr CSS -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>

	<header>
        <nav>
            <a href="index.html" class="nav-logo" aria-label="Tito Renz Resort">
                <img src="images/logo.png" alt="Tito Renz Resort Logo">
            </a>
            <ul>
                </ul>
            <div class="nav-right" id="navRight"></div>
        </nav>
    </header>
	<main class="has-fixed-header-offset reserve-parallax">
		<!-- Page Hero Section -->
		<section class="page-hero-section" style="margin-bottom: 3rem;">
			<div class="hero-content">
				<h1>Complete Your Reservation</h1>
				<p>Secure your perfect getaway</p>
			</div>
		</section>

		<div class="reserve-parallax-inner">
				<form id="reservationForm">

				<!-- MODE DETECTION FOR DUAL-FLOW SUPPORT (OPTION A) -->
				<input type="hidden" id="reservationMode" value="single-service">

				<!-- SINGLE-SERVICE FLOW SECTION -->
				<div id="singleServiceSection">
	        	<input type="hidden" id="serviceIdInput" name="serviceId" value="">
				<input type="hidden" id="serviceTypeInput" name="serviceType" value="">
	        	<fieldset>
			    <legend>1. Selected Service</legend>
			    <p>You have selected: <span id="selectedServiceDisplay" style="font-weight: bold; color: #dc3545;">(No Service Selected)</span></p>
		    </fieldset>

				<!-- NEW: Availability Calendar -->
				<fieldset id="availabilityCalendarSection" style="display: none;">
					<legend>üìÖ Service Availability Calendar</legend>
					<p style="font-size: 0.9rem; color: #666; margin-bottom: 15px;">
						Below are the dates that are unavailable for this service. Please avoid these dates when making your reservation.
					</p>
					<div id="availabilityInfo" style="padding: 15px; background-color: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
						<div style="display: flex; gap: 20px; margin-bottom: 10px; flex-wrap: wrap;">
							<div>
								<span style="display: inline-block; width: 20px; height: 20px; background-color: #dc3545; border-radius: 4px; vertical-align: middle;"></span>
								<span style="margin-left: 8px; font-size: 0.9rem;">Blocked by Admin</span>
							</div>
							<div>
								<span style="display: inline-block; width: 20px; height: 20px; background-color: #ffc107; border-radius: 4px; vertical-align: middle;"></span>
								<span style="margin-left: 8px; font-size: 0.9rem;">Already Reserved</span>
							</div>
						</div>
						<div id="unavailableDatesList" style="margin-top: 10px; max-height: 200px; overflow-y: auto;">
							<p style="color: #999;">Loading availability...</p>
						</div>
					</div>
				</fieldset>

	            <fieldset>
	                <legend>2. Reservation Details</legend>
	                
	                <div class="form-row">
	                    <div>
	                        <label for="duration-selector">Duration / Time Slot:</label>
	                        <select id="duration-selector" name="duration" required>
	                            <option value="">Loading...</option>
	                        </select>
	                        <p id="duration-display" style="font-size: 0.85rem; color: #666;"></p>
	                    </div>
	                    <div>
	                        <label for="guests">Number of Guests:</label>
	                        <input type="number" id="guests" name="number_of_guests" min="1" required>
	                        <p id="maxGuestsInfo" style="font-size: 0.85rem; color: #666;"></p>
	                    </div>
	                </div>

	                <div class="form-row">
	                    <div>
	                        <label for="checkin">Check-in Date & Time:</label>
	                        <input type="datetime-local" id="checkin" name="checkin_date" required>
	                    </div>
	                    <div>
	                        <label for="checkout">Check-out Date & Time: <span style="color: #999; font-size: 0.8rem;"><em>(Auto)</em></span></label>
	                        <input type="datetime-local" id="checkout" name="checkout_date" required readonly style="cursor: not-allowed; background-color: #f5f5f5; opacity: 0.7;">
	                    </div>
	                </div>
	            </fieldset>

	            <div id=guestDetailsForm>
		            <fieldset>
					    <legend>3. Your Contact & Personal Details</legend>

					    <div class="form-row">
					        <div>
					            <label for="name">Full Name:</label>
					            <input type="text" id="name" name="customer_name" required readonly>
					        </div>
					        <div>
					            <label for="contact">Contact Number:</label>
					            <input type="tel" id="contact" name="customer_contact" required>
					        </div>
					    </div>

					    <div class="form-row">
					        <div>
					            <label for="email">Email Address:</label>
					            <input type="email" id="email" name="customer_email" required readonly>
					        </div>
					        <div>
					            <label for="address">Residential Address:</label>
					            <input type="text" id="address" name="customer_address" required>
					        </div>
					    </div>

					    <label for="notes">Special Requests / Notes (Optional):</label>
					    <textarea id="notes" name="customer_notes" rows="2"></textarea>
					</fieldset>
				</div>
				</div>
				<!-- END SINGLE-SERVICE FLOW SECTION -->

				<!-- MULTI-AMENITY FLOW SECTION -->
				<div id="multiAmenitySection" style="display: none;">
					<fieldset style="margin-bottom: 2rem;">
						<legend>1. Selected Amenities</legend>
						<p style="margin-bottom: 1rem; color: #666;">You have selected <span id="amenityCountDisplay">0</span> item(s):</p>
						
						<div style="overflow-x: auto;">
							<table style="width: 100%; border-collapse: collapse; font-size: 0.95rem;">
								<thead>
									<tr style="background-color: #f8f9fa; border-bottom: 2px solid #dee2e6;">
										<th style="padding: 12px; text-align: left; font-weight: 600;">Service Name</th>
										<th style="padding: 12px; text-align: left; font-weight: 600;">Duration</th>
										<th style="padding: 12px; text-align: center; font-weight: 600;">Guests</th>
										<th style="padding: 12px; text-align: center; font-weight: 600;">Check-In</th>
										<th style="padding: 12px; text-align: center; font-weight: 600;">Check-Out</th>
										<th style="padding: 12px; text-align: right; font-weight: 600;">Price</th>
									</tr>
								</thead>
								<tbody id="multiAmenityTableBody">
									<!-- Populated by JavaScript -->
								</tbody>
							</table>
						</div>
					</fieldset>

					<!-- Multi-Amenity Guest Details -->
					<fieldset>
						<legend>2. Your Contact & Personal Details</legend>

						<div class="form-row">
						    <div>
						        <label for="nameMulti">Full Name:</label>
						        <input type="text" id="nameMulti" name="customer_name" required readonly>
						    </div>
						    <div>
						        <label for="contactMulti">Contact Number:</label>
						        <input type="tel" id="contactMulti" name="customer_contact" required>
						    </div>
						</div>

						<div class="form-row">
						    <div>
						        <label for="emailMulti">Email Address:</label>
						        <input type="email" id="emailMulti" name="customer_email" required readonly>
						    </div>
						    <div>
						        <label for="addressMulti">Residential Address:</label>
						        <input type="text" id="addressMulti" name="customer_address" required>
						    </div>
						</div>

						<label for="notesMulti">Special Requests / Notes (Optional):</label>
						<textarea id="notesMulti" name="customer_notes" rows="2"></textarea>
					</fieldset>
				</div>
				<!-- END MULTI-AMENITY FLOW SECTION -->

	            <!-- Price Summary & Promo Code Area -->
	            <div id="price-summary" class="summary-box">
			    <div class="form-group">
			        <label for="promoCodeInput">Have a Promo Code?</label>
			        <div class="promo-input-group" style="display: flex; gap: 10px; align-items: center;">
			            <input type="text" id="promoCodeInput" placeholder="Enter code" class="form-control" style="flex: 1; min-width: 150px;">
			            <button type="button" id="applyPromoBtn" class="button-secondary" style="white-space: nowrap; flex-shrink: 0;" onclick="applyPromoCode()">Apply</button>
			        </div>
			        <p id="promoCodeMessage"></p>
			    </div>
			    <hr>

				    <div id="summary-details">
						<div id="singleServiceSummary">
							<!-- Single-service pricing shows here -->
						</div>
						<div id="multiAmenitySummary" style="display: none;">
							<div class="summary-detail-row">
								<span class="summary-detail-label">Number of Items:</span>
								<span class="summary-detail-value" id="summaryAmenityCount">0</span>
							</div>
						</div>
				        </div>
				    
				    <hr>
			    <div class="summary-total" style="text-align: center; background: #f8f9fa; border-radius: 6px;">
						<p>Subtotal:</p>
			        <p style="font-weight: 600;">‚Ç±<span id="basePriceDisplay">0.00</span></p>
			    </div>

			    <div id="discountRow" style="text-align: center; background: #fff3cd; border-radius: 6px;">
			        <p>Discount:</p>
			        <p style="color: #d9534f;"><span id="discountDisplay">0.00</span></p>
			    </div>
			    
			    <hr>

			    <div id="finalTotalRow" style="text-align: center; background: #d4edda; border-radius: 6px; border: 2px solid #28a745;">
			        <p style="font-weight: bold;">Total Amount Due:</p>
			        <p style="font-weight: bold; color: #28a745;">‚Ç±<span id="finalTotalDisplay">0.00</span></p>
			    </div>
			</div>

				<fieldset>
				    <legend>4. Terms and Conditions</legend>
				    <div style="display: flex; align-items: center; gap: 8px;">
				        <input type="checkbox" id="termsCheck" name="terms_agreed" required style="width: auto;">
				        <label for="termsCheck" style="font-weight: 600; margin-bottom: 0;">I agree to the <a href="#" onclick="showTermsModal(); return false;">Terms and Conditions</a>.</label>
				    </div>
				</fieldset>
				<input type="hidden" id="serviceIdInput" name="serviceId" value="" />
				<input type="hidden" id="serviceTypeInput" name="serviceType" value="" />
				<input type="hidden" id="basePriceInput" name="basePrice" value="" />
				<input type="hidden" id="finalTotalInput" name="finalTotal" value="" />
				<input type="hidden" id="maxGuestsAllowed" value="0">
				<input type="hidden" id="selectedDurationInput" name="selectedDuration" value="" />
				<input type="hidden" id="selectedTimeSlotInput" name="selectedTimeSlot" value="" />
				<input type="hidden" id="discountCodeInput" name="discountCode" value="" />
				<input type="hidden" id="discountValueInput" name="discountValue" value="0" />
				<div style="display: flex; gap: 1rem; flex-wrap: wrap;">
					<button type="button" class="button-secondary" id="goBackBtn" style="flex: 1;">Go Back</button>
					<button type="button" class="button-primary" id="submitReservationBtn" style="flex: 1;">Submit Reservation & Pay</button>
				</div>
				</form>
			</section>
			</div>
	</main>

	<!-- Reservation Summary Modal -->
	<div id="reservationSummaryModal" class="modal" style="display: none;">
		<div class="modal-content summary-modal-content">
			<div class="modal-header">
				<h2>Reservation Summary</h2>
				<button type="button" class="modal-close" onclick="document.getElementById('reservationSummaryModal').style.display = 'none';">&times;</button>
			</div>
			<div class="modal-body">
				<!-- Service Details -->
				<div class="summary-section">
					<h3 class="summary-section-title">Service Details</h3>
					<div class="summary-detail-row">
						<span class="summary-detail-label">Service Name:</span>
						<span class="summary-detail-value" id="summaryServiceName">-</span>
					</div>
					<div class="summary-detail-row">
						<span class="summary-detail-label">Service Type:</span>
						<span class="summary-detail-value" id="summaryServiceType">-</span>
					</div>
				</div>

				<!-- Guest & Date Information -->
				<div class="summary-section">
					<h3 class="summary-section-title">Booking Details</h3>
					<div class="summary-detail-row">
						<span class="summary-detail-label">Number of Guests:</span>
						<span class="summary-detail-value" id="summaryGuests">-</span>
					</div>
					<div class="summary-detail-row">
						<span class="summary-detail-label">Check-in Date & Time:</span>
						<span class="summary-detail-value" id="summaryCheckin">-</span>
					</div>
					<div class="summary-detail-row">
						<span class="summary-detail-label">Check-out Date & Time:</span>
						<span class="summary-detail-value" id="summaryCheckout">-</span>
					</div>
				</div>

				<!-- Customer Information -->
				<div class="summary-section">
					<h3 class="summary-section-title">Customer Information</h3>
					<div class="summary-detail-row">
						<span class="summary-detail-label">Name:</span>
						<span class="summary-detail-value" id="summaryCustomerName">-</span>
					</div>
				</div>

				<!-- Service Inclusions -->
				<div class="summary-section">
					<h3 class="summary-section-title">Service Inclusions</h3>
					<ul class="inclusions-list" id="summaryInclusions">
						<li>Loading...</li>
					</ul>
				</div>

				<!-- Pricing Summary -->
				<div class="summary-section pricing-section">
					<h3 class="summary-section-title">Pricing Summary</h3>
					<div class="summary-detail-row pricing-row">
						<span class="summary-detail-label">Base Price:</span>
						<span class="summary-detail-value" id="summaryBasePrice">‚Ç±0.00</span>
					</div>
					<div class="summary-detail-row pricing-row" id="summaryDiscountRow" style="display: none;">
						<span class="summary-detail-label">Discount:</span>
						<span class="summary-detail-value discount-value" id="summaryDiscountValue">-‚Ç±0.00</span>
					</div>
					<div class="summary-detail-row pricing-row total-row">
						<span class="summary-detail-label">Total Amount Due:</span>
						<span class="summary-detail-value total-amount" id="summaryTotalAmount">‚Ç±0.00</span>
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" onclick="document.getElementById('reservationSummaryModal').style.display = 'none';">Close</button>
				<button type="button" class="btn btn-danger" id="cancelReservationBtn">Cancel Reservation</button>
			</div>
		</div>
	</div>

	<footer>
        <div class="footer-content">
            <div class="footer-section contact-info">
                <h3>Tito Renz Resort</h3>
                <p>Your seamless booking experience starts here.</p>
                <p>üìç Norzagaray, Bulacan, Philippines</p>
                <p>üìû 0977 246 8920 or 0916 640 3411</p>
                <p>üìß titorenznorzagaray@gmail.com</p>
            </div>

            <div class="footer-section quick-links">
                <h3>Quick Links</h3>
                <ul>
                    <!-- Dynamically populated by renderFooterQuickLinks() -->
                </ul>
            </div>

            <div class="footer-section about-contact">
                <h3>About & Contact</h3>
                <ul>
                    <li><a href="about.html">Our Story</a></li>
                    <li><a href="contact.html">Send Us a Message</a></li>
                    <li><a href="help.html">Help / Guides</a></li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2025 QReserve Project - All Rights Reserved.</p>
        </div>
    </footer>
	<script src="notifications.js"></script>
	<script src="ui-core.js"></script>
	<script src="auth-profile.js"></script>
	<!-- cart-system.js removed - functionality integrated into other files -->
	<script src="reservation.js"></script>

		<script>
		// --- Global variable to store applied promo code data ---
		let appliedPromoData = null;
		
		// --- Ensure hidden fields are set before form submission ---
		document.addEventListener('DOMContentLoaded', function() {
			const form = document.getElementById('reservationForm');
			if (form) {
				form.addEventListener('submit', function(e) {
					// CRITICAL: Disable unsaved changes modal for form submission
					// This allows the form to be submitted without triggering the "unsaved changes" warning
					if (typeof clearReservationData === 'function') {
						clearReservationData();
					}
					
					// Get values from sessionStorage or visible fields
					const serviceId = sessionStorage.getItem('selectedServiceId') || document.getElementById('serviceIdInput')?.value;
					const serviceType = sessionStorage.getItem('selectedServiceType') || document.getElementById('serviceTypeInput')?.value;
					const basePrice = sessionStorage.getItem('selectedServicePrice') || document.getElementById('basePriceDisplay')?.textContent?.replace(/[^\d.]/g, '');
					const finalTotal = document.getElementById('finalTotalDisplay')?.textContent?.replace(/[^\d.]/g, '') || '';
					const selectedDuration = sessionStorage.getItem('selectedDuration') || document.getElementById('duration-selector')?.value;
					const selectedTimeSlot = sessionStorage.getItem('selectedTimeSlot') || '';
					const discountCode = sessionStorage.getItem('appliedPromoCode') || document.getElementById('promoCodeInput')?.value || '';
					const discountValue = document.getElementById('discountValueInput')?.value || sessionStorage.getItem('discountValue') || '0';

					// Set hidden fields
					if (document.getElementById('serviceIdInput')) document.getElementById('serviceIdInput').value = serviceId || '';
					if (document.getElementById('serviceTypeInput')) document.getElementById('serviceTypeInput').value = serviceType || '';
					if (document.getElementById('basePriceInput')) document.getElementById('basePriceInput').value = basePrice || '';
					if (document.getElementById('finalTotalInput')) document.getElementById('finalTotalInput').value = finalTotal || '';
					if (document.getElementById('selectedDurationInput')) document.getElementById('selectedDurationInput').value = selectedDuration || '';
					if (document.getElementById('selectedTimeSlotInput')) document.getElementById('selectedTimeSlotInput').value = selectedTimeSlot || '';
					if (document.getElementById('discountCodeInput')) document.getElementById('discountCodeInput').value = discountCode || '';
					if (document.getElementById('discountValueInput')) document.getElementById('discountValueInput').value = discountValue || '0';
				});
			}
		});
		// --- Prefill reservation from GET params ---
		function getQueryParams() {
			const params = {};
			window.location.search.replace(/^\?/, '').split('&').forEach(function(pair) {
				if (!pair) return;
				const [k, v] = pair.split('=');
				params[decodeURIComponent(k)] = decodeURIComponent(v || '');
			});
			return params;
		}

		// --- Promo Code Reset Helpers ---
		function clearPromoState() {
			// Reset in-memory state
			appliedPromoData = null;
			// Reset UI
			const promoInput = document.getElementById('promoCodeInput');
			const promoMsg = document.getElementById('promoCodeMessage');
			const applyBtn = document.getElementById('applyPromoBtn');
			if (promoInput) { promoInput.value = ''; promoInput.disabled = false; }
			if (promoMsg) { promoMsg.textContent = ''; }
			if (applyBtn) { applyBtn.textContent = 'Apply Code'; applyBtn.disabled = false; applyBtn.onclick = applyPromoCode; }
			// Reset pricing based on current base price
			const basePriceText = document.getElementById('basePriceDisplay')?.textContent || '0';
			const basePrice = parseFloat(String(basePriceText).replace(/,/g, '')) || 0;
			const discountDisplay = document.getElementById('discountDisplay');
			const finalTotalDisplay = document.getElementById('finalTotalDisplay');
			if (discountDisplay) discountDisplay.textContent = '0.00';
			if (finalTotalDisplay) finalTotalDisplay.textContent = basePrice.toLocaleString('en-PH', { minimumFractionDigits: 2 });
			// Reset hidden inputs
			const discountValueInput = document.getElementById('discountValueInput');
			const discountCodeInput = document.getElementById('discountCodeInput');
			const finalTotalInput = document.getElementById('finalTotalInput');
			if (discountValueInput) discountValueInput.value = '0';
			if (discountCodeInput) discountCodeInput.value = '';
			if (finalTotalInput) finalTotalInput.value = basePrice;
			// Reset session storage
			sessionStorage.removeItem('appliedPromoCode');
			sessionStorage.removeItem('discountValue');
			sessionStorage.setItem('finalTotal', String(basePrice));
		}

		function resetPromoOnNewReservation(params) {
			const newServiceId = params.serviceId || '';
			const previousServiceId = sessionStorage.getItem('selectedServiceId') || '';
			const isResuming = sessionStorage.getItem('isResumingReservation') === 'true';
			// If starting a new reservation (URL has serviceId) and it's different from previous, clear promo
			if (newServiceId && previousServiceId && newServiceId !== previousServiceId) {
				clearPromoState();
				return;
			}
			// If explicitly starting fresh via URL, and not resuming, clear promo
			if (newServiceId && !isResuming) {
				clearPromoState();
			}
		}

		function trySetDurationFromParams(params) {
			const durationSelect = document.getElementById('duration-selector');
			if (!durationSelect) return;
			if (params.duration) {
				const setValue = () => {
					if (durationSelect.options.length > 1) {
						durationSelect.value = params.duration;
						durationSelect.dispatchEvent(new Event('change'));
					} else {
						setTimeout(setValue, 100);
					}
				};
				setValue();
			}
		}

		// Patch: Ensure durations load from serviceId param
		function loadDurationsFromServiceId(serviceId) {
			if (!serviceId || !window.resortServices) {
				document.getElementById('duration-selector').innerHTML = '<option value="">No durations found (service not loaded)</option>';
				return;
			}
			
			const service = window.resortServices.find(s => (s._id || s.id) === serviceId);
			console.log('Services loaded:', window.resortServices);
			const durationSelect = document.getElementById('duration-selector');
			if (!durationSelect) return;
			if (!service) {
				durationSelect.innerHTML = '<option value="">No durations found for this service</option>';
				return;
			}
			const options = [...(service.timeSlots || []), ...(service.durations || [])];
			if (options.length === 0) {
				durationSelect.innerHTML = '<option value="">No durations available for this service</option>';
				return;
			}
			durationSelect.innerHTML = '<option value="">-- Select --</option>';
			options.forEach(opt => {
				const option = document.createElement('option');
				option.value = opt.id;
				option.textContent = `${opt.label} - ‚Ç±${opt.price.toLocaleString()}`;
				durationSelect.appendChild(option);
			});
		}

		// --- MODE DETECTION FOR DUAL-FLOW SUPPORT (OPTION A) ---

		function detectReservationMode() {
		    const urlParams = new URLSearchParams(window.location.search);
		    const mode = urlParams.get('mode') || 'single-service';
		    document.getElementById('reservationMode').value = mode;
		    return mode;
		}

		function initializeReservationMode(mode) {
		    const singleServiceSection = document.getElementById('singleServiceSection');
		    const multiAmenitySection = document.getElementById('multiAmenitySection');
		    
		    if (mode === 'multi-amenity') {
		        // MULTI-AMENITY MODE
		        singleServiceSection.style.display = 'none';
		        multiAmenitySection.style.display = 'block';
		        
		        // Load multi-amenity data from sessionStorage
		        const multiAmenityReservation = JSON.parse(
		            sessionStorage.getItem('multiAmenityReservation') || 'null'
		        );
		        
		        if (multiAmenityReservation && multiAmenityReservation.amenities) {
		            populateMultiAmenityTable(multiAmenityReservation.amenities);
		            populateMultiAmenityPricing(multiAmenityReservation);
		            prefillMultiAmenityUserData();
		        }
		    } else {
		        // SINGLE-SERVICE MODE (DEFAULT/FALLBACK)
		        singleServiceSection.style.display = 'block';
		        multiAmenitySection.style.display = 'none';
		    }
		}

		function populateMultiAmenityTable(amenities) {
		    const tbody = document.getElementById('multiAmenityTableBody');
		    tbody.innerHTML = ''; // Clear existing rows
		    
		    amenities.forEach((amenity, index) => {
		        const row = document.createElement('tr');
		        row.style.borderBottom = '1px solid #dee2e6';
		        
		        // Format check-in/out times
		        const checkInTime = amenity.checkInTime ? 
		            formatTime24To12(parseInt(amenity.checkInTime)) : 'N/A';
		        const checkOutTime = amenity.checkOutTime || 'N/A';
		        
		        // Format dates - parse correctly to avoid UTC timezone issues
		        let checkInDate = 'N/A';
		        if (amenity.checkIn) {
		            const parts = amenity.checkIn.split('-');
		            if (parts.length === 3) {
		                const date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
		                checkInDate = date.toLocaleDateString('en-US', {
		                    month: 'short', day: 'numeric', year: 'numeric'
		                });
		            }
		        }
		        
		        let checkOutDate = 'N/A';
		        if (amenity.checkOut) {
		            const parts = amenity.checkOut.split('-');
		            if (parts.length === 3) {
		                const date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
		                checkOutDate = date.toLocaleDateString('en-US', {
		                    month: 'short', day: 'numeric', year: 'numeric'
		                });
		            }
		        }
		        
		        row.innerHTML = `
		            <td style="padding: 12px; vertical-align: middle;">${amenity.serviceName || 'Unknown'}</td>
		            <td style="padding: 12px; vertical-align: middle;">${amenity.durationLabel || 'N/A'}</td>
		            <td style="padding: 12px; text-align: center; vertical-align: middle;">
		                <span style="font-weight: 500;">${amenity.guests || 1}</span>
		            </td>
		            <td style="padding: 12px; text-align: center; vertical-align: middle;">
		                <div style="font-size: 0.85rem; color: #666;">${checkInDate}</div>
		                <div style="font-weight: 500;">${checkInTime}</div>
		            </td>
		            <td style="padding: 12px; text-align: center; vertical-align: middle;">
		                <div style="font-size: 0.85rem; color: #666;">${checkOutDate}</div>
		                <div style="font-weight: 500;">${checkOutTime}</div>
		            </td>
		            <td style="padding: 12px; text-align: right; vertical-align: middle; font-weight: 600;">
		                ‚Ç±${(amenity.price || 0).toLocaleString('en-PH', {minimumFractionDigits: 2})}
		            </td>
		        `;
		        
		        tbody.appendChild(row);
		    });
		    
		    // Update amenity count
		    document.getElementById('amenityCountDisplay').textContent = amenities.length;
		    document.getElementById('summaryAmenityCount').textContent = amenities.length;
		}

		function populateMultiAmenityPricing(multiAmenityReservation) {
		    // Calculate and display pricing
		    const originalTotal = multiAmenityReservation.originalTotal || 0;
		    const appliedPromo = multiAmenityReservation.appliedPromo;
		    let finalTotal = originalTotal;
		    let discountAmount = 0;
		    
		    if (appliedPromo && appliedPromo.discountAmount) {
		        discountAmount = appliedPromo.discountAmount;
		        finalTotal = originalTotal - discountAmount;
		    }
		    
		    // Update price display
		    document.getElementById('basePriceDisplay').textContent = 
		        originalTotal.toLocaleString('en-PH', {minimumFractionDigits: 2});
		    document.getElementById('discountDisplay').textContent = 
		        discountAmount.toLocaleString('en-PH', {minimumFractionDigits: 2});
		    document.getElementById('finalTotalDisplay').textContent = 
		        finalTotal.toLocaleString('en-PH', {minimumFractionDigits: 2});
		    
		    // Show/hide discount row
		    const discountRow = document.getElementById('discountRow');
		    if (discountAmount > 0) {
		        discountRow.style.display = 'block';
		    } else {
		        discountRow.style.display = 'none';
		    }
		    
		    // Update hidden inputs
		    document.getElementById('basePriceInput').value = originalTotal;
		    document.getElementById('finalTotalInput').value = finalTotal;
		    document.getElementById('discountValueInput').value = discountAmount;
		    
		    if (appliedPromo) {
		        document.getElementById('discountCodeInput').value = appliedPromo.code || '';
		    }
		}

		function formatTime24To12(hour24) {
		    const hour = parseInt(hour24);
		    const ampm = hour >= 12 ? 'PM' : 'AM';
		    const hour12 = hour % 12 || 12;
		    return `${hour12}:00 ${ampm}`;
		}

		function prefillMultiAmenityUserData() {
		    const user = (typeof getLoggedInUser === 'function') ? getLoggedInUser() : null;
		    if (user) {
		        if (user.full_name) {
		            document.getElementById('nameMulti').value = user.full_name;
		        }
		        if (user.phone) {
		            document.getElementById('contactMulti').value = user.phone;
		        }
		        if (user.email) {
		            document.getElementById('emailMulti').value = user.email;
		        }
		        if (user.address) {
		            document.getElementById('addressMulti').value = user.address;
		        }
		    }
		}

		document.addEventListener('DOMContentLoaded', function() {
			const params = getQueryParams();
			// Ensure any previous promo code doesn't bleed into a new reservation
			resetPromoOnNewReservation(params);
			// Check if we have service data from URL params OR from sessionStorage (resume flow)
			const serviceId = params.serviceId || sessionStorage.getItem('selectedServiceId');
			const serviceName = params.serviceName || sessionStorage.getItem('selectedServiceName');
			const price = params.price || sessionStorage.getItem('selectedServicePrice');
			
			if (serviceId) {
				// Set hidden input fields
				document.getElementById('serviceIdInput').value = serviceId;
				document.getElementById('selectedServiceDisplay').textContent = serviceName || '(No Service Selected)';
				if (price) {
					document.getElementById('basePriceDisplay').textContent = Number(price).toLocaleString('en-PH', {minimumFractionDigits:2});
					document.getElementById('finalTotalDisplay').textContent = Number(price).toLocaleString('en-PH', {minimumFractionDigits:2});
				}
				// Patch: Set sessionStorage values from query params OR preserve existing sessionStorage
				sessionStorage.setItem('selectedServiceId', serviceId);
				if (serviceName) sessionStorage.setItem('selectedServiceName', serviceName);
				if (price) sessionStorage.setItem('selectedServicePrice', price);

				// Wait for services to load before loading durations
				fetchServices().then(() => {
					// Set serviceType and inclusions in sessionStorage and hidden input
					if (window.resortServices) {
						const svc = window.resortServices.find(s => (s._id || s.id) === serviceId);
						if (svc && svc.type) {
							sessionStorage.setItem('selectedServiceType', svc.type);
							document.getElementById('serviceTypeInput').value = svc.type;
						}
						// Store inclusions for summary modal
						if (svc && Array.isArray(svc.inclusions)) {
							sessionStorage.setItem('serviceInclusions', JSON.stringify(svc.inclusions));
						}
					}
					loadDurationsFromServiceId(serviceId);
					trySetDurationFromParams(params);

					// Patch: If duration is present in query params, set sessionStorage and hidden input
					if (params.duration) {
						sessionStorage.setItem('selectedDuration', params.duration);
						const selectedDurationInput = document.getElementById('selectedDurationInput');
						if (selectedDurationInput) selectedDurationInput.value = params.duration;
					}
					
					// ===== UPDATE MAX GUESTS CONSTRAINT =====
					// Call this after service is loaded to set max guests limit
					if (typeof updateMaxGuestsConstraint === 'function') {
						updateMaxGuestsConstraint();
					}
					
					// NEW: Restore form fields from sessionStorage (for resume flow)
					const guestsFromStorage = sessionStorage.getItem('guests');
					const checkinFromStorage = sessionStorage.getItem('checkinDate');
					const checkoutFromStorage = sessionStorage.getItem('checkoutDate');
					const durationFromStorage = sessionStorage.getItem('selectedDuration');
					const durationLabelFromStorage = sessionStorage.getItem('selectedDurationLabel');
					
					// ‚úÖ FIX: Also check for cart data (from services-list.html amenity selector)
					const selectedCheckIn = sessionStorage.getItem('selectedCheckIn');
					const selectedCheckInTime = sessionStorage.getItem('selectedCheckInTime');
					const selectedCheckOut = sessionStorage.getItem('selectedCheckOut');
					const selectedCheckOutTime = sessionStorage.getItem('selectedCheckOutTime');
					
					if (guestsFromStorage && document.getElementById('guests')) {
						document.getElementById('guests').value = guestsFromStorage;
					}
					
					// Prioritize cart data over legacy checkinDate
					if (selectedCheckIn && selectedCheckInTime && document.getElementById('checkin')) {
						// Convert date (YYYY-MM-DD) + time (hour number) to datetime-local format (YYYY-MM-DDTHH:MM)
						const checkinHour = String(selectedCheckInTime).padStart(2, '0');
						const checkinDateTime = `${selectedCheckIn}T${checkinHour}:00`;
						document.getElementById('checkin').value = checkinDateTime;
					} else if (checkinFromStorage && document.getElementById('checkin')) {
						document.getElementById('checkin').value = checkinFromStorage;
					}
					
					if (selectedCheckOut && selectedCheckOutTime && document.getElementById('checkout')) {
						// Convert checkout time (might be "8:00 AM" or hour number) to 24-hour format
						let checkoutHour = selectedCheckOutTime;
						if (String(checkoutHour).includes('AM') || String(checkoutHour).includes('PM')) {
							// Parse "8:00 AM" to 24-hour
							const match = String(checkoutHour).match(/(\d+):(\d+)\s*(AM|PM)/i);
							if (match) {
								let hour = parseInt(match[1]);
								const ampm = match[3].toUpperCase();
								if (ampm === 'PM' && hour !== 12) hour += 12;
								if (ampm === 'AM' && hour === 12) hour = 0;
								checkoutHour = String(hour).padStart(2, '0');
								const checkoutDateTime = `${selectedCheckOut}T${checkoutHour}:${match[2]}`;
								document.getElementById('checkout').value = checkoutDateTime;
							}
						} else {
							// It's already a number
							checkoutHour = String(checkoutHour).padStart(2, '0');
							const checkoutDateTime = `${selectedCheckOut}T${checkoutHour}:00`;
							document.getElementById('checkout').value = checkoutDateTime;
						}
					} else if (checkoutFromStorage && document.getElementById('checkout')) {
						document.getElementById('checkout').value = checkoutFromStorage;
					}
					if (durationFromStorage && document.getElementById('duration-selector')) {
						document.getElementById('duration-selector').value = durationFromStorage;
						if (durationLabelFromStorage) {
							const durationDisplay = document.getElementById('durationDisplay');
							if (durationDisplay) {
								durationDisplay.textContent = durationLabelFromStorage;
							}
						}
					}
					
					// Flag to prevent auto-fill on initial load when data is already restored
					sessionStorage.setItem('isResumingReservation', 'true');

					// Restore promo codes and totals from sessionStorage ONLY when resuming
					if (sessionStorage.getItem('isResumingReservation') === 'true') {
						const promoCode = sessionStorage.getItem('promoCode') || sessionStorage.getItem('appliedPromoCode');
						const discountValue = sessionStorage.getItem('discountValue');
						const finalTotal = sessionStorage.getItem('finalTotal');
						if (promoCode && document.getElementById('promoCodeInput')) {
							document.getElementById('promoCodeInput').value = promoCode;
							document.getElementById('promoCodeInput').disabled = true;
							const applyBtn = document.getElementById('applyPromoBtn');
							if (applyBtn) { applyBtn.textContent = 'Remove Code'; applyBtn.onclick = removePromoCode; }
							if (discountValue) {
								const basePriceVal = parseFloat(sessionStorage.getItem('selectedServicePrice') || price) || 0;
								appliedPromoData = {
									code: promoCode,
									discountPercentage: basePriceVal ? (parseFloat(discountValue) / basePriceVal) : 0,
									discountAmount: parseFloat(discountValue)
								};
								const promoMsg = document.getElementById('promoCodeMessage');
								if (promoMsg) {
									promoMsg.textContent = `‚úì Promo code applied! You saved ‚Ç±${Number(discountValue).toLocaleString('en-PH', { minimumFractionDigits: 2 })}`;
									promoMsg.style.color = '#28a745';
								}
							}
						}
						if (discountValue && document.getElementById('discountValueInput')) {
							document.getElementById('discountValueInput').value = discountValue;
							const discountDisplay = document.getElementById('discountDisplay');
							if (discountDisplay) {
								discountDisplay.textContent = '‚Ç±' + Number(discountValue).toLocaleString('en-PH', { minimumFractionDigits: 2 });
							}
						}
						if (finalTotal && document.getElementById('finalTotalInput')) {
							document.getElementById('finalTotalInput').value = finalTotal;
							const finalTotalDisplay = document.getElementById('finalTotalDisplay');
							if (finalTotalDisplay) {
								finalTotalDisplay.textContent = Number(finalTotal).toLocaleString('en-PH', { minimumFractionDigits: 2 });
							}
						}
					}
					
					// Restore customer information from sessionStorage
					const customerName = sessionStorage.getItem('customerName');
					const customerContact = sessionStorage.getItem('customerContact');
					const customerEmail = sessionStorage.getItem('customerEmail');
					const customerAddress = sessionStorage.getItem('customerAddress');
					const customerNotes = sessionStorage.getItem('customerNotes');
					
					if (customerName && document.getElementById('name')) {
						document.getElementById('name').value = customerName;
					}
					if (customerContact && document.getElementById('contact')) {
						document.getElementById('contact').value = customerContact;
					}
					if (customerEmail && document.getElementById('email')) {
						document.getElementById('email').value = customerEmail;
					}
					if (customerAddress && document.getElementById('address')) {
						document.getElementById('address').value = customerAddress;
					}
					if (customerNotes && document.getElementById('notes')) {
						document.getElementById('notes').value = customerNotes;
					}
					
					// Restore promo codes and totals from sessionStorage
					const promoCode = sessionStorage.getItem('promoCode') || sessionStorage.getItem('appliedPromoCode');
					const discountValue = sessionStorage.getItem('discountValue');
					const finalTotal = sessionStorage.getItem('finalTotal');
					
					if (promoCode && document.getElementById('promoCodeInput')) {
						document.getElementById('promoCodeInput').value = promoCode;
						document.getElementById('promoCodeInput').disabled = true;
						
						// Update promo message
						const promoMessage = document.getElementById('promoCodeMessage');
						if (promoMessage && discountValue) {
							const basePrice = sessionStorage.getItem('selectedServicePrice') || price;
							const discountPercent = (parseFloat(discountValue) / parseFloat(basePrice)) * 100;
							promoMessage.textContent = `‚úì Promo code applied! You saved ${discountPercent.toFixed(0)}% (‚Ç±${parseFloat(discountValue).toLocaleString('en-PH', {minimumFractionDigits:2})})`;
							promoMessage.style.color = '#28a745';
						}
						
						// Change button to "Remove"
						const applyBtn = document.getElementById('applyPromoBtn');
						if (applyBtn) {
							applyBtn.textContent = 'Remove Code';
							applyBtn.onclick = removePromoCode;
						}
						
						// Store in appliedPromoData global
						if (discountValue) {
							const basePrice = parseFloat(sessionStorage.getItem('selectedServicePrice') || price);
							appliedPromoData = {
								code: promoCode,
								discountPercentage: parseFloat(discountValue) / basePrice,
								discountAmount: parseFloat(discountValue)
							};
						}
					}
					if (discountValue && document.getElementById('discountValueInput')) {
						document.getElementById('discountValueInput').value = discountValue;
						const discountDisplay = document.getElementById('discountDisplay');
						if (discountDisplay) {
							discountDisplay.textContent = '‚Ç±' + Number(discountValue).toLocaleString('en-PH', {minimumFractionDigits: 2});
						}
					}
					if (finalTotal && document.getElementById('finalTotalInput')) {
						document.getElementById('finalTotalInput').value = finalTotal;
						const finalTotalDisplay = document.getElementById('finalTotalDisplay');
						if (finalTotalDisplay) {
							finalTotalDisplay.textContent = Number(finalTotal).toLocaleString('en-PH', {minimumFractionDigits: 2});
						}
					}
				});
			}

			// Patch: Sync selected duration to sessionStorage and hidden input
			const durationSelect = document.getElementById('duration-selector');
			const selectedDurationInput = document.getElementById('selectedDurationInput');
			const checkinInput = document.getElementById('checkin');
			const checkoutInput = document.getElementById('checkout');
			const guestsInput = document.getElementById('guests');
			const maxGuestsInfo = document.getElementById('maxGuestsInfo');
			const maxGuestsAllowed = document.getElementById('maxGuestsAllowed');
			
			// ===== SET MAX GUESTS CONSTRAINT =====
			// Update max guests based on selected service
			function updateMaxGuestsConstraint() {
				if (!guestsInput || !window.resortServices) return;
				
				const serviceId = sessionStorage.getItem('selectedServiceId') || document.getElementById('serviceIdInput').value;
				const service = window.resortServices.find(s => (s._id || s.id) === serviceId);
				
				if (!service || !service.max_guests) {
					guestsInput.removeAttribute('max');
					if (maxGuestsInfo) maxGuestsInfo.textContent = '';
					if (maxGuestsAllowed) maxGuestsAllowed.value = '0';
					return;
				}
				
				const maxGuests = parseInt(service.max_guests);
				
				// Set the max attribute on the input
				guestsInput.max = maxGuests;
				
				// Update hidden field
				if (maxGuestsAllowed) maxGuestsAllowed.value = maxGuests;
				
				// Show info text
				if (maxGuestsInfo) {
					maxGuestsInfo.textContent = `Maximum ${maxGuests} guest${maxGuests > 1 ? 's' : ''} allowed for this service`;
					maxGuestsInfo.style.color = '#666';
				}
				
				// If current value exceeds max, reset to max
				if (guestsInput.value && parseInt(guestsInput.value) > maxGuests) {
					guestsInput.value = maxGuests;
				}
				
				console.log(`‚úì Max guests constraint set to: ${maxGuests}`);
			}
			
			// Add validation listener to guests input
			if (guestsInput) {
				guestsInput.addEventListener('input', function() {
					const maxGuests = parseInt(this.max) || 0;
					const currentValue = parseInt(this.value) || 0;
					
					if (currentValue > maxGuests && maxGuests > 0) {
						this.value = maxGuests;
						if (maxGuestsInfo) {
							maxGuestsInfo.textContent = `Maximum ${maxGuests} guest${maxGuests > 1 ? 's' : ''} allowed for this service`;
							maxGuestsInfo.style.color = '#dc3545';
						}
					} else if (maxGuestsInfo) {
						maxGuestsInfo.style.color = '#666';
					}
				});
				
				guestsInput.addEventListener('change', function() {
					const maxGuests = parseInt(this.max) || 0;
					const currentValue = parseInt(this.value) || 0;
					
					if (currentValue > maxGuests && maxGuests > 0) {
						this.value = maxGuests;
						showToast(`Adjusted to maximum ${maxGuests} guest${maxGuests > 1 ? 's' : ''} allowed`, 'info');
					}
				});
			}
			
			// ===== ROLLING 30-MINUTE RULE FOR CHECK-IN =====
			// Implements the Rolling 30-Minute Rule:
			// - If current time is MM:00 to MM:30, allow booking for current hour
			// - If current time is MM:31 to MM:59, allow booking for next hour
			// Resort operates 8:00 AM to 8:00 PM
			function setCheckInMinDate() {
				if (!checkinInput) return;
				
				// Get current date/time
				const now = new Date();
				const currentMinutes = now.getMinutes();
				const currentHour = now.getHours();
				
				// Determine the earliest bookable hour based on Rolling 30-Minute Rule
				let earliestHour;
				if (currentMinutes <= 30) {
					// Within :00-:30 window, can book current hour
					earliestHour = currentHour;
				} else {
					// Within :31-:59 window, must book next hour
					earliestHour = currentHour + 1;
				}
				
				// Create a date object for the minimum allowed time
				const minDate = new Date(now);
				minDate.setHours(earliestHour, 0, 0, 0); // Set to the start of the hour (:00)
				
				// If the earliest hour goes past midnight or before 8 AM, adjust to next day 8 AM
				if (earliestHour >= 24 || earliestHour < 8) {
					minDate.setDate(minDate.getDate() + 1);
					minDate.setHours(8, 0, 0, 0);
				}
				
				// If current time is after 8:00 PM (20:00), set min to next day 8 AM
				if (currentHour >= 20) {
					minDate.setDate(minDate.getDate() + 1);
					minDate.setHours(8, 0, 0, 0);
				}
				
				// Format for datetime-local input
				const year = minDate.getFullYear();
				const month = String(minDate.getMonth() + 1).padStart(2, '0');
				const day = String(minDate.getDate()).padStart(2, '0');
				const hours = String(minDate.getHours()).padStart(2, '0');
				const minutes = '00'; // Always start at :00 of the hour
				
				// Set min attribute
				const minDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
				checkinInput.min = minDateTime;
				
				console.log('Rolling 30-Min Rule - Check-in minimum set to:', minDateTime);
			}
			
			// Call on page load
			setCheckInMinDate();
			
			// ===== PREVENT INTERACTION WITH CHECK-OUT =====
			// Make checkout field read-only and prevent any user interaction
			function disableCheckoutInteraction() {
				if (!checkoutInput) return;
				
				// Already added readonly in HTML, but ensure it's disabled here
				checkoutInput.readOnly = true;
				
				// Prevent any click or focus events
				checkoutInput.addEventListener('click', function(e) {
					e.preventDefault();
					return false;
				});
				
				checkoutInput.addEventListener('focus', function(e) {
					e.preventDefault();
					e.target.blur();
					return false;
				});
				
				checkoutInput.addEventListener('keydown', function(e) {
					e.preventDefault();
					return false;
				});
				
				checkoutInput.addEventListener('keypress', function(e) {
					e.preventDefault();
					return false;
				});
				
				checkoutInput.addEventListener('mousedown', function(e) {
					e.preventDefault();
					return false;
				});
				
				// Prevent dragging/selecting
				checkoutInput.addEventListener('drag', function(e) {
					e.preventDefault();
					return false;
				});
				
				console.log('Check-out field is now read-only and non-interactive');
			}
			
			// Call on page load
			disableCheckoutInteraction();
			
			// Also prevent any attempt to modify checkout through JavaScript
			const originalSetAttribute = checkoutInput.setAttribute;
			checkoutInput.setAttribute = function(name, value) {
				if (name.toLowerCase() === 'readonly') {
					return originalSetAttribute.call(this, name, value);
				}
				if (name.toLowerCase() === 'value' && this.id === 'checkout') {
					return originalSetAttribute.call(this, name, value);
				}
				return originalSetAttribute.call(this, name, value);
			};
			
			// Function to auto-fill checkout date based on duration and checkin
			function autoFillCheckoutDate() {
				if (!durationSelect.value || !checkinInput.value) return;
				
				// Find the selected duration option in the service data
				const serviceId = sessionStorage.getItem('selectedServiceId') || document.getElementById('serviceIdInput').value;
				const service = window.resortServices?.find(s => (s._id || s.id) === serviceId);
				
				if (!service) return;
				
				// Get the duration option
				const allOptions = [...(service.timeSlots || []), ...(service.durations || [])];
				const selectedOption = allOptions.find(opt => opt.id === durationSelect.value);
				
				if (!selectedOption) return;
				
				// Parse checkin datetime correctly from datetime-local format (YYYY-MM-DDTHH:MM)
				// datetime-local values are always in the user's local timezone
				const dateTimeParts = checkinInput.value.split('T');
				if (dateTimeParts.length !== 2) return;
				
				const [checkinYear, checkinMonth, checkinDay] = dateTimeParts[0].split('-').map(Number);
				const [checkinHour, checkinMinute] = dateTimeParts[1].split(':').map(Number);
				
				// Create date in local timezone (not UTC)
				const checkinDate = new Date(checkinYear, checkinMonth - 1, checkinDay, checkinHour, checkinMinute, 0, 0);
				if (isNaN(checkinDate.getTime())) return;
				
				// Calculate checkout date based on duration
				let checkoutDate = new Date(checkinDate);
				
				// If it has hours property (e.g., 2 hours, 4 hours)
				if (selectedOption.hours) {
					checkoutDate.setHours(checkoutDate.getHours() + parseInt(selectedOption.hours));
				}
				// If it has days property (e.g., 1 day, 2 days)
				else if (selectedOption.days) {
					checkoutDate.setDate(checkoutDate.getDate() + parseInt(selectedOption.days));
				}
				// Default to 1 day if no duration unit specified
				else {
					checkoutDate.setDate(checkoutDate.getDate() + 1);
				}
				
				// Format as datetime-local format (YYYY-MM-DDTHH:MM)
				const year = checkoutDate.getFullYear();
				const month = String(checkoutDate.getMonth() + 1).padStart(2, '0');
				const day = String(checkoutDate.getDate()).padStart(2, '0');
				const hours = String(checkoutDate.getHours()).padStart(2, '0');
				const minutes = String(checkoutDate.getMinutes()).padStart(2, '0');
				
				checkoutInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
			}
			
			if (durationSelect && selectedDurationInput) {
				durationSelect.addEventListener('change', function() {
					sessionStorage.setItem('selectedDuration', durationSelect.value);
					selectedDurationInput.value = durationSelect.value;
					autoFillCheckoutDate();
					
					// Update price when duration changes
					const serviceId = sessionStorage.getItem('selectedServiceId') || document.getElementById('serviceIdInput').value;
					const service = window.resortServices?.find(s => (s._id || s.id) === serviceId);
					if (service && durationSelect.value) {
						const allOptions = [...(service.timeSlots || []), ...(service.durations || [])];
						const selectedOption = allOptions.find(opt => opt.id === durationSelect.value);
						if (selectedOption && selectedOption.price) {
							const newPrice = selectedOption.price;
							document.getElementById('basePriceDisplay').textContent = Number(newPrice).toLocaleString('en-PH', {minimumFractionDigits:2});
							sessionStorage.setItem('selectedServicePrice', newPrice);
							if (document.getElementById('basePriceInput')) document.getElementById('basePriceInput').value = newPrice;
							
							// Recalculate discount if promo code is applied
							if (appliedPromoData && appliedPromoData.discountPercentage) {
								const discountAmount = newPrice * appliedPromoData.discountPercentage;
								const finalTotal = newPrice - discountAmount;
								
								appliedPromoData.discountAmount = discountAmount;
								
								document.getElementById('discountDisplay').textContent = `‚Ç±${discountAmount.toLocaleString('en-PH', {minimumFractionDigits:2})}`;
								document.getElementById('finalTotalDisplay').textContent = finalTotal.toLocaleString('en-PH', {minimumFractionDigits:2});
								document.getElementById('discountValueInput').value = discountAmount;
								document.getElementById('finalTotalInput').value = finalTotal;
								
								sessionStorage.setItem('discountValue', discountAmount);
								sessionStorage.setItem('finalTotal', finalTotal);
							} else {
								// No promo applied, just update final total to match base price
								document.getElementById('finalTotalDisplay').textContent = Number(newPrice).toLocaleString('en-PH', {minimumFractionDigits:2});
								if (document.getElementById('finalTotalInput')) document.getElementById('finalTotalInput').value = newPrice;
								sessionStorage.setItem('finalTotal', newPrice);
							}
						}
					}
				});
				// Set initial value if already selected
				if (durationSelect.value) {
					sessionStorage.setItem('selectedDuration', durationSelect.value);
					selectedDurationInput.value = durationSelect.value;
				}
			}
			
			// Also auto-fill checkout when checkin date changes (but not on initial load during resume)
			if (checkinInput) {
				checkinInput.addEventListener('change', function() {
					// Only auto-fill if NOT resuming from storage (i.e., user manually changed the checkin)
					// or if there's already a checkout date, don't overwrite it
					const checkoutVal = checkoutInput?.value;
					const isResuming = sessionStorage.getItem('isResumingReservation') === 'true';
					
					// Clear the resuming flag after first interaction
					if (isResuming) {
						sessionStorage.removeItem('isResumingReservation');
					}
					
					// Only auto-fill if user manually changed checkin (after initial resume)
					if (!checkoutVal || !isResuming) {
						autoFillCheckoutDate();
					}
				});
			}
		});
		// Cancel Reservation button logic
		document.addEventListener('DOMContentLoaded', function() {
			const cancelBtn = document.getElementById('cancelReservationBtn');
			if (cancelBtn) {
				cancelBtn.addEventListener('click', function() {
					// Also reset any applied promo code UI/state
					clearPromoState();
					// Clear all reservation data using unsaved-changes-modal.js
					clearReservationData();
					// Remove all relevant session/local storage keys
					const keys = [
						'selectedServiceId', 'selectedServiceName', 'selectedServicePrice', 'selectedServiceMaxGuests',
						'selectedServiceType', 'selectedDuration', 'selectedDurationLabel', 'serviceInclusions',
						'guests', 'checkinDate', 'checkoutDate', 'customerName', 'customerContact', 'customerEmail',
						'customerAddress', 'customerNotes', 'promoCode', 'finalTotal', 'discountValue', 'appliedPromoCode',
						'termsAccepted', 'finalTotal', 'finalTotalInput', 'basePriceInput', 'discountValueInput',
						'maxGuestsAllowed', 'selectedDurationInput', 'selectedTimeSlotInput', 'discountCodeInput',
						'discountValueInput'
					];
					keys.forEach(k => {
						sessionStorage.removeItem(k);
						localStorage.removeItem(k);
					});
					// Optionally, clear the form fields
					const form = document.getElementById('reservationForm');
					if (form) form.reset();
					document.getElementById('reservationSummaryModal').style.display = 'none';
					showToast('Reservation canceled and data cleared.', 'info');
				});
			}
		});
	// Fetch services from database on page load to get MongoDB IDs
	document.addEventListener('DOMContentLoaded', function() {
	    // CRITICAL FIX: Recover service data from localStorage if sessionStorage is empty
	    if (typeof recoverServiceDataFromStorage === 'function') {
	        recoverServiceDataFromStorage();
	    }
	    
	    // Fetch services to ensure MongoDB _id fields are available
	    fetchServices().then(() => {
	        console.log('Services loaded with MongoDB IDs:', window.cachedServices);
	        // IMPORTANT: Refresh the availability calendar now that we have MongoDB IDs
	        if (typeof highlightUnavailableDates === 'function') {
	            console.log('Refreshing availability calendar with MongoDB IDs...');
	            highlightUnavailableDates();
	        }
	    }).catch(err => {
	        console.warn('Failed to load services:', err);
	    });
	});
	
	// Auto-save reservation progress when form fields change
	document.addEventListener('DOMContentLoaded', function() {
	    const form = document.getElementById('reservationForm');
	    if (form) {
	        // Save on any form input change with debouncing
	        let saveTimeout;
	        
// Comprehensive change tracking function (no auto-save)
        const saveFormData = function() {
            // This triggers unsaved changes tracking from unsaved-changes-modal.js
            markFormAsModified();
	        };
	        
	        
	        // Listen to both change and input events for unsaved changes tracking
	        form.addEventListener('change', saveFormData);
	        form.addEventListener('input', saveFormData);
	    }
	});

	// View Reservation Summary Modal Functionality
	document.addEventListener('DOMContentLoaded', function() {
	    // Initialize unsaved changes tracking
	    initializeUnsavedChangesTracking('reservationForm');
	    attachNavigationListeners();
	    
	    // MODE DETECTION FOR DUAL-FLOW SUPPORT
	    const mode = detectReservationMode();
	    initializeReservationMode(mode);
	    
	    const goBackBtn = document.getElementById('goBackBtn');
	    const submitReservationBtn = document.getElementById('submitReservationBtn');
	    const summaryModal = document.getElementById('reservationSummaryModal');

	    if (goBackBtn) {
	        goBackBtn.addEventListener('click', function(e) {
	            e.preventDefault();
	            window.history.back();
	        });
	    }

	    // Submit Reservation button handler
	    if (submitReservationBtn) {
	        submitReservationBtn.addEventListener('click', function(e) {
	            e.preventDefault();
	            submitReservationHandler();
	        });
	    }

	    // Close modal when clicking outside the content
	    window.addEventListener('click', function(e) {
	        if (e.target === summaryModal) {
	            summaryModal.style.display = 'none';
	        }
	    });
	});

	// Handler for Submit Reservation button - DUAL-MODE SUPPORT (OPTION A)
	async function submitReservationHandler() {
		const currentMode = document.getElementById('reservationMode').value;
		
		if (currentMode === 'multi-amenity') {
			await submitMultiAmenityReservation();
		} else {
			await submitSingleServiceReservation();
		}
	}

	// Single-Service Reservation Submission
	async function submitSingleServiceReservation() {
		// Validate all form fields
		const serviceId = sessionStorage.getItem('selectedServiceId') || document.getElementById('serviceIdInput')?.value;
		const serviceName = sessionStorage.getItem('selectedServiceName') || document.getElementById('selectedServiceDisplay')?.textContent;
		const checkIn = document.getElementById('checkin')?.value;
		const checkOut = document.getElementById('checkout')?.value;
		const guests = document.getElementById('guests')?.value;

		// Dynamic validation for missing fields
		const missingFields = [];
		if (!serviceId || !serviceName || serviceName === '(No Service Selected)') missingFields.push('Service selection');
		if (!checkIn) missingFields.push('Check-in date');
		if (!checkOut) missingFields.push('Check-out date');
		if (!guests) missingFields.push('Number of guests');

		if (missingFields.length > 0) {
			const list = missingFields.map(f => `<li>${f}</li>`).join('');
			showModal('Incomplete Details', 
				`<p>Please complete the following required field(s) before submitting:</p><ul>${list}</ul>`, 
				'warning');
			return;
		}

		// TODO: This will be updated to handle multipleAmenities when that feature is implemented
		// For now, submit single service reservation
		const finalTotalDisplay = document.getElementById('finalTotalDisplay')?.textContent?.replace(/[^\d.]/g, '') || '';
		const price = parseFloat(finalTotalDisplay) || parseFloat(document.getElementById('finalTotalInput')?.value) || 0;

		if (!price || price <= 0) {
			showModal('Invalid Price', 'Total amount must be greater than 0', 'error');
			return;
		}

		const btn = document.getElementById('submitReservationBtn');
		if (btn) {
			btn.disabled = true;
			btn.textContent = 'Submitting...';
		}

		try {
			// Build reservation data
			const reservationData = {
				serviceId: serviceId,
				serviceType: sessionStorage.getItem('selectedServiceType') || '',
				number_of_guests: guests,
				checkin_date: checkIn,
				checkout_date: checkOut,
				customer_name: document.getElementById('name')?.value || '',
				customer_contact: document.getElementById('contact')?.value || '',
				customer_email: document.getElementById('email')?.value || '',
				customer_address: document.getElementById('address')?.value || '',
				customer_notes: document.getElementById('notes')?.value || '',
				basePrice: parseFloat(document.getElementById('basePriceInput')?.value) || price,
				finalTotal: price,
				selectedDuration: sessionStorage.getItem('selectedDuration') || '',
				discountCode: document.getElementById('discountCodeInput')?.value || '',
				discountValue: parseFloat(document.getElementById('discountValueInput')?.value) || 0
			};

			// Submit to backend
			const response = await fetch('http://localhost:3000/api/reservations/create-reservation', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
				},
				body: JSON.stringify(reservationData)
			});

			const result = await response.json();

			if (!response.ok) {
				throw new Error(result.message || 'Failed to create reservation');
			}

			if (!result.success) {
				throw new Error(result.message || 'Reservation creation failed');
			}

			// Store reservation hash for payment
			sessionStorage.setItem('payment_reservation_hash', result.reservationHash);
			sessionStorage.setItem('selectedReservationId', result.reservationId);

			showToast('‚úÖ Reservation created successfully! Redirecting to payment...', 'success');

			// Redirect to payment page
			setTimeout(() => {
				window.location.href = 'payment.html';
			}, 1500);

		} catch (error) {
			console.error('Reservation submission error:', error);
			showToast('‚ùå ' + error.message, 'error');
		} finally {
			if (btn) {
				btn.disabled = false;
				btn.textContent = 'Submit Reservation & Pay';
			}
		}
	}

	// Multi-Amenity Reservation Submission
	async function submitMultiAmenityReservation() {
	    // Validation
	    const name = document.getElementById('nameMulti')?.value?.trim();
	    const contact = document.getElementById('contactMulti')?.value?.trim();
	    const email = document.getElementById('emailMulti')?.value?.trim();
	    const address = document.getElementById('addressMulti')?.value?.trim();
	    const termsCheck = document.getElementById('termsCheck')?.checked;
	    
	    if (!name || !contact || !email || !address) {
	        showToast('Please fill in all required fields.', 'error');
	        return;
	    }
	    
	    if (!termsCheck) {
	        showToast('Please agree to Terms and Conditions.', 'error');
	        return;
	    }
	    
	    // Get multi-amenity data
	    const multiAmenityReservation = JSON.parse(
	        sessionStorage.getItem('multiAmenityReservation') || 'null'
	    );
	    
	    if (!multiAmenityReservation || !multiAmenityReservation.amenities) {
	        showToast('No amenities selected. Please go back and select items.', 'error');
	        return;
	    }
	    
	    // Prepare submission payload
	    const payload = {
	        customer: {
	            name: name,
	            email: email,
	            contact: contact,
	            address: address,
	            notes: document.getElementById('notesMulti')?.value || ''
	        },
	        amenities: multiAmenityReservation.amenities,
	        appliedPromo: multiAmenityReservation.appliedPromo || null,
	        pricing: {
	            originalTotal: multiAmenityReservation.originalTotal,
	            discountAmount: multiAmenityReservation.appliedPromo?.discountAmount || 0,
	            finalTotal: parseFloat(
	                document.getElementById('finalTotalDisplay').textContent.replace(/,/g, '')
	            )
	        }
	    };
	    
	    // Show loading
	    const submitBtn = document.getElementById('submitReservationBtn');
	    const originalText = submitBtn.textContent;
	    submitBtn.disabled = true;
	    submitBtn.textContent = 'Processing...';
	    
	    try {
	        // Submit to backend
	        const response = await fetch('http://localhost:3000/api/reservations/create-multi-amenity', {
	            method: 'POST',
	            headers: {
	                'Content-Type': 'application/json',
	                'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
	            },
	            body: JSON.stringify(payload)
	        });
	        
	        const data = await response.json();
	        
	        if (response.ok && (data.success || data.reservationHash)) {
	            // Store reservation data
	            sessionStorage.setItem('lastReservation', JSON.stringify(data));
	            sessionStorage.setItem('payment_reservation_hash', data.reservationHash);
	            sessionStorage.setItem('selectedReservationId', data.reservationId);
	            
	            showToast('‚úÖ Multi-amenity reservation created! Redirecting to payment...', 'success');
	            
	            // Redirect to payment
	            const amount = data.finalTotal || payload.pricing.finalTotal;
	            setTimeout(() => {
	                window.location.href = `payment.html?reservation_hash=${data.reservationHash}&amount=${amount}&mode=multi-amenity`;
	            }, 1500);
	        } else {
	            showToast(`Error: ${data.message || 'Failed to create reservation'}`, 'error');
	            submitBtn.disabled = false;
	            submitBtn.textContent = originalText;
	        }
	    } catch (error) {
	        console.error('Multi-amenity submission error:', error);
	        showToast('An error occurred: ' + error.message, 'error');
	        submitBtn.disabled = false;
	        submitBtn.textContent = originalText;
	    }
	}

	// View Reservation Summary Modal Functionality
	// document.addEventListener('DOMContentLoaded', function() {

	// Function to populate the reservation summary modal with current form data
	function populateReservationSummary() {
	    const mode = document.getElementById('reservationMode')?.value || 'single-service';
	    const inclusionsList = document.getElementById('summaryInclusions');
	
	    if (mode === 'multi-amenity') {
	        const multiAmenityReservation = JSON.parse(
	            sessionStorage.getItem('multiAmenityReservation') || 'null'
	        );
	
	        const amenities = multiAmenityReservation?.amenities || [];
	        const originalTotal = multiAmenityReservation?.originalTotal || 0;
	        const discountValue = multiAmenityReservation?.appliedPromo?.discountAmount || 0;
	        const finalTotal = (multiAmenityReservation?.finalTotal || (originalTotal - discountValue)) || 0;

	        const customerName = document.getElementById('nameMulti')?.value || document.getElementById('name')?.value || 'Not Entered';

	        document.getElementById('summaryServiceName').textContent = amenities.length > 1
	            ? `Multiple Amenities (${amenities.length})`
	            : (amenities[0]?.serviceName || 'Not Selected');
	        document.getElementById('summaryServiceType').textContent = 'Multi-Amenity';
	        document.getElementById('summaryCustomerName').textContent = customerName;
	        document.getElementById('summaryGuests').textContent = 'Varies by item';
	        document.getElementById('summaryCheckin').textContent = 'See item list';
	        document.getElementById('summaryCheckout').textContent = 'See item list';
	        document.getElementById('summaryBasePrice').textContent = '‚Ç±' + Number(originalTotal).toFixed(2);
	        document.getElementById('summaryTotalAmount').textContent = '‚Ç±' + Number(finalTotal).toFixed(2);

	        const discountRow = document.getElementById('summaryDiscountRow');
	        if (discountValue > 0) {
	            discountRow.style.display = 'flex';
	            document.getElementById('summaryDiscountValue').textContent = '-‚Ç±' + Number(discountValue).toFixed(2);
	        } else {
	            discountRow.style.display = 'none';
	        }

	        if (inclusionsList) {
	            inclusionsList.innerHTML = '';
	            if (amenities.length === 0) {
	                inclusionsList.innerHTML = '<li>No amenities selected</li>';
	            } else {
	                amenities.forEach(item => {
	                    const li = document.createElement('li');
	                    const checkInText = formatAmenityDateTime(item.checkIn, item.checkInTime);
	                    const checkOutText = formatAmenityDateTime(item.checkOut, item.checkOutTime);
	                    li.textContent = `${item.serviceName || 'Service'} ‚Ä¢ ${item.durationLabel || 'N/A'} ‚Ä¢ ${checkInText} ‚Üí ${checkOutText}`;
	                    inclusionsList.appendChild(li);
	                });
	            }
	        }

	        return;
	    }

	    // Single-service summary
	    const serviceName = sessionStorage.getItem('selectedServiceName') || 'Not Selected';
	    const serviceType = sessionStorage.getItem('selectedServiceType') || 'Not Specified';
	    const serviceInclusions = sessionStorage.getItem('serviceInclusions') || '[]';
	    const basePrice = parseFloat(sessionStorage.getItem('selectedServicePrice')) || 0;
	    
	    const customerName = document.getElementById('name')?.value || 'Not Entered';
	    const guests = document.getElementById('guests')?.value || 'Not Specified';
	    const checkinDateTime = document.getElementById('checkin')?.value || 'Not Selected';
	    const checkoutDateTime = document.getElementById('checkout')?.value || 'Not Selected';
	    
	    const finalTotal = parseFloat(document.getElementById('finalTotalInput')?.value) || basePrice;
	    const discountValue = parseFloat(document.getElementById('discountValueInput')?.value) || 0;
	    
	    const checkinFormatted = formatDateTimeForDisplay(checkinDateTime);
	    const checkoutFormatted = formatDateTimeForDisplay(checkoutDateTime);
	    
	    let inclusionsArray = [];
	    try {
	        inclusionsArray = JSON.parse(serviceInclusions);
	    } catch (e) {
	        inclusionsArray = [];
	    }
	    
	    document.getElementById('summaryServiceName').textContent = serviceName;
	    document.getElementById('summaryServiceType').textContent = capitalizeString(serviceType);
	    document.getElementById('summaryCustomerName').textContent = customerName;
	    document.getElementById('summaryGuests').textContent = guests + ' guest' + (guests != 1 ? 's' : '');
	    document.getElementById('summaryCheckin').textContent = checkinFormatted;
	    document.getElementById('summaryCheckout').textContent = checkoutFormatted;
	    document.getElementById('summaryBasePrice').textContent = '‚Ç±' + basePrice.toFixed(2);
	    document.getElementById('summaryTotalAmount').textContent = '‚Ç±' + finalTotal.toFixed(2);
	    
	    const discountRow = document.getElementById('summaryDiscountRow');
	    if (discountValue > 0) {
	        discountRow.style.display = 'flex';
	        document.getElementById('summaryDiscountValue').textContent = '-‚Ç±' + discountValue.toFixed(2);
	    } else {
	        discountRow.style.display = 'none';
	    }
	    
	    if (inclusionsArray.length > 0) {
	        inclusionsList.innerHTML = '';
	        inclusionsArray.forEach(inclusion => {
	            const li = document.createElement('li');
	            li.textContent = inclusion;
	            inclusionsList.appendChild(li);
	        });
	    } else {
	        inclusionsList.innerHTML = '<li>No inclusions listed for this service</li>';
	    }
	}

	// Helper function to format datetime-local input for display
	function formatDateTimeForDisplay(datetimeStr) {
	    if (!datetimeStr) return 'Not Selected';
	    
	    try {
	        const [date, time] = datetimeStr.split('T');
	        const [year, month, day] = date.split('-');
	        const [hour, minute] = time.split(':');
	        
	        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
	        const monthName = months[parseInt(month) - 1];
	        
	        const displayHour = parseInt(hour) > 12 ? parseInt(hour) - 12 : (parseInt(hour) === 0 ? 12 : parseInt(hour));
	        const ampm = parseInt(hour) >= 12 ? 'PM' : 'AM';
	        
	        return `${monthName} ${parseInt(day)}, ${year} at ${displayHour}:${minute} ${ampm}`;
	    } catch (e) {
	        return datetimeStr;
	    }
	}

	// Helper function to format amenity date + time strings
	function formatAmenityDateTime(dateStr, timeStr) {
	    if (!dateStr) return 'Not Selected';
	    let displayDate = dateStr;
	    try {
	        displayDate = new Date(dateStr).toLocaleDateString('en-US', {
	            month: 'short', day: 'numeric', year: 'numeric'
	        });
	    } catch (e) {
	        displayDate = dateStr;
	    }
	
	    if (!timeStr) return displayDate;
	
	    const normalizedTime = String(timeStr).includes(':') ? timeStr : formatTime24To12(parseInt(timeStr));
	    return `${displayDate} ${normalizedTime}`;
	}

	// Helper function to capitalize strings
	function capitalizeString(str) {
	    return str.replace(/\b\w/g, char => char.toUpperCase());
	}

	// Patch: Show terms.png image in Terms and Conditions modal
	function showTermsModal() {
	  showModal(
	    'Terms and Conditions',
	    '<img src="images/terms.png" alt="Terms and Conditions" style="width:100%;margin-bottom:15px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.15);\">' +
	    '<p>A comprehensive copy of our Terms and Conditions is available upon request by contacting our support team.</p>' +
	    '<p><strong>Key Points:</strong></p>' +
	    '<ul><li>Check-in/out times as specified</li><li>Cancellation policies apply</li><li>House rules must be followed</li><li>Full liability terms apply</li></ul>' +
	    '<p>Please contact us for the complete document.</p>',
	    'info'
	  );
	}

	// Patch: Redirect to login page if not logged in
	function prefillUserDataOrRedirectLogin() {
	  const user = (typeof getLoggedInUser === 'function') ? getLoggedInUser() : null;
	  if (user) {
	    // Prefill single-service fields
	    if (user.full_name) document.getElementById('name').value = user.full_name;
	    if (user.phone) document.getElementById('contact').value = user.phone;
	    if (user.email) document.getElementById('email').value = user.email;
	    if (user.address) document.getElementById('address').value = user.address;
	    
	    // Prefill multi-amenity fields
	    if (user.full_name) document.getElementById('nameMulti').value = user.full_name;
	    if (user.phone) document.getElementById('contactMulti').value = user.phone;
	    if (user.email) document.getElementById('emailMulti').value = user.email;
	    if (user.address) document.getElementById('addressMulti').value = user.address;
	  } else {
	    showModal('Login Required', '<p>Redirecting to login...</p>', 'warning');
	    setTimeout(function() {
	      window.location.href = 'login.html';
	    }, 1200);
	  }
	}

	document.addEventListener('DOMContentLoaded', function() {
	  prefillUserDataOrRedirectLogin();
	});

	// --- PROMO CODE APPLICATION LOGIC ---

	async function applyPromoCode() {
	    const promoInput = document.getElementById('promoCodeInput');
	    const promoMessage = document.getElementById('promoCodeMessage');
	    const applyBtn = document.getElementById('applyPromoBtn');
	    
	    if (!promoInput || !promoMessage) return;
	    
	    const promoCode = promoInput.value.trim().toUpperCase();
	    
	    if (!promoCode) {
	        promoMessage.textContent = 'Please enter a promo code.';
	        promoMessage.style.color = '#dc3545';
	        return;
	    }
	    
	    // Get current base price
	    const basePriceText = document.getElementById('basePriceDisplay')?.textContent || '0';
	    const basePrice = parseFloat(basePriceText.replace(/,/g, ''));
	    
	    if (!basePrice || basePrice <= 0) {
	        promoMessage.textContent = 'Please select a service and duration first.';
	        promoMessage.style.color = '#dc3545';
	        return;
	    }
	    
	    // Show loading state
	    if (applyBtn) {
	        applyBtn.disabled = true;
	        applyBtn.textContent = 'Validating...';
	    }
	    
	    try {
	        // Call the backend API to validate the promo code
	        const response = await fetch(`http://localhost:3000/api/promocodes/${promoCode}`);
	        const data = await response.json();
	        
	        if (response.ok && data) {
	            // Check minimum purchase amount
	            if (data.minPurchaseAmount && basePrice < data.minPurchaseAmount) {
	                promoMessage.textContent = `This promo code requires a minimum purchase of ‚Ç±${data.minPurchaseAmount.toLocaleString()}.`;
	                promoMessage.style.color = '#dc3545';
	                if (applyBtn) {
	                    applyBtn.disabled = false;
	                    applyBtn.textContent = 'Apply Code';
	                }
	                return;
	            }
	            
	            // Calculate discount
	            const discountPercentage = data.discountPercentage;
	            const discountAmount = basePrice * discountPercentage;
	            const finalTotal = basePrice - discountAmount;
	            
	            // Store promo data
	            appliedPromoData = {
	                code: promoCode,
	                discountPercentage: discountPercentage,
	                discountAmount: discountAmount
	            };
	            
	            // Update UI
	            document.getElementById('discountDisplay').textContent = `‚Ç±${discountAmount.toLocaleString('en-PH', {minimumFractionDigits:2})}`;
	            document.getElementById('finalTotalDisplay').textContent = finalTotal.toLocaleString('en-PH', {minimumFractionDigits:2});
	            
	            // Update hidden inputs
	            document.getElementById('discountValueInput').value = discountAmount;
	            document.getElementById('discountCodeInput').value = promoCode;
	            document.getElementById('finalTotalInput').value = finalTotal;
	            
	            // Store in sessionStorage
	            sessionStorage.setItem('appliedPromoCode', promoCode);
	            sessionStorage.setItem('discountValue', discountAmount);
	            sessionStorage.setItem('finalTotal', finalTotal);
	            
	            // Show success message
	            promoMessage.textContent = `‚úì Promo code applied! You saved ${(discountPercentage * 100).toFixed(0)}% (‚Ç±${discountAmount.toLocaleString('en-PH', {minimumFractionDigits:2})})`;
	            promoMessage.style.color = '#28a745';
	            
	            // Disable input and change button to "Remove"
	            promoInput.disabled = true;
	            if (applyBtn) {
	                applyBtn.textContent = 'Remove Code';
	                applyBtn.disabled = false;
	                applyBtn.onclick = removePromoCode;
	            }
	            
	            showToast('Promo code applied successfully!', 'success');
	            
	        } else {
	            // Invalid or expired promo code
	            promoMessage.textContent = data.message || 'Invalid or expired promo code.';
	            promoMessage.style.color = '#dc3545';
	            if (applyBtn) {
	                applyBtn.disabled = false;
	                applyBtn.textContent = 'Apply Code';
	            }
	        }
	        
	    } catch (error) {
	        console.error('Error validating promo code:', error);
	        promoMessage.textContent = 'Error validating promo code. Please try again.';
	        promoMessage.style.color = '#dc3545';
	        if (applyBtn) {
	            applyBtn.disabled = false;
	            applyBtn.textContent = 'Apply Code';
	        }
	    }
	}

	function removePromoCode() {
	    const promoInput = document.getElementById('promoCodeInput');
	    const promoMessage = document.getElementById('promoCodeMessage');
	    const applyBtn = document.getElementById('applyPromoBtn');
	    
	    // Reset promo data
	    appliedPromoData = null;
	    
	    // Get base price
	    const basePriceText = document.getElementById('basePriceDisplay')?.textContent || '0';
	    const basePrice = parseFloat(basePriceText.replace(/,/g, ''));
	    
	    // Reset UI
	    document.getElementById('discountDisplay').textContent = '0.00';
	    document.getElementById('finalTotalDisplay').textContent = basePrice.toLocaleString('en-PH', {minimumFractionDigits:2});
	    
	    // Reset hidden inputs
	    document.getElementById('discountValueInput').value = '0';
	    document.getElementById('discountCodeInput').value = '';
	    document.getElementById('finalTotalInput').value = basePrice;
	    
	    // Clear sessionStorage
	    sessionStorage.removeItem('appliedPromoCode');
	    sessionStorage.removeItem('discountValue');
	    sessionStorage.setItem('finalTotal', basePrice);
	    
	    // Reset input
	    promoInput.value = '';
	    promoInput.disabled = false;
	    
	    // Reset button
	    if (applyBtn) {
	        applyBtn.textContent = 'Apply Code';
	        applyBtn.onclick = applyPromoCode;
	    }
	    
	    // Clear message
	    promoMessage.textContent = '';
	    
	    showToast('Promo code removed.', 'info');
	}

	// Attach event handler to Apply Promo button using onclick (already set in HTML)
	document.addEventListener('DOMContentLoaded', function() {
	    // Allow Enter key to apply promo code
	    const promoInput = document.getElementById('promoCodeInput');
	    if (promoInput) {
	        promoInput.addEventListener('keypress', function(e) {
	            if (e.key === 'Enter') {
	                e.preventDefault();
	                applyPromoCode();
	            }
	        });
	    }
	});
	</script>
	<!-- Flatpickr JS -->
	<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
	<script>
		// Initialize Flatpickr for check-in datetime
		const checkinInput = document.getElementById("checkin");
		if (checkinInput) {
			flatpickr(checkinInput, {
				minDate: new Date(),
				dateFormat: "Y-m-d H:i",
				altFormat: "F j, Y H:i",
				altInput: true,
				enableTime: true,
				time_24hr: true,
				minuteIncrement: 30,
				disableMobile: false
			});
		}

		// Initialize Flatpickr for check-out datetime (read-only, but still styled)
		const checkoutInput = document.getElementById("checkout");
		if (checkoutInput) {
			flatpickr(checkoutInput, {
				dateFormat: "Y-m-d H:i",
				altFormat: "F j, Y H:i",
				altInput: true,
				enableTime: true,
				time_24hr: true,
				minuteIncrement: 30,
				disableMobile: false
			});
		}
	</script>
</body>
</html>
