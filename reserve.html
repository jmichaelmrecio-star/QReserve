<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title></title>
	<link rel="stylesheet" href="style.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>

	<header>
        <nav>
            <a href="index.html" class="nav-logo" aria-label="Tito Renz Resort">
                <img src="images/logo.png" alt="Tito Renz Resort Logo">
            </a>
            <ul>
                </ul>
        </nav>
    </header>
	<main class="has-fixed-header-offset reserve-parallax">
		<!-- Page Hero Section -->
		<section class="page-hero-section" style="margin-bottom: 3rem;">
			<div class="hero-content">
				<h1>Complete Your Reservation</h1>
				<p>Secure your perfect getaway</p>
			</div>
		</section>

		<div class="reserve-parallax-inner">
				<form id="reservationForm">

	        	<input type="hidden" id="serviceIdInput" name="serviceId" value="">
				<input type="hidden" id="serviceTypeInput" name="serviceType" value="">
	        	<fieldset>
			    <legend>1. Selected Service</legend>
			    <p>You have selected: <span id="selectedServiceDisplay" style="font-weight: bold; color: #dc3545;">(No Service Selected)</span></p>
		    </fieldset>

				<!-- NEW: Availability Calendar -->
				<fieldset id="availabilityCalendarSection" style="display: none;">
					<legend>üìÖ Service Availability Calendar</legend>
					<p style="font-size: 0.9rem; color: #666; margin-bottom: 15px;">
						Below are the dates that are unavailable for this service. Please avoid these dates when making your reservation.
					</p>
					<div id="availabilityInfo" style="padding: 15px; background-color: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
						<div style="display: flex; gap: 20px; margin-bottom: 10px; flex-wrap: wrap;">
							<div>
								<span style="display: inline-block; width: 20px; height: 20px; background-color: #dc3545; border-radius: 4px; vertical-align: middle;"></span>
								<span style="margin-left: 8px; font-size: 0.9rem;">Blocked by Admin</span>
							</div>
							<div>
								<span style="display: inline-block; width: 20px; height: 20px; background-color: #ffc107; border-radius: 4px; vertical-align: middle;"></span>
								<span style="margin-left: 8px; font-size: 0.9rem;">Already Reserved</span>
							</div>
						</div>
						<div id="unavailableDatesList" style="margin-top: 10px; max-height: 200px; overflow-y: auto;">
							<p style="color: #999;">Loading availability...</p>
						</div>
					</div>
				</fieldset>

	            <fieldset>
	                <legend>2. Reservation Details</legend>	                <label for="duration-selector">Duration / Time Slot:</label>
	                <select id="duration-selector" name="duration" required style="margin-bottom: 1rem;">
	                    <option value="">Loading...</option>
	                </select>
	                <p id="duration-display" style="font-size: 0.9rem; color: #666; margin-bottom: 1rem;"></p>

	                <label for="guests">Number of Guests:</label>
	                <input type="number" id="guests" name="number_of_guests" min="1" required>

	                <label for="checkin">Check-in Date & Time:</label>
	                <input type="datetime-local" id="checkin" name="checkin_date" required>

	                <label for="checkout">Check-out Date & Time:</label>
	                <input type="datetime-local" id="checkout" name="checkout_date" required>
	            </fieldset>

	            <div id=guestDetailsForm>
		            <fieldset>
					    <legend>3. Your Contact & Personal Details</legend>

					    <label for="name">Full Name:</label>
					    <input type="text" id="name" name="customer_name" required>

					    <label for="contact">Contact Number:</label>
					    <input type="tel" id="contact" name="customer_contact" required>

					    <label for="email">Email Address:</label>
					    <input type="email" id="email" name="customer_email" required>
					    
					    <label for="address">Residential Address (For Record):</label>
					    <input type="text" id="address" name="customer_address" required>

					    <label for="notes">Special Requests / Notes (Optional):</label>
					    <textarea id="notes" name="customer_notes" rows="3"></textarea>
					</fieldset>
				</div>

	            <!-- Price Summary & Promo Code Area -->
	            <div id="price-summary" class="summary-box">
				    <!--<h3>Reservation Summary</h3>-->
				    
				    <div class="form-group">
				        <label for="promoCodeInput" style="display: flex; gap: 10px;">Have a Promo Code?</label>
				        <div class="promo-input-group">
				            <input type="text" id="promoCodeInput" placeholder="Enter code" class="form-control" style="flex-grow: 1;">
				        </div>
				        <p id="promoCodeMessage" style="margin-top: 5px; font-size: 0.9em;"></p>
				    </div>
				    <hr>

				    <div id="summary-details">
				        </div>
				    
				    <hr>
				    <h2>
				    <div class="summary-total">
						<p>Subtotal (Base Price):</p>
				        <p>‚Ç±<span id="basePriceDisplay">0.00</span></p>
				    </div>

				    <div id="discountRow">
				        <p>Discount:</p>
				        <p><span id="discountDisplay">0.00</span></p>
				    </div>
				    
				    <hr>

				    <div id="finalTotalRow">
				        <p style="font-weight: bold;">Total Amount Due:</p>
				        <p style="font-weight: bold;"><span id="finalTotalDisplay">0.00</span></p>
				    </div>
					</h2>
				</div>
				<br>

				<fieldset>
				    <legend>4. Terms and Conditions</legend>
				    <!--<div style="max-height: 150px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; font-size: 0.9em;">
				        <p style="font-weight: bold;">Tito Renz Resort Reservation Policy Highlights:</p>
				        <ol>
				            <li>**Deposit:** A non-refundable 50% deposit is required to confirm the reservation. The remainder is due upon check-in.</li>
				            <li>**Cancellation:** Cancellations made 7 days prior to check-in will receive a full refund of the remaining balance (deposit is non-refundable).</li>
				            <li>**Check-in/Out:** Standard check-in is 2:00 PM and check-out is 12:00 PM. Late check-out may incur additional fees.</li>
				            <li>**Liability:** The resort is not responsible for any loss, damage, or injury to persons or property during the stay.</li>
				            <li>**House Rules:** Guests must strictly follow all posted resort house rules (e.g., no loud noise after 10 PM, swimming pool guidelines). Failure to comply may result in removal without refund.</li>
				        </ol>
				        <p style="margin-top: 10px; color: #dc3545; font-weight: bold;">*The full, comprehensive Terms and Conditions are available upon request.*</p>
				    </div>-->
			
				    <div style="display: flex; align-items: center; gap: 8px; margin-top: 15px;">
				        <input type="checkbox" id="termsCheck" name="terms_agreed" required style="width: auto;">
				        <label for="termsCheck" style="font-weight: bold; margin: 0;">I have read and agree to the <a href="#" onclick="showTermsModal(); return false;">Terms and Conditions</a>.</label>
				    </div>
				</fieldset>
				<br>
				<input type="hidden" id="serviceIdInput" name="serviceId" value="" />
				<input type="hidden" id="serviceTypeInput" name="serviceType" value="" />
				<input type="hidden" id="basePriceInput" name="basePrice" value="" />
				<input type="hidden" id="finalTotalInput" name="finalTotal" value="" />
				<input type="hidden" id="maxGuestsAllowed" value="0">
				<input type="hidden" id="selectedDurationInput" name="selectedDuration" value="" />
				<input type="hidden" id="selectedTimeSlotInput" name="selectedTimeSlot" value="" />
				<input type="hidden" id="discountCodeInput" name="discountCode" value="" />
				<input type="hidden" id="discountValueInput" name="discountValue" value="0" />
				<div style="display: flex; gap: 1rem; flex-wrap: wrap;">
					<button type="button" class="button-secondary" id="viewSummaryBtn" style="flex: 1;">View Reservation Summary</button>
					<button type="button" class="button-primary" id="addToCartBtn" style="flex: 1;">üõí Add to Cart</button>
					<button type="submit" class="button-primary" style="flex: 1;">Confirm & Submit Reservation</button>
				</div>
				</form>
			</section>
			</div>
	</main>

	<!-- Reservation Summary Modal -->
	<div id="reservationSummaryModal" class="modal" style="display: none;">
		<div class="modal-content summary-modal-content">
			<div class="modal-header">
				<h2>Reservation Summary</h2>
				<button type="button" class="modal-close" onclick="document.getElementById('reservationSummaryModal').style.display = 'none';">&times;</button>
			</div>
			<div class="modal-body">
				<!-- Service Details -->
				<div class="summary-section">
					<h3 class="summary-section-title">Service Details</h3>
					<div class="summary-detail-row">
						<span class="summary-detail-label">Service Name:</span>
						<span class="summary-detail-value" id="summaryServiceName">-</span>
					</div>
					<div class="summary-detail-row">
						<span class="summary-detail-label">Service Type:</span>
						<span class="summary-detail-value" id="summaryServiceType">-</span>
					</div>
				</div>

				<!-- Guest & Date Information -->
				<div class="summary-section">
					<h3 class="summary-section-title">Booking Details</h3>
					<div class="summary-detail-row">
						<span class="summary-detail-label">Number of Guests:</span>
						<span class="summary-detail-value" id="summaryGuests">-</span>
					</div>
					<div class="summary-detail-row">
						<span class="summary-detail-label">Check-in Date & Time:</span>
						<span class="summary-detail-value" id="summaryCheckin">-</span>
					</div>
					<div class="summary-detail-row">
						<span class="summary-detail-label">Check-out Date & Time:</span>
						<span class="summary-detail-value" id="summaryCheckout">-</span>
					</div>
				</div>

				<!-- Customer Information -->
				<div class="summary-section">
					<h3 class="summary-section-title">Customer Information</h3>
					<div class="summary-detail-row">
						<span class="summary-detail-label">Name:</span>
						<span class="summary-detail-value" id="summaryCustomerName">-</span>
					</div>
				</div>

				<!-- Service Inclusions -->
				<div class="summary-section">
					<h3 class="summary-section-title">Service Inclusions</h3>
					<ul class="inclusions-list" id="summaryInclusions">
						<li>Loading...</li>
					</ul>
				</div>

				<!-- Pricing Summary -->
				<div class="summary-section pricing-section">
					<h3 class="summary-section-title">Pricing Summary</h3>
					<div class="summary-detail-row pricing-row">
						<span class="summary-detail-label">Base Price:</span>
						<span class="summary-detail-value" id="summaryBasePrice">‚Ç±0.00</span>
					</div>
					<div class="summary-detail-row pricing-row" id="summaryDiscountRow" style="display: none;">
						<span class="summary-detail-label">Discount:</span>
						<span class="summary-detail-value discount-value" id="summaryDiscountValue">-‚Ç±0.00</span>
					</div>
					<div class="summary-detail-row pricing-row total-row">
						<span class="summary-detail-label">Total Amount Due:</span>
						<span class="summary-detail-value total-amount" id="summaryTotalAmount">‚Ç±0.00</span>
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" onclick="document.getElementById('reservationSummaryModal').style.display = 'none';">Close</button>
				<button type="button" class="btn btn-danger" id="cancelReservationBtn">Cancel Reservation</button>
			</div>
		</div>
	</div>

	<footer>
        <div class="footer-content">
            <div class="footer-section contact-info">
                <h3>Tito Renz Resort</h3>
                <p>Your seamless booking experience starts here.</p>
                <p>üìç Norzagaray, Bulacan, Philippines</p>
                <p>üìû 0977 246 8920 or 0916 640 3411</p>
                <p>üìß titorenznorzagaray@gmail.com</p>
            </div>

            <div class="footer-section quick-links">
                <h3>Quick Links</h3>
                <ul>
                    <!-- Dynamically populated by renderFooterQuickLinks() -->
                </ul>
            </div>

            <div class="footer-section about-contact">
                <h3>About & Contact</h3>
                <ul>
                    <li><a href="about.html">Our Story</a></li>
                    <li><a href="contact.html">Send Us a Message</a></li>
                    <li><a href="help.html">Help / Guides</a></li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2025 QReserve Project - All Rights Reserved.</p>
        </div>
    </footer>
	<script src="notifications.js"></script>
	<script src="ui-core.js"></script>
	<script src="auth-profile.js"></script>
	<script src="cart-system.js"></script>
	<script src="reservation.js"></script>
	<script src="incomplete-reservation-tracker.js"></script>

		<script>
		// --- Ensure hidden fields are set before form submission ---
		document.addEventListener('DOMContentLoaded', function() {
			const form = document.getElementById('reservationForm');
			if (form) {
				form.addEventListener('submit', function(e) {
					// Get values from sessionStorage or visible fields
					const serviceId = sessionStorage.getItem('selectedServiceId') || document.getElementById('serviceIdInput')?.value;
					const serviceType = sessionStorage.getItem('selectedServiceType') || document.getElementById('serviceTypeInput')?.value;
					const basePrice = sessionStorage.getItem('selectedServicePrice') || document.getElementById('basePriceDisplay')?.textContent?.replace(/[^\d.]/g, '');
					const finalTotal = document.getElementById('finalTotalDisplay')?.textContent?.replace(/[^\d.]/g, '') || '';
					const selectedDuration = sessionStorage.getItem('selectedDuration') || document.getElementById('duration-selector')?.value;
					const selectedTimeSlot = sessionStorage.getItem('selectedTimeSlot') || '';
					const discountCode = sessionStorage.getItem('appliedPromoCode') || document.getElementById('promoCodeInput')?.value || '';
					const discountValue = document.getElementById('discountValueInput')?.value || sessionStorage.getItem('discountValue') || '0';

					// Set hidden fields
					if (document.getElementById('serviceIdInput')) document.getElementById('serviceIdInput').value = serviceId || '';
					if (document.getElementById('serviceTypeInput')) document.getElementById('serviceTypeInput').value = serviceType || '';
					if (document.getElementById('basePriceInput')) document.getElementById('basePriceInput').value = basePrice || '';
					if (document.getElementById('finalTotalInput')) document.getElementById('finalTotalInput').value = finalTotal || '';
					if (document.getElementById('selectedDurationInput')) document.getElementById('selectedDurationInput').value = selectedDuration || '';
					if (document.getElementById('selectedTimeSlotInput')) document.getElementById('selectedTimeSlotInput').value = selectedTimeSlot || '';
					if (document.getElementById('discountCodeInput')) document.getElementById('discountCodeInput').value = discountCode || '';
					if (document.getElementById('discountValueInput')) document.getElementById('discountValueInput').value = discountValue || '0';
				});
			}
		});
		// --- Prefill reservation from GET params ---
		function getQueryParams() {
			const params = {};
			window.location.search.replace(/^\?/, '').split('&').forEach(function(pair) {
				if (!pair) return;
				const [k, v] = pair.split('=');
				params[decodeURIComponent(k)] = decodeURIComponent(v || '');
			});
			return params;
		}

		function trySetDurationFromParams(params) {
			const durationSelect = document.getElementById('duration-selector');
			if (!durationSelect) return;
			if (params.duration) {
				const setValue = () => {
					if (durationSelect.options.length > 1) {
						durationSelect.value = params.duration;
						durationSelect.dispatchEvent(new Event('change'));
					} else {
						setTimeout(setValue, 100);
					}
				};
				setValue();
			}
		}

		// Patch: Ensure durations load from serviceId param
		function loadDurationsFromServiceId(serviceId) {
			if (!serviceId || !window.resortServices) {
				document.getElementById('duration-selector').innerHTML = '<option value="">No durations found (service not loaded)</option>';
				return;
			}
			
			const service = window.resortServices.find(s => (s._id || s.id) === serviceId);
			console.log('Services loaded:', window.resortServices);
			const durationSelect = document.getElementById('duration-selector');
			if (!durationSelect) return;
			if (!service) {
				durationSelect.innerHTML = '<option value="">No durations found for this service</option>';
				return;
			}
			const options = [...(service.timeSlots || []), ...(service.durations || [])];
			if (options.length === 0) {
				durationSelect.innerHTML = '<option value="">No durations available for this service</option>';
				return;
			}
			durationSelect.innerHTML = '<option value="">-- Select --</option>';
			options.forEach(opt => {
				const option = document.createElement('option');
				option.value = opt.id;
				option.textContent = `${opt.label} - ‚Ç±${opt.price.toLocaleString()}`;
				durationSelect.appendChild(option);
			});
		}

		document.addEventListener('DOMContentLoaded', function() {
			const params = getQueryParams();
			// Check if we have service data from URL params OR from sessionStorage (resume flow)
			const serviceId = params.serviceId || sessionStorage.getItem('selectedServiceId');
			const serviceName = params.serviceName || sessionStorage.getItem('selectedServiceName');
			const price = params.price || sessionStorage.getItem('selectedServicePrice');
			
			if (serviceId) {
				// Set hidden input fields
				document.getElementById('serviceIdInput').value = serviceId;
				document.getElementById('selectedServiceDisplay').textContent = serviceName || '(No Service Selected)';
				if (price) {
					document.getElementById('basePriceDisplay').textContent = Number(price).toLocaleString('en-PH', {minimumFractionDigits:2});
					document.getElementById('finalTotalDisplay').textContent = Number(price).toLocaleString('en-PH', {minimumFractionDigits:2});
				}
				// Patch: Set sessionStorage values from query params OR preserve existing sessionStorage
				sessionStorage.setItem('selectedServiceId', serviceId);
				if (serviceName) sessionStorage.setItem('selectedServiceName', serviceName);
				if (price) sessionStorage.setItem('selectedServicePrice', price);

				// Wait for services to load before loading durations
				fetchServices().then(() => {
					// Set serviceType in sessionStorage and hidden input
					if (window.resortServices) {
						const svc = window.resortServices.find(s => (s._id || s.id) === serviceId);
						if (svc && svc.type) {
							sessionStorage.setItem('selectedServiceType', svc.type);
							document.getElementById('serviceTypeInput').value = svc.type;
						}
					}
					loadDurationsFromServiceId(serviceId);
					trySetDurationFromParams(params);

					// Patch: If duration is present in query params, set sessionStorage and hidden input
					if (params.duration) {
						sessionStorage.setItem('selectedDuration', params.duration);
						const selectedDurationInput = document.getElementById('selectedDurationInput');
						if (selectedDurationInput) selectedDurationInput.value = params.duration;
					}
					
					// NEW: Restore form fields from sessionStorage (for resume flow)
					const guestsFromStorage = sessionStorage.getItem('guests');
					const checkinFromStorage = sessionStorage.getItem('checkinDate');
					const checkoutFromStorage = sessionStorage.getItem('checkoutDate');
					const durationFromStorage = sessionStorage.getItem('selectedDuration');
					const durationLabelFromStorage = sessionStorage.getItem('selectedDurationLabel');
					
					if (guestsFromStorage && document.getElementById('guests')) {
						document.getElementById('guests').value = guestsFromStorage;
					}
					if (checkinFromStorage && document.getElementById('checkin')) {
						document.getElementById('checkin').value = checkinFromStorage;
					}
					if (checkoutFromStorage && document.getElementById('checkout')) {
						document.getElementById('checkout').value = checkoutFromStorage;
					}
					if (durationFromStorage && document.getElementById('duration-selector')) {
						document.getElementById('duration-selector').value = durationFromStorage;
						if (durationLabelFromStorage) {
							const durationDisplay = document.getElementById('durationDisplay');
							if (durationDisplay) {
								durationDisplay.textContent = durationLabelFromStorage;
							}
						}
					}
					
					// Flag to prevent auto-fill on initial load when data is already restored
					sessionStorage.setItem('isResumingReservation', 'true');
					
					// Restore customer information from sessionStorage
					const customerName = sessionStorage.getItem('customerName');
					const customerContact = sessionStorage.getItem('customerContact');
					const customerEmail = sessionStorage.getItem('customerEmail');
					const customerAddress = sessionStorage.getItem('customerAddress');
					const customerNotes = sessionStorage.getItem('customerNotes');
					
					if (customerName && document.getElementById('name')) {
						document.getElementById('name').value = customerName;
					}
					if (customerContact && document.getElementById('contact')) {
						document.getElementById('contact').value = customerContact;
					}
					if (customerEmail && document.getElementById('email')) {
						document.getElementById('email').value = customerEmail;
					}
					if (customerAddress && document.getElementById('address')) {
						document.getElementById('address').value = customerAddress;
					}
					if (customerNotes && document.getElementById('notes')) {
						document.getElementById('notes').value = customerNotes;
					}
					
					// Restore promo codes and totals from sessionStorage
					const promoCode = sessionStorage.getItem('promoCode') || sessionStorage.getItem('appliedPromoCode');
					const discountValue = sessionStorage.getItem('discountValue');
					const finalTotal = sessionStorage.getItem('finalTotal');
					
					if (promoCode && document.getElementById('promo-code-input')) {
						document.getElementById('promo-code-input').value = promoCode;
					}
					if (discountValue && document.getElementById('discountValueInput')) {
						document.getElementById('discountValueInput').value = discountValue;
						const discountDisplay = document.getElementById('discountDisplay');
						if (discountDisplay) {
							discountDisplay.textContent = '‚Ç±' + Number(discountValue).toLocaleString('en-PH', {minimumFractionDigits: 2});
						}
					}
					if (finalTotal && document.getElementById('finalTotalInput')) {
						document.getElementById('finalTotalInput').value = finalTotal;
						document.getElementById('finalTotalDisplay').textContent = '‚Ç±' + Number(finalTotal).toLocaleString('en-PH', {minimumFractionDigits: 2});
					}
				});
			}

			// Patch: Sync selected duration to sessionStorage and hidden input
			const durationSelect = document.getElementById('duration-selector');
			const selectedDurationInput = document.getElementById('selectedDurationInput');
			const checkinInput = document.getElementById('checkin');
			const checkoutInput = document.getElementById('checkout');
			
			// Function to auto-fill checkout date based on duration and checkin
			function autoFillCheckoutDate() {
				if (!durationSelect.value || !checkinInput.value) return;
				
				// Find the selected duration option in the service data
				const serviceId = sessionStorage.getItem('selectedServiceId') || document.getElementById('serviceIdInput').value;
				const service = window.resortServices?.find(s => (s._id || s.id) === serviceId);
				
				if (!service) return;
				
				// Get the duration option
				const allOptions = [...(service.timeSlots || []), ...(service.durations || [])];
				const selectedOption = allOptions.find(opt => opt.id === durationSelect.value);
				
				if (!selectedOption) return;
				
				// Parse checkin datetime
				const checkinDate = new Date(checkinInput.value);
				if (isNaN(checkinDate)) return;
				
				// Calculate checkout date based on duration
				let checkoutDate = new Date(checkinDate);
				
				// If it has hours property (e.g., 2 hours, 4 hours)
				if (selectedOption.hours) {
					checkoutDate.setHours(checkoutDate.getHours() + parseInt(selectedOption.hours));
				}
				// If it has days property (e.g., 1 day, 2 days)
				else if (selectedOption.days) {
					checkoutDate.setDate(checkoutDate.getDate() + parseInt(selectedOption.days));
				}
				// Default to 1 day if no duration unit specified
				else {
					checkoutDate.setDate(checkoutDate.getDate() + 1);
				}
				
				// Format as datetime-local format (YYYY-MM-DDTHH:MM)
				const year = checkoutDate.getFullYear();
				const month = String(checkoutDate.getMonth() + 1).padStart(2, '0');
				const day = String(checkoutDate.getDate()).padStart(2, '0');
				const hours = String(checkoutDate.getHours()).padStart(2, '0');
				const minutes = String(checkoutDate.getMinutes()).padStart(2, '0');
				
				checkoutInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
			}
			
			if (durationSelect && selectedDurationInput) {
				durationSelect.addEventListener('change', function() {
					sessionStorage.setItem('selectedDuration', durationSelect.value);
					selectedDurationInput.value = durationSelect.value;
					autoFillCheckoutDate();
					
					// Update price when duration changes
					const serviceId = sessionStorage.getItem('selectedServiceId') || document.getElementById('serviceIdInput').value;
					const service = window.resortServices?.find(s => (s._id || s.id) === serviceId);
					if (service && durationSelect.value) {
						const allOptions = [...(service.timeSlots || []), ...(service.durations || [])];
						const selectedOption = allOptions.find(opt => opt.id === durationSelect.value);
						if (selectedOption && selectedOption.price) {
							const newPrice = selectedOption.price;
							document.getElementById('basePriceDisplay').textContent = Number(newPrice).toLocaleString('en-PH', {minimumFractionDigits:2});
							document.getElementById('finalTotalDisplay').textContent = Number(newPrice).toLocaleString('en-PH', {minimumFractionDigits:2});
							sessionStorage.setItem('selectedServicePrice', newPrice);
							if (document.getElementById('basePriceInput')) document.getElementById('basePriceInput').value = newPrice;
							if (document.getElementById('finalTotalInput')) document.getElementById('finalTotalInput').value = newPrice;
						}
					}
				});
				// Set initial value if already selected
				if (durationSelect.value) {
					sessionStorage.setItem('selectedDuration', durationSelect.value);
					selectedDurationInput.value = durationSelect.value;
				}
			}
			
			// Also auto-fill checkout when checkin date changes (but not on initial load during resume)
			if (checkinInput) {
				checkinInput.addEventListener('change', function() {
					// Only auto-fill if NOT resuming from storage (i.e., user manually changed the checkin)
					// or if there's already a checkout date, don't overwrite it
					const checkoutVal = checkoutInput?.value;
					const isResuming = sessionStorage.getItem('isResumingReservation') === 'true';
					
					// Clear the resuming flag after first interaction
					if (isResuming) {
						sessionStorage.removeItem('isResumingReservation');
					}
					
					// Only auto-fill if user manually changed checkin (after initial resume)
					if (!checkoutVal || !isResuming) {
						autoFillCheckoutDate();
					}
				});
			}
		});
		// Cancel Reservation button logic
		document.addEventListener('DOMContentLoaded', function() {
			const cancelBtn = document.getElementById('cancelReservationBtn');
			if (cancelBtn) {
				cancelBtn.addEventListener('click', function() {
					// Remove reservation progress from localStorage/sessionStorage
					if (typeof saveReservationProgress === 'function') {
						saveReservationProgress('reserve', {}); // Clear tracked progress
					}
					// Remove all relevant session/local storage keys
					const keys = [
						'selectedServiceId', 'selectedServiceName', 'selectedServicePrice', 'selectedServiceMaxGuests',
						'selectedServiceType', 'selectedDuration', 'selectedDurationLabel', 'serviceInclusions',
						'guests', 'checkinDate', 'checkoutDate', 'customerName', 'customerContact', 'customerEmail',
						'customerAddress', 'customerNotes', 'promoCode', 'finalTotal', 'discountValue', 'appliedPromoCode',
						'termsAccepted', 'finalTotal', 'finalTotalInput', 'basePriceInput', 'discountValueInput',
						'maxGuestsAllowed', 'selectedDurationInput', 'selectedTimeSlotInput', 'discountCodeInput',
						'discountValueInput'
					];
					keys.forEach(k => {
						sessionStorage.removeItem(k);
						localStorage.removeItem(k);
					});
					// Optionally, clear the form fields
					const form = document.getElementById('reservationForm');
					if (form) form.reset();
					document.getElementById('reservationSummaryModal').style.display = 'none';
					showToast('Reservation canceled and data cleared.', 'info');
				});
			}
		});
	// Fetch services from database on page load to get MongoDB IDs
	document.addEventListener('DOMContentLoaded', function() {
	    // CRITICAL FIX: Recover service data from localStorage if sessionStorage is empty
	    if (typeof recoverServiceDataFromStorage === 'function') {
	        recoverServiceDataFromStorage();
	    }
	    
	    // Fetch services to ensure MongoDB _id fields are available
	    fetchServices().then(() => {
	        console.log('Services loaded with MongoDB IDs:', window.cachedServices);
	        // IMPORTANT: Refresh the availability calendar now that we have MongoDB IDs
	        if (typeof highlightUnavailableDates === 'function') {
	            console.log('Refreshing availability calendar with MongoDB IDs...');
	            highlightUnavailableDates();
	        }
	    }).catch(err => {
	        console.warn('Failed to load services:', err);
	    });
	});
	
	// Auto-save reservation progress when form fields change
	document.addEventListener('DOMContentLoaded', function() {
	    const form = document.getElementById('reservationForm');
	    if (form) {
	        // Save on any form input change with debouncing
	        let saveTimeout;
	        
	        // Comprehensive save function
	        const saveFormData = function() {
	            clearTimeout(saveTimeout);
	            saveTimeout = setTimeout(function() {
	                const data = {
	                    selectedServiceId: sessionStorage.getItem('selectedServiceId') || document.getElementById('serviceIdInput')?.value,
	                    selectedServiceName: sessionStorage.getItem('selectedServiceName'),
	                    selectedServicePrice: sessionStorage.getItem('selectedServicePrice'),
	                    selectedServiceMaxGuests: sessionStorage.getItem('selectedServiceMaxGuests'),
	                    selectedServiceType: sessionStorage.getItem('selectedServiceType'),
	                    selectedDuration: sessionStorage.getItem('selectedDuration'),
	                    selectedDurationLabel: sessionStorage.getItem('selectedDurationLabel'),
	                    serviceInclusions: sessionStorage.getItem('serviceInclusions'),
	                    guests: document.getElementById('guests')?.value,
	                    checkinDate: document.getElementById('checkin')?.value,
	                    checkoutDate: document.getElementById('checkout')?.value,
	                    customerName: document.getElementById('name')?.value,
	                    customerContact: document.getElementById('contact')?.value,
	                    customerEmail: document.getElementById('email')?.value,
	                    customerAddress: document.getElementById('address')?.value,
	                    customerNotes: document.getElementById('notes')?.value,
	                    promoCode: document.getElementById('promo-code-input')?.value,
	                    finalTotal: document.getElementById('finalTotalInput')?.value || sessionStorage.getItem('finalTotal'),
	                    discountValue: document.getElementById('discountValueInput')?.value || sessionStorage.getItem('discountValue'),
	                    appliedPromoCode: sessionStorage.getItem('appliedPromoCode') || document.getElementById('promoCodeInput')?.value,
	                    termsAccepted: document.getElementById('termsCheckbox')?.checked || false
	                };
	                // Save to RESERVE page (current page, not services-list)
	                saveReservationProgress('reserve', data);
	                console.log('Reserve page auto-saved:', data);
	            }, 1000); // Wait 1 second after last change before saving
	        };
	        
	        // NEW: Save immediately on page load to capture current state
	        saveFormData();
	        
	        // PHASE 5: Also explicitly save with page='reserve' on load to ensure tracker knows we're on reserve page
	        const pageLoadData = {
	            selectedServiceId: sessionStorage.getItem('selectedServiceId') || '',
	            selectedServiceName: sessionStorage.getItem('selectedServiceName') || '',
	            selectedServicePrice: sessionStorage.getItem('selectedServicePrice') || '',
	            selectedServiceMaxGuests: sessionStorage.getItem('selectedServiceMaxGuests') || '',
	            selectedServiceType: sessionStorage.getItem('selectedServiceType') || '',
	            selectedDuration: sessionStorage.getItem('selectedDuration') || '',
	            selectedDurationLabel: sessionStorage.getItem('selectedDurationLabel') || '',
	            serviceInclusions: sessionStorage.getItem('serviceInclusions') || '',
	            pageLoadAuto: true
	        };
	        if (typeof saveReservationProgress === 'function') {
	            saveReservationProgress('reserve', pageLoadData);
	            console.log('Reserve page auto-saved on load:', pageLoadData);
	        }
	        
	        // Listen to both change and input events
	        form.addEventListener('change', saveFormData);
	        form.addEventListener('input', saveFormData);
	    }
	});

	// View Reservation Summary Modal Functionality
	document.addEventListener('DOMContentLoaded', function() {
	    const viewSummaryBtn = document.getElementById('viewSummaryBtn');
	    const addToCartBtn = document.getElementById('addToCartBtn');
	    const summaryModal = document.getElementById('reservationSummaryModal');

	    viewSummaryBtn.addEventListener('click', function(e) {
	        e.preventDefault();
	        populateReservationSummary();
	        summaryModal.style.display = 'flex';
	    });

	    // Add to Cart button handler
	    if (addToCartBtn) {
	        addToCartBtn.addEventListener('click', function(e) {
	            e.preventDefault();
	            handleAddToCart();
	        });
	    }

	    // Close modal when clicking outside the content
	    window.addEventListener('click', function(e) {
	        if (e.target === summaryModal) {
	            summaryModal.style.display = 'none';
	        }
	    });
	});

	// Handler for Add to Cart button
	async function handleAddToCart() {
		// Try to get from sessionStorage, fallback to form fields if missing
		// Always update hidden price fields from visible display before validation
		const basePriceDisplay = document.getElementById('basePriceDisplay')?.textContent?.replace(/[^\d.]/g, '') || '';
		const finalTotalDisplay = document.getElementById('finalTotalDisplay')?.textContent?.replace(/[^\d.]/g, '') || '';
		if (document.getElementById('basePriceInput')) document.getElementById('basePriceInput').value = basePriceDisplay;
		if (document.getElementById('finalTotalInput')) document.getElementById('finalTotalInput').value = finalTotalDisplay;

		let serviceId = sessionStorage.getItem('selectedServiceId') || document.getElementById('serviceIdInput')?.value;
		let serviceName = sessionStorage.getItem('selectedServiceName') || document.getElementById('selectedServiceDisplay')?.textContent;
		let serviceType = sessionStorage.getItem('selectedServiceType') || document.getElementById('serviceTypeInput')?.value;
		let durationId = sessionStorage.getItem('selectedDuration') || document.getElementById('duration-selector')?.value;
		let durationLabel = sessionStorage.getItem('selectedDurationLabel');
		let price = parseFloat(finalTotalDisplay);
		if (!price || price <= 0) {
			// Try to get from hidden input as fallback
			price = parseFloat(document.getElementById('finalTotalInput')?.value) || 0;
		}
		const checkIn = document.getElementById('checkin')?.value;
		const checkOut = document.getElementById('checkout')?.value;
		const guests = document.getElementById('guests')?.value;

		// Dynamic validation for missing fields
		const missingFields = [];
		if (!serviceId || !serviceName || serviceName === '(No Service Selected)') missingFields.push('Service selection');
		if (!checkIn) missingFields.push('Check-in date');
		if (!checkOut) missingFields.push('Check-out date');
		if (!guests) missingFields.push('Number of guests');
		if (!price || price <= 0) missingFields.push('Valid price/total');

		if (missingFields.length > 0) {
			const list = missingFields.map(f => `<li>${f}</li>`).join('');
			showModal('Incomplete Details', 
				`<p>Please complete the following required field(s) before adding to cart:</p><ul>${list}</ul>`, 
				'warning');
			return;
		}

		// 1. Check for duplicate reservation/cart item before adding
		try {
			const token = localStorage.getItem('authToken'); // Or however you store JWT
			const duplicateCheck = await fetch('http://localhost:3000/api/reservations/cart/check-duplicate', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'Authorization': `Bearer ${token}`
				},
				body: JSON.stringify({
					serviceId: serviceId,
					checkin_date: checkIn,
					checkout_date: checkOut
				})
			}).then(res => res.json());

			if (duplicateCheck.success && duplicateCheck.duplicate) {
				showModal('Duplicate Reservation', duplicateCheck.message || 'You already have a reservation or cart item for this service and date range.', 'error');
				return;
			}
		} catch (err) {
			showModal('Error', 'Could not check for duplicate reservation. Please try again.', 'error');
			return;
		}

		// Add to cart
		const cartItem = addToCart({
			serviceId: serviceId,
			serviceName: serviceName,
			serviceType: serviceType,
			durationId: durationId,
			durationLabel: durationLabel,
			checkIn: checkIn,
			checkOut: checkOut,
			guests: guests,
			price: price
		});

		if (cartItem) {
			// Ask user if they want to continue shopping or go to cart
			showConfirm(
				'Added to Cart!',
				`<p><strong>${serviceName}</strong> has been added to your cart.</p><p>What would you like to do next?</p>`,
				() => {
					window.location.href = 'cart.html';
				},
				() => {
					// Continue shopping - go back to services list
					window.location.href = 'services-list.html';
				},
				{
					confirmText: 'View Cart',
					cancelText: 'Continue Shopping',
					type: 'success'
				}
			);
		}
	}

	// View Reservation Summary Modal Functionality
	// document.addEventListener('DOMContentLoaded', function() {

	// Function to populate the reservation summary modal with current form data
	function populateReservationSummary() {
	    // Get service information
	    const serviceName = sessionStorage.getItem('selectedServiceName') || 'Not Selected';
	    const serviceType = sessionStorage.getItem('selectedServiceType') || 'Not Specified';
	    const serviceInclusions = sessionStorage.getItem('serviceInclusions') || '[]';
	    const basePrice = parseFloat(sessionStorage.getItem('selectedServicePrice')) || 0;
	    
	    // Get form values
	    const customerName = document.getElementById('name')?.value || 'Not Entered';
	    const guests = document.getElementById('guests')?.value || 'Not Specified';
	    const checkinDateTime = document.getElementById('checkin')?.value || 'Not Selected';
	    const checkoutDateTime = document.getElementById('checkout')?.value || 'Not Selected';
	    
	    // Get pricing information
	    const finalTotal = parseFloat(document.getElementById('finalTotalInput')?.value) || basePrice;
	    const discountValue = parseFloat(document.getElementById('discountValueInput')?.value) || 0;
	    
	    // Format dates and times
	    const checkinFormatted = formatDateTimeForDisplay(checkinDateTime);
	    const checkoutFormatted = formatDateTimeForDisplay(checkoutDateTime);
	    
	    // Parse inclusions
	    let inclusionsArray = [];
	    try {
	        inclusionsArray = JSON.parse(serviceInclusions);
	    } catch (e) {
	        inclusionsArray = [];
	    }
	    
	    // Populate modal fields
	    document.getElementById('summaryServiceName').textContent = serviceName;
	    document.getElementById('summaryServiceType').textContent = capitalizeString(serviceType);
	    document.getElementById('summaryCustomerName').textContent = customerName;
	    document.getElementById('summaryGuests').textContent = guests + ' guest' + (guests != 1 ? 's' : '');
	    document.getElementById('summaryCheckin').textContent = checkinFormatted;
	    document.getElementById('summaryCheckout').textContent = checkoutFormatted;
	    document.getElementById('summaryBasePrice').textContent = '‚Ç±' + basePrice.toFixed(2);
	    document.getElementById('summaryTotalAmount').textContent = '‚Ç±' + finalTotal.toFixed(2);
	    
	    // Show/hide discount row if applicable
	    const discountRow = document.getElementById('summaryDiscountRow');
	    if (discountValue > 0) {
	        discountRow.style.display = 'flex';
	        document.getElementById('summaryDiscountValue').textContent = '-‚Ç±' + discountValue.toFixed(2);
	    } else {
	        discountRow.style.display = 'none';
	    }
	    
	    // Populate inclusions
	    const inclusionsList = document.getElementById('summaryInclusions');
	    if (inclusionsArray.length > 0) {
	        inclusionsList.innerHTML = '';
	        inclusionsArray.forEach(inclusion => {
	            const li = document.createElement('li');
	            li.textContent = inclusion;
	            inclusionsList.appendChild(li);
	        });
	    } else {
	        inclusionsList.innerHTML = '<li>No inclusions listed for this service</li>';
	    }
	}

	// Helper function to format datetime-local input for display
	function formatDateTimeForDisplay(datetimeStr) {
	    if (!datetimeStr) return 'Not Selected';
	    
	    try {
	        const [date, time] = datetimeStr.split('T');
	        const [year, month, day] = date.split('-');
	        const [hour, minute] = time.split(':');
	        
	        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
	        const monthName = months[parseInt(month) - 1];
	        
	        const displayHour = parseInt(hour) > 12 ? parseInt(hour) - 12 : (parseInt(hour) === 0 ? 12 : parseInt(hour));
	        const ampm = parseInt(hour) >= 12 ? 'PM' : 'AM';
	        
	        return `${monthName} ${parseInt(day)}, ${year} at ${displayHour}:${minute} ${ampm}`;
	    } catch (e) {
	        return datetimeStr;
	    }
	}

	// Helper function to capitalize strings
	function capitalizeString(str) {
	    return str.replace(/\b\w/g, char => char.toUpperCase());
	}

	// Patch: Show terms.png image in Terms and Conditions modal
	function showTermsModal() {
	  showModal(
	    'Terms and Conditions',
	    '<img src="images/terms.png" alt="Terms and Conditions" style="width:100%;margin-bottom:15px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.15);\">' +
	    '<p>A comprehensive copy of our Terms and Conditions is available upon request by contacting our support team.</p>' +
	    '<p><strong>Key Points:</strong></p>' +
	    '<ul><li>Check-in/out times as specified</li><li>Cancellation policies apply</li><li>House rules must be followed</li><li>Full liability terms apply</li></ul>' +
	    '<p>Please contact us for the complete document.</p>',
	    'info'
	  );
	}

	// Patch: Redirect to login page if not logged in
	function prefillUserDataOrRedirectLogin() {
	  const user = (typeof getLoggedInUser === 'function') ? getLoggedInUser() : null;
	  if (user) {
	    if (user.full_name) document.getElementById('name').value = user.full_name;
	    if (user.phone) document.getElementById('contact').value = user.phone;
	    if (user.email) document.getElementById('email').value = user.email;
	    if (user.address) document.getElementById('address').value = user.address;
	  } else {
	    showModal('Login Required', '<p>Redirecting to login...</p>', 'warning');
	    setTimeout(function() {
	      window.location.href = 'login.html';
	    }, 1200);
	  }
	}

	document.addEventListener('DOMContentLoaded', function() {
	  prefillUserDataOrRedirectLogin();
	});
	</script>
</body>
</html>
