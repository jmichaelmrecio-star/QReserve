<!-- Service Management Section -->
<div
  class="tab-pane fade admin-pane-padded"
  id="service-management"
  role="tabpanel"
  aria-labelledby="service-management-tab"
>
  <h2 class="mb-4">Service Management</h2>

  <!-- 1. Creation Form -->
  <div class="card mb-4 p-4">
    <h4 class="mb-3">Create New Service</h4>
    <form id="createServiceForm">
      <div class="row g-3">
        <div class="col-md-6">
          <label for="serviceIdInput" class="form-label"
            >Service ID (unique, e.g., villa_room_5)</label
          >
          <input
            type="text"
            class="form-control"
            id="serviceIdInput"
            required
          />
        </div>
        <div class="col-md-6">
          <label for="serviceNameInput" class="form-label"
            >Service Name (e.g., Villa #5)</label
          >
          <input
            type="text"
            class="form-control"
            id="serviceNameInput"
            required
          />
        </div>
        <div class="col-md-4">
          <label for="serviceTypeInput" class="form-label">Type</label>
          <select class="form-select" id="serviceTypeInput" required>
            <option value="">-- Select --</option>
            <option value="villa">Villa</option>
            <option value="charm">Charm</option>
            <option value="venue">Venue</option>
            <option value="home">Home</option>
          </select>
        </div>
        <div class="col-md-4">
          <label for="serviceCategoryInput" class="form-label">Category</label>
          <select class="form-select" id="serviceCategoryInput" required>
            <option value="">-- Select --</option>
            <option value="accommodation">Accommodation</option>
            <option value="event_space">Event Space</option>
            <option value="water_facility">Water Facility</option>
          </select>
        </div>
        <div class="col-md-4">
          <label for="serviceMaxGuestsInput" class="form-label"
            >Max Guests</label
          >
          <input
            type="number"
            class="form-control"
            id="serviceMaxGuestsInput"
            min="1"
            required
          />
        </div>
        <div class="col-12">
          <label for="serviceDescriptionInput" class="form-label"
            >Description</label
          >
          <textarea
            class="form-control"
            id="serviceDescriptionInput"
            rows="2"
            required
          ></textarea>
        </div>
        <div class="col-md-6">
          <label for="serviceImageInput" class="form-label">Main Image</label>
          <input
            type="file"
            class="form-control"
            id="serviceImageInput"
            accept="image/*"
            required
          />
          <small class="form-text text-muted"
            >Selected: <span id="serviceImageName">None</span></small
          >
        </div>
        <div class="col-md-6">
          <label for="serviceGalleryInput" class="form-label"
            >Gallery Images</label
          >
          <input
            type="file"
            class="form-control"
            id="serviceGalleryInput"
            accept="image/*"
            multiple
          />
          <small class="form-text text-muted"
            >Selected: <span id="serviceGalleryCount">0</span> image(s)</small
          >
        </div>
        <div class="col-12">
          <label for="serviceInclusionsInput" class="form-label"
            >Inclusions (comma-separated)</label
          >
          <textarea
            class="form-control"
            id="serviceInclusionsInput"
            rows="2"
            placeholder="Item 1, Item 2, Item 3"
          ></textarea>
        </div>
        <div class="col-12">
          <label for="serviceNotesInput" class="form-label"
            >Notes (optional)</label
          >
          <textarea
            class="form-control"
            id="serviceNotesInput"
            rows="2"
          ></textarea>
        </div>
      </div>
      <h5 class="mt-4 mb-3">Durations / Time Slots</h5>
      <div id="durationsContainer" class="border p-3 mb-3 rounded">
        <!-- Repeating duration rows will be inserted here -->
      </div>
      <button
        type="button"
        id="addDurationBtn"
        class="btn btn-outline-secondary mb-3"
      >
        + Add Duration
      </button>
      <div class="d-grid gap-2">
        <button type="submit" class="btn btn-primary">Create Service</button>
      </div>
      <div id="createServiceMessage" class="mt-2"></div>
    </form>
  </div>

  <!-- 2. Display Table -->
  <h4 class="mb-3">Existing Services</h4>
  <div class="table-responsive">
    <table
      id="admin-service-list-table"
      class="table table-striped table-bordered"
    >
      <thead class="table-dark">
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Type</th>
          <th>Max Guests</th>
          <th>Active Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="serviceTableBody">
        <!-- Data will be inserted here by JavaScript -->
      </tbody>
    </table>
  </div>
</div>

<!-- EDIT SERVICE MODAL -->
<div
  id="editServiceModal"
  class="modal fade"
  tabindex="-1"
  aria-labelledby="editServiceModalLabel"
  aria-hidden="true"
  style="display: none"
>
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editServiceModalLabel">Edit Service</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
          onclick="closeEditServiceModal()"
        ></button>
      </div>
      <div class="modal-body">
        <form id="editServiceForm">
          <input type="hidden" id="editServiceId" />
          <div class="row g-3">
            <div class="col-md-6">
              <label for="editServiceName" class="form-label"
                >Service Name</label
              >
              <input
                type="text"
                class="form-control"
                id="editServiceName"
                required
              />
            </div>
            <div class="col-md-6">
              <label for="editServiceType" class="form-label">Type</label>
              <select class="form-select" id="editServiceType" required>
                <option value="">-- Select --</option>
                <option value="villa">Villa</option>
                <option value="charm">Charm</option>
                <option value="venue">Venue</option>
                <option value="home">Home</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="editServiceCategory" class="form-label"
                >Category</label
              >
              <select class="form-select" id="editServiceCategory" required>
                <option value="">-- Select --</option>
                <option value="accommodation">Accommodation</option>
                <option value="event_space">Event Space</option>
                <option value="water_facility">Water Facility</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="editServiceMaxGuests" class="form-label"
                >Max Guests</label
              >
              <input
                type="number"
                class="form-control"
                id="editServiceMaxGuests"
                min="1"
                required
              />
            </div>
            <div class="col-12">
              <label for="editServiceDescription" class="form-label"
                >Description</label
              >
              <textarea
                class="form-control"
                id="editServiceDescription"
                rows="2"
                required
              ></textarea>
            </div>
            <div class="col-md-6">
              <label for="editServiceMainImage" class="form-label"
                >Update Main Image (optional)</label
              >
              <input
                type="file"
                class="form-control"
                id="editServiceMainImage"
                accept="image/*"
              />
              <small class="form-text text-muted"
                >Leave blank to keep current image</small
              >
            </div>
            <div class="col-md-6">
              <label class="form-label">Current Main Image</label>
              <div
                id="editServiceMainImagePreview"
                style="
                  max-width: 100px;
                  max-height: 100px;
                  border: 1px solid #ddd;
                  padding: 5px;
                  border-radius: 4px;
                "
              ></div>
            </div>
            <div class="col-12">
              <label for="editServiceGalleryImages" class="form-label"
                >Update Gallery Images (optional)</label
              >
              <input
                type="file"
                class="form-control"
                id="editServiceGalleryImages"
                accept="image/*"
                multiple
              />
              <small class="form-text text-muted"
                >Leave blank to keep current gallery</small
              >
            </div>
            <div class="col-12">
              <label class="form-label">Current Gallery Images</label>
              <div
                id="editServiceGalleryPreview"
                style="display: flex; flex-wrap: wrap; gap: 10px"
              ></div>
            </div>
            <div class="col-12">
              <label for="editServiceInclusions" class="form-label"
                >Inclusions (comma-separated)</label
              >
              <textarea
                class="form-control"
                id="editServiceInclusions"
                rows="2"
              ></textarea>
            </div>
            <div class="col-12">
              <label for="editServiceNotes" class="form-label"
                >Notes (optional)</label
              >
              <textarea
                class="form-control"
                id="editServiceNotes"
                rows="2"
              ></textarea>
            </div>
          </div>
          <div class="mt-4">
            <h6 class="mb-3">Durations / Time Slots</h6>
            <div
              id="editDurationsContainer"
              class="border p-3 rounded"
              style="max-height: 300px; overflow-y: auto"
            >
              <!-- Duration rows will be added here -->
            </div>
            <button
              type="button"
              class="btn btn-outline-secondary btn-sm mt-2"
              onclick="addEditDurationRow()"
            >
              + Add Duration
            </button>
          </div>
          <div id="editServiceMessage" class="mt-3"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          data-bs-dismiss="modal"
          onclick="closeEditServiceModal()"
        >
          Cancel
        </button>
        <button
          type="button"
          class="btn btn-primary"
          onclick="handleEditServiceSubmit()"
        >
          Save Changes
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  // Add Duration Row (correct version)
  function addDurationRow() {
    const durationsContainer = document.getElementById("durationsContainer");
    const row = document.createElement("div");
    row.className = "duration-row";
    row.innerHTML = `
        <input type="text" class="duration-id" placeholder="ID (e.g. daytour)" required>
        <input type="text" class="duration-label" placeholder="Label (e.g. Day Tour)" required>
        <input type="number" class="duration-hours" placeholder="Hours" min="1" required>
        <input type="number" class="duration-price" placeholder="Price" min="0" required>
        <button type="button" class="remove-duration-btn">Remove</button>
    `;
    durationsContainer.appendChild(row);
    row
      .querySelector(".remove-duration-btn")
      .addEventListener("click", function () {
        row.remove();
      });
  }

  // Handle Create Service Form Submission
  async function handleCreateServiceForm(e) {
    e.preventDefault();
    const form = e.target;
    const messageDiv = document.getElementById("createServiceMessage");
    messageDiv.textContent = "";

    // Collect form data
    const formData = new FormData();
    formData.append(
      "serviceId",
      document.getElementById("serviceIdInput").value.trim(),
    );
    formData.append(
      "name",
      document.getElementById("serviceNameInput").value.trim(),
    );
    formData.append("type", document.getElementById("serviceTypeInput").value);
    formData.append(
      "category",
      document.getElementById("serviceCategoryInput").value,
    );
    formData.append(
      "maxGuests",
      document.getElementById("serviceMaxGuestsInput").value,
    );
    formData.append(
      "description",
      document.getElementById("serviceDescriptionInput").value.trim(),
    );

    const imageInput = document.getElementById("serviceImageInput");
    if (imageInput.files.length > 0) {
      formData.append("image", imageInput.files[0]);
    }
    const galleryInput = document.getElementById("serviceGalleryInput");
    for (let i = 0; i < galleryInput.files.length; i++) {
      formData.append("gallery", galleryInput.files[i]);
    }

    // Inclusions (comma separated)
    const inclusionsRaw = document
      .getElementById("serviceInclusionsInput")
      .value.trim();
    if (inclusionsRaw) {
      const inclusionsArr = inclusionsRaw
        .split(",")
        .map((x) => x.trim())
        .filter(Boolean);
      formData.append("inclusions", JSON.stringify(inclusionsArr));
    }

    // Notes
    formData.append(
      "notes",
      document.getElementById("serviceNotesInput").value.trim(),
    );

    // Durations
    const durationRows = document.querySelectorAll(
      "#durationsContainer .duration-row",
    );
    const durations = [];
    durationRows.forEach((row) => {
      const id = row.querySelector(".duration-id").value.trim();
      const label = row.querySelector(".duration-label").value.trim();
      const hours = row.querySelector(".duration-hours").value;
      const price = row.querySelector(".duration-price").value;
      if (id && label && hours && price) {
        durations.push({
          id,
          label,
          hours: Number(hours),
          price: Number(price),
        });
      }
    });
    formData.append("durations", JSON.stringify(durations));

    try {
      const response = await fetch("/api/services/create", {
        method: "POST",
        body: formData,
      });
      const result = await response.json();
      if (response.ok) {
        messageDiv.textContent = "Service created successfully!";
        messageDiv.style.color = getComputedStyle(
          document.documentElement,
        ).getPropertyValue("--primary-color");
        form.reset();
        document.getElementById("serviceImageName").textContent = "None";
        document.getElementById("serviceGalleryCount").textContent = "0";
        document.getElementById("durationsContainer").innerHTML = "";
        if (typeof fetchServices === "function") {
          await fetchServices();
          if (typeof renderServiceTable === "function") renderServiceTable();
        }
      } else {
        messageDiv.textContent = result.message || "Failed to create service.";
        messageDiv.style.color = "red";
      }
    } catch (err) {
      messageDiv.textContent = "Error: " + err.message;
      messageDiv.style.color = "red";
    }
  }

  // Initialize service management when component loads
  (function initServiceManagement() {
    const serviceCreateForm = document.getElementById("createServiceForm");
    const addDurationBtn = document.getElementById("addDurationBtn");
    const serviceImageInput = document.getElementById("serviceImageInput");
    const serviceGalleryInput = document.getElementById("serviceGalleryInput");

    if (serviceCreateForm) {
      serviceCreateForm.addEventListener("submit", handleCreateServiceForm);
    }

    if (addDurationBtn) {
      addDurationBtn.addEventListener("click", (e) => {
        e.preventDefault();
        addDurationRow();
      });
    }

    if (serviceImageInput) {
      serviceImageInput.addEventListener("change", function (e) {
        const files = e.target.files;
        const nameDisplay = document.getElementById("serviceImageName");
        if (files.length > 0) {
          nameDisplay.textContent = files[0].name;
        } else {
          nameDisplay.textContent = "None";
        }
      });
    }

    if (serviceGalleryInput) {
      serviceGalleryInput.addEventListener("change", function (e) {
        const files = e.target.files;
        const countDisplay = document.getElementById("serviceGalleryCount");
        countDisplay.textContent = files.length;
      });
    }

    if (typeof renderServiceTable === "function") {
      const serviceTableBody = document.getElementById("serviceTableBody");
      if (serviceTableBody) {
        fetchServices().then(() => {
          renderServiceTable();
          if (typeof renderServicesListDataTable === "function") {
            renderServicesListDataTable();
          }
        });
      }
    }
  })();

  // ===== EDIT SERVICE MODAL FUNCTIONS =====
  function closeEditServiceModal() {
    const modal = document.getElementById("editServiceModal");
    if (modal) {
      modal.style.display = "none";
      modal.classList.remove("show");
      if (window.bootstrap && window.bootstrap.Modal) {
        const bsModal = window.bootstrap.Modal.getInstance(modal);
        if (bsModal) bsModal.hide();
      }
    }
  }

  async function openEditServiceModal(serviceId) {
    try {
      const response = await fetch(
        `http://localhost:3000/api/services/${serviceId}`,
      );
      const service = await response.json();

      if (!service || !service._id) {
        showToast("Service not found", "error");
        return;
      }

      // Populate basic fields
      document.getElementById("editServiceId").value = service._id;
      document.getElementById("editServiceName").value = service.name || "";
      document.getElementById("editServiceType").value = service.type || "";
      document.getElementById("editServiceCategory").value =
        service.category || "";
      document.getElementById("editServiceMaxGuests").value =
        service.max_guests || "";
      document.getElementById("editServiceDescription").value =
        service.description || "";
      document.getElementById("editServiceInclusions").value = Array.isArray(
        service.inclusions,
      )
        ? service.inclusions.join(", ")
        : "";
      document.getElementById("editServiceNotes").value = service.notes || "";
      document.getElementById("editServiceMessage").textContent = "";
      document.getElementById("editServiceMessage").style.color = "";

      // Show current main image
      const mainImgPreview = document.getElementById(
        "editServiceMainImagePreview",
      );
      if (service.image) {
        let imgUrl = service.image;
        if (imgUrl.startsWith("/")) imgUrl = imgUrl.substring(1);
        mainImgPreview.innerHTML = `<img src="http://localhost:3000/${imgUrl}" style="max-width:100%;max-height:100%;object-fit:cover;" />`;
      } else {
        mainImgPreview.innerHTML =
          '<p style="margin:0;font-size:12px;color:#999;">No image</p>';
      }

      // Show current gallery images
      const galleryPreview = document.getElementById(
        "editServiceGalleryPreview",
      );
      if (Array.isArray(service.gallery) && service.gallery.length > 0) {
        galleryPreview.innerHTML = service.gallery
          .map((img) => {
            let imgUrl = img;
            if (imgUrl.startsWith("/")) imgUrl = imgUrl.substring(1);
            return `<div style="width:80px;height:80px;border:1px solid #ddd;border-radius:4px;overflow:hidden;"><img src="http://localhost:3000/${imgUrl}" style="width:100%;height:100%;object-fit:cover;" /></div>`;
          })
          .join("");
      } else {
        galleryPreview.innerHTML =
          '<p style="font-size:12px;color:#999;">No gallery images</p>';
      }

      // Clear file inputs
      document.getElementById("editServiceMainImage").value = "";
      document.getElementById("editServiceGalleryImages").value = "";

      // Load and display durations
      const durationsContainer = document.getElementById(
        "editDurationsContainer",
      );
      durationsContainer.innerHTML = "";
      if (Array.isArray(service.durations) && service.durations.length > 0) {
        service.durations.forEach((duration) => {
          addEditDurationRow(
            duration.id,
            duration.label,
            duration.hours,
            duration.price,
          );
        });
      }

      // Show modal
      const modal = document.getElementById("editServiceModal");
      if (modal) {
        modal.style.display = "block";
        modal.classList.add("show");
        if (window.bootstrap && window.bootstrap.Modal) {
          const bsModal = new window.bootstrap.Modal(modal);
          bsModal.show();
        }
      }
    } catch (err) {
      showToast("Error loading service: " + err.message, "error");
    }
  }

  function addEditDurationRow(id = "", label = "", hours = "", price = "") {
    const container = document.getElementById("editDurationsContainer");
    const row = document.createElement("div");
    row.className = "edit-duration-row";
    row.style.display = "flex";
    row.style.gap = "8px";
    row.style.marginBottom = "8px";
    row.style.alignItems = "center";
    row.innerHTML = `
        <input type="text" class="form-control form-control-sm duration-id" placeholder="ID" value="${id}" style="flex:1;" required>
        <input type="text" class="form-control form-control-sm duration-label" placeholder="Label" value="${label}" style="flex:2;" required>
        <input type="number" class="form-control form-control-sm duration-hours" placeholder="Hours" value="${hours}" style="flex:1;" min="1" required>
        <input type="number" class="form-control form-control-sm duration-price" placeholder="Price" value="${price}" style="flex:1;" min="0" required>
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.parentElement.remove();">Remove</button>
    `;
    container.appendChild(row);
  }

  async function handleEditServiceSubmit() {
    const serviceId = document.getElementById("editServiceId").value;
    const messageDiv = document.getElementById("editServiceMessage");
    messageDiv.textContent = "";
    messageDiv.style.color = "";

    // Collect basic data
    const formData = new FormData();
    formData.append(
      "name",
      document.getElementById("editServiceName").value.trim(),
    );
    formData.append("type", document.getElementById("editServiceType").value);
    formData.append(
      "category",
      document.getElementById("editServiceCategory").value,
    );
    formData.append(
      "maxGuests",
      document.getElementById("editServiceMaxGuests").value,
    );
    formData.append(
      "description",
      document.getElementById("editServiceDescription").value.trim(),
    );
    formData.append(
      "notes",
      document.getElementById("editServiceNotes").value.trim(),
    );

    // Inclusions
    const inclusionsRaw = document
      .getElementById("editServiceInclusions")
      .value.trim();
    if (inclusionsRaw) {
      const inclusionsArr = inclusionsRaw
        .split(",")
        .map((x) => x.trim())
        .filter(Boolean);
      formData.append("inclusions", JSON.stringify(inclusionsArr));
    } else {
      formData.append("inclusions", JSON.stringify([]));
    }

    // Handle file uploads if present
    const mainImageInput = document.getElementById("editServiceMainImage");
    if (mainImageInput.files.length > 0) {
      formData.append("image", mainImageInput.files[0]);
    }

    const galleryInput = document.getElementById("editServiceGalleryImages");
    for (let i = 0; i < galleryInput.files.length; i++) {
      formData.append("gallery", galleryInput.files[i]);
    }

    // Durations
    const durationRows = document.querySelectorAll(
      "#editDurationsContainer .edit-duration-row",
    );
    const durations = [];
    durationRows.forEach((row) => {
      const id = row.querySelector(".duration-id").value.trim();
      const label = row.querySelector(".duration-label").value.trim();
      const hours = row.querySelector(".duration-hours").value;
      const price = row.querySelector(".duration-price").value;
      if (id && label && hours && price) {
        durations.push({
          id,
          label,
          hours: Number(hours),
          price: Number(price),
        });
      }
    });
    formData.append("durations", JSON.stringify(durations));

    try {
      const response = await fetch(
        `http://localhost:3000/api/services/${serviceId}`,
        {
          method: "PUT",
          body: formData,
        },
      );

      const result = await response.json();
      if (response.ok) {
        messageDiv.textContent = "Service updated successfully!";
        messageDiv.style.color = getComputedStyle(
          document.documentElement,
        ).getPropertyValue("--primary-color");
        setTimeout(() => {
          closeEditServiceModal();
          if (typeof fetchAllServicesAdmin === "function") {
            fetchAllServicesAdmin().then(() => {
              if (typeof renderServiceTable === "function")
                renderServiceTable();
            });
          }
        }, 1000);
      } else {
        messageDiv.textContent = result.message || "Failed to update service.";
        messageDiv.style.color = "red";
      }
    } catch (err) {
      messageDiv.textContent = "Error: " + err.message;
      messageDiv.style.color = "red";
    }
  }

  window.openEditServiceModal = openEditServiceModal;
  window.closeEditServiceModal = closeEditServiceModal;
  window.handleEditServiceSubmit = handleEditServiceSubmit;
  window.addEditDurationRow = addEditDurationRow;
</script>
