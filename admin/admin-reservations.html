<!-- Reservations Management Section -->
<section id="dashboard-area" class="tab-pane">
    <div class="card p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">Reservation Management</h2>
            <button id="report-button" class="btn btn-primary btn-sm" style="min-width:110px;max-width:150px;">Report</button>
        <!-- Report Generation Modal -->
        <div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content" style="border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
                    <div class="modal-header" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border-top-left-radius: 12px; border-top-right-radius: 12px;">
                        <h5 class="modal-title w-100 text-center" id="reportModalLabel" style="font-weight: 600;">Generate Reservation Report</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" style="padding: 2rem;">
                        <form id="reportForm">
                            <div class="mb-4">
                                <label for="reportStartDate" class="form-label" style="font-weight: 500; color: #495057;">Start Date</label>
                                <input type="date" class="form-control" id="reportStartDate" required style="padding: 0.75rem; border-radius: 8px; border: 2px solid #e0e0e0; transition: all 0.3s;">
                            </div>
                            <div class="mb-4">
                                <label for="reportEndDate" class="form-label" style="font-weight: 500; color: #495057;">End Date</label>
                                <input type="date" class="form-control" id="reportEndDate" required style="padding: 0.75rem; border-radius: 8px; border: 2px solid #e0e0e0; transition: all 0.3s;">
                            </div>
                            <div id="reportStatus" class="mb-3"></div>
                            <button type="submit" class="btn btn-success w-100" style="padding: 0.75rem; font-weight: 600; border-radius: 8px; font-size: 1rem;">Generate CSV</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        </div>

        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Customer</th>
                        <th>Email</th>
                        <th>Service-type</th>
                        <th>Check-in Date</th>
                        <th>Check-out Date</th>
                        <th>Total Amount</th>
                        <th>Status</th>
                        <th>GCash Ref #</th>
                        <th>QR Code</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="admin-reservation-list">
                    <tr><td colspan="12" class="text-center">Loading reservations...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

<!-- QR Code Modal -->
<div class="modal fade" id="qrCodeModal" tabindex="-1" aria-labelledby="qrCodeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="qrCodeModalLabel">Reservation QR Code</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div id="admin-qr-code-container" style="display: flex; justify-content: center; align-items: center; min-height: 220px;"></div>
                <div class="mt-3">
                    <span id="qrCodeModalReservationId" class="fw-bold"></span>
                </div>
                <div class="mt-2 text-muted" style="font-size: 0.95rem;">
                    Show this QR code to the staff for check-in.
                </div>
            </div>
        </div>
    </div>
</div>
</section>

<!-- Send Email Modal -->
<div class="modal fade" id="sendEmailModal" tabindex="-1" aria-labelledby="sendEmailModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sendEmailModalLabel">Send Custom Email</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="sendEmailForm">
                    <div class="mb-3">
                        <label for="emailSubject" class="form-label">Subject</label>
                        <input type="text" class="form-control" id="emailSubject" required>
                    </div>
                    <div class="mb-3">
                        <label for="emailBody" class="form-label">Message</label>
                        <textarea class="form-control" id="emailBody" rows="6" required></textarea>
                    </div>
                    <input type="hidden" id="emailReservationId">
                    <div id="sendEmailStatus" class="mb-2"></div>
                    <button type="submit" class="btn btn-primary">Send Email</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="/admin/admin-reservations.js"></script>
<script>
// Initialize reservations when component loads
(function initReservations() {
    if (typeof renderAdminReservations === 'function') {
        renderAdminReservations();
    }
    
    // Report button handler
    const reportButton = document.getElementById('report-button');
    if (reportButton) {
        reportButton.addEventListener('click', function() {
            const reportModal = new bootstrap.Modal(document.getElementById('reportModal'));
            document.getElementById('reportForm').reset();
            document.getElementById('reportStatus').innerHTML = '';
            reportModal.show();
        });
    }
    
    // Report form submit handler
    const reportForm = document.getElementById('reportForm');
    if (reportForm) {
        reportForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            let startDate = document.getElementById('reportStartDate').value.trim();
            let endDate = document.getElementById('reportEndDate').value.trim();
            const statusDiv = document.getElementById('reportStatus');
            statusDiv.innerHTML = '';
            
            if (!startDate || !endDate) {
                statusDiv.innerHTML = '<div class="alert alert-danger">Please select both dates.</div>';
                return;
            }
            if (endDate < startDate) {
                statusDiv.innerHTML = '<div class="alert alert-warning">End date cannot be before start date.</div>';
                return;
            }
            
            statusDiv.innerHTML = '<div class="alert alert-info">Generating report...</div>';
            console.log('Report request - Start Date:', startDate, 'End Date:', endDate);
            
            try {
                const response = await fetch(`http://localhost:3000/api/reservations/admin/reports/generate?startDate=${encodeURIComponent(startDate)}&endDate=${encodeURIComponent(endDate)}`);
                console.log('Report API Response Status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Report data received:', data);
                
                if (data.success && data.report) {
                    const report = data.report;
                    
                    // Build comprehensive CSV content
                    let csvContent = '';
                    
                    // Header section
                    csvContent += '=== TITO RENZ RESORT RESERVATION REPORT ===\n';
                    csvContent += `Report Period,${startDate} to ${endDate}\n`;
                    csvContent += `Generated On,${new Date().toLocaleString()}\n`;
                    csvContent += '\n';
                    
                    // Summary section
                    csvContent += '=== SUMMARY ===\n';
                    csvContent += `Total Reservations,${report.totalReservations}\n`;
                    csvContent += `Total Income,PHP ${report.totalIncome.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n`;
                    csvContent += '\n';
                    
                    // Service breakdown section
                    if (report.serviceBreakdown && Object.keys(report.serviceBreakdown).length > 0) {
                        csvContent += '=== BREAKDOWN BY SERVICE TYPE ===\n';
                        csvContent += 'Service Type,Reservations,Revenue\n';
                        for (const [serviceType, data] of Object.entries(report.serviceBreakdown)) {
                            csvContent += `${serviceType},${data.count},PHP ${data.revenue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n`;
                        }
                        csvContent += '\n';
                    }
                    
                    // Detailed reservations section
                    if (report.detailedReservations && report.detailedReservations.length > 0) {
                        csvContent += '=== DETAILED RESERVATION LIST ===\n';
                        csvContent += 'Reservation ID,Customer Name,Email,Service Type,Check-in,Check-out,Guests,Base Price,Discount,Final Total,Status,GCash Ref,Date Created\n';
                        
                        report.detailedReservations.forEach(res => {
                            csvContent += `${res.reservationId},"${res.customerName}",${res.email},${res.serviceType},${res.checkIn},${res.checkOut},${res.guests},PHP ${res.basePrice.toLocaleString('en-US')},PHP ${res.discount.toLocaleString('en-US')},PHP ${res.finalTotal.toLocaleString('en-US')},${res.status},${res.gcashRef},${res.dateCreated}\n`;
                        });
                    }
                    
                    // Create and download CSV
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `tito_renz_reservation_report_${startDate}_to_${endDate}.csv`;
                    a.style.display = 'none';
                    document.body.appendChild(a);
                    a.click();
                    
                    // Cleanup
                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }, 100);
                    
                    statusDiv.innerHTML = `<div class="alert alert-success"><strong>Success!</strong> Report generated with ${report.totalReservations} reservation(s) and downloaded.</div>`;
                    
                    // Auto-close modal after 2 seconds
                    setTimeout(() => {
                        const reportModal = bootstrap.Modal.getInstance(document.getElementById('reportModal'));
                        if (reportModal) reportModal.hide();
                    }, 2000);
                    
                } else {
                    statusDiv.innerHTML = `<div class="alert alert-danger">${data.message || 'Failed to generate report.'}</div>`;
                }
            } catch (err) {
                console.error('Report generation error:', err);
                statusDiv.innerHTML = `<div class="alert alert-danger"><strong>Error:</strong> ${err.message || 'Failed to generate report. Please try again.'}</div>`;
            }
        });
    }
    
    // Send Email form submit handler
    const sendEmailForm = document.getElementById('sendEmailForm');
    if (sendEmailForm) {
        sendEmailForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const reservationId = document.getElementById('emailReservationId').value;
            const subject = document.getElementById('emailSubject').value.trim();
            const body = document.getElementById('emailBody').value.trim();
            const statusDiv = document.getElementById('sendEmailStatus');
            
            if (!subject || !body) {
                statusDiv.innerHTML = '<div class="alert alert-warning">Please fill in both subject and message.</div>';
                return;
            }
            
            statusDiv.innerHTML = '<div class="alert alert-info">Sending email...</div>';
            
            try {
                const response = await fetch('http://localhost:3000/api/reservations/send-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${typeof getAuthToken === 'function' ? getAuthToken() : ''}`
                    },
                    body: JSON.stringify({ reservationId, subject, body })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    statusDiv.innerHTML = '<div class="alert alert-success">âœ“ Email sent successfully!</div>';
                    
                    // Auto-close modal after 2 seconds
                    setTimeout(() => {
                        const emailModal = bootstrap.Modal.getInstance(document.getElementById('sendEmailModal'));
                        if (emailModal) emailModal.hide();
                        sendEmailForm.reset();
                        statusDiv.innerHTML = '';
                    }, 2000);
                } else {
                    statusDiv.innerHTML = `<div class="alert alert-danger">Failed to send email: ${data.message || 'Unknown error'}</div>`;
                }
            } catch (err) {
                console.error('Email sending error:', err);
                statusDiv.innerHTML = '<div class="alert alert-danger">Error sending email. Please try again.</div>';
            }
        });
    }
})();
</script>