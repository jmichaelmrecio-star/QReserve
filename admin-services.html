<!-- Service Management Section -->
<div class="tab-pane fade" id="service-management" role="tabpanel" aria-labelledby="service-management-tab">
    <h2 class="mb-4">Service Management</h2>

    <!-- 1. Creation Form -->
    <div class="card mb-4 p-4">
        <h4 class="mb-3">Create New Service</h4>
        <form id="createServiceForm">
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="serviceIdInput" class="form-label">Service ID (unique, e.g., villa_room_5)</label>
                    <input type="text" class="form-control" id="serviceIdInput" required>
                </div>
                <div class="col-md-6">
                    <label for="serviceNameInput" class="form-label">Service Name (e.g., Villa #5)</label>
                    <input type="text" class="form-control" id="serviceNameInput" required>
                </div>
                <div class="col-md-4">
                    <label for="serviceTypeInput" class="form-label">Type</label>
                    <select class="form-select" id="serviceTypeInput" required>
                        <option value="">-- Select --</option>
                        <option value="villa">Villa</option>
                        <option value="charm">Charm</option>
                        <option value="venue">Venue</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="serviceCategoryInput" class="form-label">Category</label>
                    <select class="form-select" id="serviceCategoryInput" required>
                        <option value="">-- Select --</option>
                        <option value="accommodation">Accommodation</option>
                        <option value="event_space">Event Space</option>
                        <option value="water_facility">Water Facility</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="serviceMaxGuestsInput" class="form-label">Max Guests</label>
                    <input type="number" class="form-control" id="serviceMaxGuestsInput" min="1" required>
                </div>
                <div class="col-12">
                    <label for="serviceDescriptionInput" class="form-label">Description</label>
                    <textarea class="form-control" id="serviceDescriptionInput" rows="2" required></textarea>
                </div>
                <div class="col-md-6">
                    <label for="serviceImageInput" class="form-label">Main Image</label>
                    <input type="file" class="form-control" id="serviceImageInput" accept="image/*" required>
                    <small class="form-text text-muted">Selected: <span id="serviceImageName">None</span></small>
                </div>
                <div class="col-md-6">
                    <label for="serviceGalleryInput" class="form-label">Gallery Images</label>
                    <input type="file" class="form-control" id="serviceGalleryInput" accept="image/*" multiple>
                    <small class="form-text text-muted">Selected: <span id="serviceGalleryCount">0</span> image(s)</small>
                </div>
                <div class="col-12">
                    <label for="serviceInclusionsInput" class="form-label">Inclusions (comma-separated)</label>
                    <textarea class="form-control" id="serviceInclusionsInput" rows="2" placeholder="Item 1, Item 2, Item 3"></textarea>
                </div>
                <div class="col-12">
                    <label for="serviceNotesInput" class="form-label">Notes (optional)</label>
                    <textarea class="form-control" id="serviceNotesInput" rows="2"></textarea>
                </div>
            </div>
            <h5 class="mt-4 mb-3">Durations / Time Slots</h5>
            <div id="durationsContainer" class="border p-3 mb-3 rounded">
                <!-- Repeating duration rows will be inserted here -->
            </div>
            <button type="button" id="addDurationBtn" class="btn btn-outline-secondary mb-3">+ Add Duration</button>
            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary">Create Service</button>
            </div>
            <div id="createServiceMessage" class="mt-2"></div>
        </form>
    </div>

    <!-- 2. Display Table -->
    <h4 class="mb-3">Existing Services</h4>
    <div class="table-responsive">
            <table id="admin-service-list-table" class="table table-striped table-bordered" style="min-width:1800px;">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Category</th>
                        <th>Max Guests</th>
                        <th>Description</th>
                        <th>Main Image</th>
                        <th>Gallery</th>
                        <th>Inclusions</th>
                        <th>Notes</th>
                        <th>Durations / Time Slots</th>
                        <th>Active Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="serviceTableBody">
                    <!-- Data will be inserted here by JavaScript -->
                </tbody>
            </table>
    </div>
</div>

<script>
// Handle Create Service Form Submission
async function handleCreateServiceForm(e) {
    e.preventDefault();
    const form = e.target;
    const messageDiv = document.getElementById('createServiceMessage');
    messageDiv.textContent = '';

    // Collect form data
    const serviceId = document.getElementById('serviceIdInput').value.trim();
    const name = document.getElementById('serviceNameInput').value.trim();
    const type = document.getElementById('serviceTypeInput').value;
    const category = document.getElementById('serviceCategoryInput').value;
    const maxGuests = document.getElementById('serviceMaxGuestsInput').value;
    const description = document.getElementById('serviceDescriptionInput').value.trim();
    const image = document.getElementById('serviceImageInput').files[0];
    const gallery = document.getElementById('serviceGalleryInput').files;
    const inclusions = document.getElementById('serviceInclusionsInput').value.split(',').map(i => i.trim()).filter(i => i);
    const notes = document.getElementById('serviceNotesInput').value.trim();

    // Durations
    const durationInputs = document.querySelectorAll('#durationsContainer input[name="duration[]"]');
    const durations = Array.from(durationInputs).map(input => input.value.trim()).filter(Boolean);

    // Validate required fields
    if (!serviceId || !name || !type || !category || !maxGuests || !description || !image || durations.length === 0) {
        messageDiv.textContent = 'Please fill in all required fields and add at least one duration.';
        messageDiv.style.color = 'red';
        return;
    }

    // Prepare form data for backend (multipart/form-data)
    const formData = new FormData();
    formData.append('serviceId', serviceId);
    formData.append('name', name);
    formData.append('type', type);
    formData.append('category', category);
    formData.append('maxGuests', maxGuests);
    formData.append('description', description);
    formData.append('image', image);
    for (let i = 0; i < gallery.length; i++) {
        formData.append('gallery', gallery[i]);
    }
    formData.append('inclusions', JSON.stringify(inclusions));
    formData.append('notes', notes);
    formData.append('durations', JSON.stringify(durations));

    try {
        const response = await fetch('/api/services', {
            method: 'POST',
            body: formData
        });
        const result = await response.json();
        if (response.ok) {
            messageDiv.textContent = 'Service created successfully!';
            messageDiv.style.color = 'green';
            form.reset();
            document.getElementById('durationsContainer').innerHTML = '';
        } else {
            messageDiv.textContent = result.message || 'Failed to create service.';
            messageDiv.style.color = 'red';
        }
    } catch (err) {
        messageDiv.textContent = 'Error: ' + err.message;
        messageDiv.style.color = 'red';
    }
}
// Add Duration Row function
function addDurationRow() {
    const container = document.getElementById('durationsContainer');
    if (!container) return;
    // Create a wrapper div for the row
    const row = document.createElement('div');
    row.className = 'input-group mb-2 duration-row';
    row.innerHTML = `
        <input type="text" class="form-control" name="duration[]" placeholder="e.g. 8:00 AM - 12:00 PM" required>
        <button type="button" class="btn btn-danger remove-duration-btn">Remove</button>
    `;
    // Add remove functionality
    row.querySelector('.remove-duration-btn').onclick = function() {
        row.remove();
    };
    container.appendChild(row);
}

// Initialize service management when component loads
(function initServiceManagement() {
    const serviceCreateForm = document.getElementById('createServiceForm');
    const addDurationBtn = document.getElementById('addDurationBtn');
    const serviceImageInput = document.getElementById('serviceImageInput');
    const serviceGalleryInput = document.getElementById('serviceGalleryInput');

    if (serviceCreateForm && typeof handleCreateServiceForm === 'function') {
        serviceCreateForm.addEventListener('submit', handleCreateServiceForm);
    }

    if (addDurationBtn && typeof addDurationRow === 'function') {
        addDurationBtn.addEventListener('click', (e) => {
            e.preventDefault();
            addDurationRow();
        });
    }

    if (serviceImageInput) {
        serviceImageInput.addEventListener('change', function (e) {
            const files = e.target.files;
            const nameDisplay = document.getElementById('serviceImageName');
            if (files.length > 0) {
                nameDisplay.textContent = files[0].name;
            } else {
                nameDisplay.textContent = 'None';
            }
        });
    }

    if (serviceGalleryInput) {
        serviceGalleryInput.addEventListener('change', function (e) {
            const files = e.target.files;
            const countDisplay = document.getElementById('serviceGalleryCount');
            countDisplay.textContent = files.length;
        });
    }

    if (typeof renderServiceTable === 'function') {
        const serviceTableBody = document.getElementById('serviceTableBody');
        if (serviceTableBody) {
            fetchServices().then(() => {
                renderServiceTable();
                if (typeof renderServicesListDataTable === 'function') {
                    renderServicesListDataTable();
                }
            });
        }
    }
})();
</script>
